--*****************************************************INDICADORES AD

CREATE TABLE QA_TFDDCAUSAS_BT
AS
SELECT * FROM QA_TFDDCAUSAS;


DELETE FROM QA_TFDDCAUSAS_BT;
COMMIT;

SELECT*FROM QA_TFDDCAUSAS_BT;

DELETE FROM QA_TFDDREGISTRO_AD;

COMMIT;

INSERT INTO QA_TFDDREGISTRO_AD
select DISTINCT
b.eve_id AS FDD_CODIGO_EVENTO,                                                  --EVENTO TCS
b.eve_fecha_inicial as FDD_FINICIAL,           -- fecha_inicial_evento
b.eve_fecha_final as FDD_FFINAL,               -- fecha_final_evento,     
X.CLIENTE AS FDD_ELEMENTO,                                                      --USUARIO_TC1
NULL AS FDD_TIPOELEMENTO,                                                       
NULL AS FDD_CONSUMODIA,                                                                              
NULL AS FDD_ENS_ELEMENTO,
NULL AS FDD_ENS_EVENTO,
NULL AS FDD_ENEG_ELEMENTO,
NULL AS FDD_ENEG_EVENTO,
NULL AS FDD_CODIGO_GENERADOR,
c.code as FDD_CAUSA,
c.causa015 AS FDD_CAUSA_CREG,
NULL AS FDD_USUARIOAP,
NULL AS FDD_CONTINUIDAD,
NULL AS FDD_ESTADO_REPORTE,
NULL AS FDD_PUBLICADO,
NULL AS FDD_RECONFIG,
to_char(b.eve_fecha_inicial,'DD/MM/YYYY') as FDD_PERIODO_OP,
to_char(SYSDATE,'DD/MM/YYYY') as FDD_FREG_APERTURA,
to_char(SYSDATE,'DD/MM/YYYY') as FDD_FREG_CIERRE,
to_char(SYSDATE,'DD/MM/YYYY') as FDD_FPUB_APERTURA,
to_char(SYSDATE,'DD/MM/YYYY') as FDD_FPUB_APERTURA,
X.PERIODO_TC1 AS FDD_PERIODO_TC1,
NULL AS FDD_TIPOCARGA,
cbt.fdc_exclusion AS FDD_EXCLUSION,
NULL AS FDD_CAUSA_SSPD,
NULL AS FDD_AJUSTADO,
NULL AS FDD_TIPOAJUSTE,
NULL AS FDD_RADICADO,
NULL AS FDD_APROBADO,
NULL AS FDD_IUA
from oms.gev_eve_evento b
left join  oms.gev_lmd_llamada a
on  a.eve_id = b.eve_id
left join  oms.causas C on c.cev_id = b.cev_id
left join BRAE.QA_TFDDCAUSAS_BT CBT ON cbt.fdc_causa_oms = c.code
left join (
            SELECT A.TC1_TC1 ||'-'|| TC1_PERIODO as clienteperiodo, A.TC1_TC1 as CLIENTE, TC1_PERIODO AS PERIODO_TC1
            FROM BRAE.QA_TTC1 A
            WHERE TC1_PERIODO > ='201901'
            ) x on A.CLI_ID||'-'||to_char(b.eve_fecha_inicial,'YYYYMM')=x.clienteperiodo

where b.eve_fecha_inicial >= DATE'2019-01-01'
and b.eve_fecha_inicial < DATE'2022-01-01'
and c.code like ('8%')
and X.CLIENTE is not null
--AND X.CLIENTE = '589172'
--and cev.cev_codigo is null
order by 1;

--COMMIT;


select 
b.eve_id AS FDD_CODIGO_EVENTO,                                                  --EVENTO TCS
X.CLIENTE AS FDD_ELEMENTO,                                                     --USUARIO_TC1
COUNT(b.eve_iD||X.CLIENTE)
from oms.gev_eve_evento b
left join  oms.gev_lmd_llamada a
on  a.eve_id = b.eve_id
left join  oms.causas C on c.cev_id = b.cev_id
left join BRAE.QA_TFDDCAUSAS_BT CBT ON cbt.fdc_causa_oms = c.code
left join (
            SELECT A.TC1_TC1 ||'-'|| TC1_PERIODO as clienteperiodo, A.TC1_TC1 as CLIENTE, TC1_PERIODO AS PERIODO_TC1
            FROM BRAE.QA_TTC1 A
            WHERE TC1_PERIODO > ='201901'
            ) x on A.CLI_ID||'-'||to_char(b.eve_fecha_inicial,'YYYYMM')=x.clienteperiodo

where b.eve_fecha_inicial >= DATE'2019-01-01'
and b.eve_fecha_inicial < DATE'2020-01-01'
and c.code like ('8%')
and X.CLIENTE is not null
and cbt.fdc_exclusion = 'NO EXCLUIDA'
HAVING COUNT(b.eve_iD||X.CLIENTE)>1
--and cev.cev_codigo is null
GROUP BY b.eve_iD,X.CLIENTE
;

SELECT * FROM QA_TFDDREGISTRO_AD
WHERE FDD_CODIGOELEMENTO = '471079';

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO='201903'
AND TC1_TC1 = '471079';


CREATE TABLE QA_TFDDREGISTRO_BT
AS
SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_CODIGOEVENTO='264548';


SELECT * FROM QA_TFDDREGISTRO_BT;


ALTER TABLE QA_TFDDREGISTRO_BT
MODIFY (FDD_FINICIAL DATE
       ,FDD_FFINAL   DATE)
;

COMMIT;

SELECT * FROM QA_TCSU
WHERE CSU_NIU = '130783';

ALTER TABLE QA_TFDDREGISTRO_BT 
RENAME TO QA_TFDDREGISTRO_AD;

CREATE TABLE QA_TCSU_AD
AS
SELECT * FROM QA_TCSU
WHERE CSU_NIU = '121122121';



SELECT FDD_CODIGOELEMENTO AS CSU_NIU
      ,SUM(
           (CASE WHEN (FDD_FFINAL >= ADD_MONTHS(TO_DATE(:FECHAOPERACION,'DD/MM/YYYY'),+1) OR FDD_FFINAL IS NULL )
                 THEN
                  (ADD_MONTHS(TO_DATE(:FECHAOPERACION,'DD/MM/YYYY'),+1) - FDD_FINICIAL)*24
                 ELSE
                    CASE WHEN (FDD_FINICIAL < TO_DATE(:FECHAOPERACION,'DD/MM/YYYY'))
                    THEN
                       (FDD_FFINAL - TO_DATE(:FECHAOPERACION,'DD/MM/YYYY'))*24
                    ELSE
                     (FDD_FFINAL - FDD_FINICIAL)*24
                     END
            END)       
      ) AS CSU_DIUM
     ,COUNT(FDD_CODIGOELEMENTO) AS FIUM
     ,TO_DATE(:FECHAOPERACION,'DD/MM/YYYY') AS CSU_PERIODO_OP
FROM QA_TFDDREGISTRO_AD
WHERE TRUNC(FDD_PERIODO_OP,'MM')= TO_DATE(:FECHAOPERACION,'DD/MM/YYYY')
AND FDD_EXCLUSION =  'NO EXCLUIDA'
GROUP BY FDD_CODIGOELEMENTO;

COMMIT;


SELECT * FROM QA_TFDDREGISTRO_AD
WHERE FDD_CODIGOELEMENTO = '564897'
AND TRUNC(FDD_PERIODO_OP,'MM')= TO_DATE(:FECHAOPERACION,'DD/MM/YYYY');

SELECT * FROM QA_TCSU;

CREATE TABLE QA_TCSX_AD
AS
SELECT CSU_NIU,CSU_DIUM,CSU_FIUM, CSU_PERIODO_OP 
FROM QA_TCSU
WHERE CSU_NIU = '1354653215';

SELECT * FROM QA_TCSX_AD;


--INSERCCION DE VALORES A LA TABLA QA_TCSX_AD
INSERT INTO QA_TCSX_AD
SELECT FDD_CODIGOELEMENTO AS CSU_NIU
      ,SUM(
           (CASE WHEN (FDD_FFINAL >= ADD_MONTHS(TO_DATE(:FECHAOPERACION,'DD/MM/YYYY'),+1) OR FDD_FFINAL IS NULL )
                 THEN
                  (ADD_MONTHS(TO_DATE(:FECHAOPERACION,'DD/MM/YYYY'),+1) - FDD_FINICIAL)*24
                 ELSE
                    CASE WHEN (FDD_FINICIAL < TO_DATE(:FECHAOPERACION,'DD/MM/YYYY'))
                    THEN
                       (FDD_FFINAL - TO_DATE(:FECHAOPERACION,'DD/MM/YYYY'))*24
                    ELSE
                     (FDD_FFINAL - FDD_FINICIAL)*24
                     END
            END)       
      ) AS CSU_DIUM
     ,COUNT(FDD_CODIGOELEMENTO) AS FIUM
     ,TO_DATE(:FECHAOPERACION,'DD/MM/YYYY') AS CSU_PERIODO_OP
FROM QA_TFDDREGISTRO_AD
WHERE TRUNC(FDD_PERIODO_OP,'MM')= TO_DATE(:FECHAOPERACION,'DD/MM/YYYY')
AND FDD_EXCLUSION =  'NO EXCLUIDA'
GROUP BY FDD_CODIGOELEMENTO;

COMMIT;


SELECT * FROM QA_TFDDREGISTRO_AD
WHERE FDD_CODIGOELEMENTO = '564897'
AND TRUNC(FDD_PERIODO_OP,'MM')= TO_DATE(:FECHAOPERACION,'DD/MM/YYYY');


--SE REALIZA COPIA EXACTA DE LA INFORMACION DE LA TABLA QA_CSU A LA TABLA QA_TCSU_AD
INSERT INTO QA_TCSU_AD 
SELECT * FROM QA_TCSU 
WHERE TO_CHAR(CSU_PERIODO_OP,'YYYY') = '2019'
;
--CARE OUT ADD FOUR COLUMN TO THE TABLE QA_TCSU (DIU_AD, DIUM_AD, FIU_AD, FIUM_AD)

ALTER TABLE QA_TCSU
ADD (
    CSU_DIU_AD  NUMBER
   ,CSU_DIUM_AD NUMBER
   ,CSU_FIU_AD  NUMBER
   ,CSU_FIUM_AD NUMBER
   )
;

SELECT * FROM QA_TCSU;

--POBLAR LOS CAMPOS CREADOS

SELECT * FROM QA_TCSX_AD
WHERE CSU_PERIODO_OP=DATE'2019-01-01';

ALTER TABLE QA_TCSU
DROP (
    CSU_DIU_AD  
   ,CSU_DIUM_AD 
   ,CSU_FIU_AD  
   ,CSU_FIUM_AD    
   )
;

SELECT CSU_NIU 
      ,
FROM QA_TCSU 
WHERE CSU_PERIODO_OP = DATE'2019-01-01';

DESC QA_TCSU;

SELECT * FROM  QA_TCSU_AD_TEMP;

SELECT T1.	CSU_NIU
,T1.	CSU_DIUM + NVL(T2.CSU_DIUM,0) + NVL(T3.CSU_DIU_AD,0) AS CSU_DIU
,T1.	CSU_DIUM + NVL(T2.CSU_DIUM,0) AS CSU_DIUM 
,T1.	CSU_FIUM + NVL(T2.CSU_FIUM,0) + NVL(T4.CSU_FIU_AD,0) AS CSU_FIU
,T1.	CSU_FIUM + NVL(T2.CSU_FIUM,0) AS CSU_FIUM
,T1.	CSU_IDMERCADO
,T1.	CSU_FRECUENCIA_C1
,T1.	CSU_DURACION_C1
,T1.	CSU_FRECUENCIA_C2
,T1.	CSU_DURACION_C2
,T1.	CSU_FRECUENCIA_C3
,T1.	CSU_DURACION_C3
,T1.	CSU_FRECUENCIA_C4
,T1.	CSU_DURACION_C4
,T1.	CSU_FRECUENCIA_C5
,T1.	CSU_DURACION_C5
,T1.	CSU_FRECUENCIA_C6
,T1.	CSU_DURACION_C6
,T1.	CSU_FRECUENCIA_C7
,T1.	CSU_DURACION_C7
,T1.	CSU_FRECUENCIA_C8
,T1.	CSU_DURACION_C8
,T1.	CSU_FRECUENCIA_C9
,T1.	CSU_DURACION_C9
,T1.	CSU_FRECUENCIA_C10
,T1.	CSU_DURACION_C10
,T1.	CSU_FRECUENCIA_C11
,T1.	CSU_DURACION_C11
,T1.	CSU_FRECUENCIA_C12
,T1.	CSU_DURACION_C12
,T1.	CSU_FRECUENCIA_C13
,T1.	CSU_DURACION_C13
,T1.	CSU_FRECUENCIA_C14
,T1.	CSU_DURACION_C14
,T1.	CSU_FRECUENCIA_C15
,T1.	CSU_DURACION_C15
,T1.	CSU_PERIODO_OP
FROM QA_TCSU T1
LEFT OUTER JOIN (SELECT * FROM QA_TCSX_AD WHERE CSU_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')) T2 
                ON T2.CSU_NIU = T1.CSU_NIU
LEFT OUTER JOIN (SELECT CSU_NIU, SUM(NVL(CSU_DIUM,0)) AS CSU_DIU_AD 
                 FROM QA_TCSU_AD
                 WHERE CSU_PERIODO_OP IN (
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -1),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -2),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -3),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -4),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -5),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -6),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -7),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -8),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -9),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-10),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-11))
          GROUP BY CSU_NIU) T3 ON T3.CSU_NIU = T1.CSU_NIU
LEFT OUTER JOIN (SELECT CSU_NIU, SUM(NVL(CSU_FIUM,0)) AS CSU_FIU_AD 
                 FROM QA_TCSU_AD
                 WHERE CSU_PERIODO_OP IN (
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -1),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -2),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -3),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -4),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -5),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -6),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -7),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -8),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -9),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-10),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-11))
          GROUP BY CSU_NIU) T4 ON T4.CSU_NIU = T1.CSU_NIU          
WHERE T1.CSU_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
;

DROP TABLE QA_TCSU_AD_TEMP;

--SE INSERTAN EN LA TABLA QA_TCSU_AD

INSERT INTO QA_TCSU_AD
SELECT T1.	CSU_NIU
,T1.	CSU_DIUM + NVL(T2.CSU_DIUM,0) + NVL(T3.CSU_DIU_AD,0) AS CSU_DIU
,T1.	CSU_DIUM + NVL(T2.CSU_DIUM,0) AS CSU_DIUM 
,T1.	CSU_FIUM + NVL(T2.CSU_FIUM,0) + NVL(T4.CSU_FIU_AD,0) AS CSU_FIU
,T1.	CSU_FIUM + NVL(T2.CSU_FIUM,0) AS CSU_FIUM
,T1.	CSU_IDMERCADO
,T1.	CSU_FRECUENCIA_C1
,T1.	CSU_DURACION_C1
,T1.	CSU_FRECUENCIA_C2
,T1.	CSU_DURACION_C2
,T1.	CSU_FRECUENCIA_C3
,T1.	CSU_DURACION_C3
,T1.	CSU_FRECUENCIA_C4
,T1.	CSU_DURACION_C4
,T1.	CSU_FRECUENCIA_C5
,T1.	CSU_DURACION_C5
,T1.	CSU_FRECUENCIA_C6
,T1.	CSU_DURACION_C6
,T1.	CSU_FRECUENCIA_C7
,T1.	CSU_DURACION_C7
,T1.	CSU_FRECUENCIA_C8
,T1.	CSU_DURACION_C8
,T1.	CSU_FRECUENCIA_C9
,T1.	CSU_DURACION_C9
,T1.	CSU_FRECUENCIA_C10
,T1.	CSU_DURACION_C10
,T1.	CSU_FRECUENCIA_C11
,T1.	CSU_DURACION_C11
,T1.	CSU_FRECUENCIA_C12
,T1.	CSU_DURACION_C12
,T1.	CSU_FRECUENCIA_C13
,T1.	CSU_DURACION_C13
,T1.	CSU_FRECUENCIA_C14
,T1.	CSU_DURACION_C14
,T1.	CSU_FRECUENCIA_C15
,T1.	CSU_DURACION_C15
,T1.	CSU_PERIODO_OP
FROM QA_TCSU T1
LEFT OUTER JOIN (SELECT * FROM QA_TCSX_AD WHERE CSU_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')) T2 
                ON T2.CSU_NIU = T1.CSU_NIU
LEFT OUTER JOIN (SELECT CSU_NIU, SUM(NVL(CSU_DIUM,0)) AS CSU_DIU_AD 
                 FROM QA_TCSU_AD
                 WHERE CSU_PERIODO_OP IN (
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -1),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -2),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -3),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -4),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -5),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -6),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -7),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -8),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -9),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-10),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-11))
          GROUP BY CSU_NIU) T3 ON T3.CSU_NIU = T1.CSU_NIU
LEFT OUTER JOIN (SELECT CSU_NIU, SUM(NVL(CSU_FIUM,0)) AS CSU_FIU_AD 
                 FROM QA_TCSU_AD
                 WHERE CSU_PERIODO_OP IN (
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -1),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -2),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -3),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -4),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -5),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -6),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -7),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -8),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -9),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-10),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-11))
          GROUP BY CSU_NIU) T4 ON T4.CSU_NIU = T1.CSU_NIU          
WHERE T1.CSU_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
;

COMMIT;


SELECT * FROM QA_TCSX_AD;

SELECT * FROM QA_TFDDREGISTRO_AD
WHERE FDD_CODIGOELEMENTO=  '589172';




--CORRECCION DE USRAIOS CON VARIAS  LLAMADAS AL MIMSO EVET

DELETE FROM QA_TCSX_AD;
COMMIT;

SELECT * FROM QA_TCSX_aD;


SELECT * FROM QA_TCSU_AD
WHERE CSU_NIU IN ('288811',	'33916',	'484221',	'47036',	'124374',	'246628',	'319750',	'59073',	'305645',	'15535',	'194600',	'474052',	'540135',	'61453',	'28521',	'319413',	'314192',	'192213',	'218311',	'680533',	'119756',	'306815',	'605328',	'641254',	'498276',	'301314',	'502922',	'127512',	'12824',	'63650',	'289643',	'77165',	'299413',	'298516',	'264490',	'123443',	'272568',	'201572',	'10387',	'150309',	'457624',	'321327',	'488191',	'11664',	'572284',	'164436',	'232474',	'425952',	'205431',	'672136',	'80921',	'182869',	'565553',	'199432',	'416415',	'451993',	'452193',	'124055',	'410999',	'75580',	'294404',	'93262',	'43124',	'493',	'548911',	'431454',	'119754',	'215232',	'300355',	'322092',	'183528',	'251663',	'31411',	'315416',	'201492',	'532725',	'70661',	'405925',	'660790',	'305614',	'101584',	'589172',	'109686',	'105298',	'1017312',	'30785',	'164620',	'37135',	'9476',	'631516',	'601042',	'530823',	'90185',	'63358',	'118407',	'55798',	'278239',	'201033',	'154223',	'70395',	'560403',	'153512',	'242314',	'523585',	'46151',	'132876',	'138774',	'84127',	'473549',	'23579',	'525636',	'109583',	'208630',	'201500',	'57182',	'169',	'6810',	'164157',	'559574',	'142277',	'20493',	'323975',	'443557',	'564886',	'107087',	'285139',	'539474',	'681699',	'596119',	'401678',	'423611',	'508134',	'151633',	'18594',	'437945',	'77166',	'213348',	'17433',	'134338',	'494671',	'19615',	'200486',	'2478',	'120473',	'103920',	'49362',	'44067',	'452967',	'293171',	'174579',	'550945',	'643749',	'59973',	'114753',	'1156',	'180532',	'624590',	'97321',	'215',	'163273',	'63712',	'530051',	'403695',	'21852',	'304178',	'248996',	'60556',	'424999',	'113908',	'181337',	'440417',	'46564',	'31331',	'637634',	'98023',	'499479',	'566828',	'148826',	'474085',	'308500',	'28671',	'95601',	'87519',	'213521',	'27725',	'72972',	'211483',	'291828',	'46489',	'186755',	'570124',	'320432',	'582283',	'215834',	'154065',	'247136',	'500654',	'441645',	'579960',	'231894',	'1021000',	'312436',	'92854',	'650618',	'523604',	'19004',	'285321',	'132734',	'550601',	'247380',	'147560',	'115150',	'247449',	'24289',	'120718',	'53680',	'120578',	'128375',	'582006',	'197175',	'646709',	'180573',	'630368',	'200411',	'124106',	'265639',	'108217',	'271688',	'321562',	'205889',	'130334',	'442430',	'619677',	'125019',	'476041',	'665742',	'1915',	'166976',	'611065',	'458547',	'13695',	'293031',	'497994',	'90552',	'215949',	'288525',	'145673',	'498141',	'424631',	'429504',	'326366',	'126868',	'461162',	'287264',	'424536',	'549849',	'101285',	'18275',	'85641',	'606580',	'415372',	'130467',	'50328',	'497490',	'519132',	'403346',	'85768',	'142611',	'537724',	'285139',	'532238',	'440688',	'470468',	'457481',	'158883',	'130973',	'22659',	'89208',	'119754',	'47639',	'166684',	'248791',	'437942',	'28521',	'92390',	'531125',	'437942',	'667468',	'1005147',	'485972',	'114825',	'120272',	'204240',	'33655',	'97070',	'194561',	'32987',	'121973',	'169977',	'487661',	'454103',	'106968',	'142324',	'494138',	'185899',	'130351',	'592541',	'35606',	'142353',	'501953',	'17071',	'285648',	'561845')
AND CSU_PERIODO_OP=DATE'2019-01-01';

SELECT * FROM QA_TCSU_AD
WHERE CSU_NIU IN ('288811',	'33916',	'484221',	'47036',	'124374',	'246628',	'319750',	'59073',	'305645',	'15535',	'194600',	'474052',	'540135',	'61453',	'28521',	'319413',	'314192',	'192213',	'218311',	'680533',	'119756',	'306815',	'605328',	'641254',	'498276',	'301314',	'502922',	'127512',	'12824',	'63650',	'289643',	'77165',	'299413',	'298516',	'264490',	'123443',	'272568',	'201572',	'10387',	'150309',	'457624',	'321327',	'488191',	'11664',	'572284',	'164436',	'232474',	'425952',	'205431',	'672136',	'80921',	'182869',	'565553',	'199432',	'416415',	'451993',	'452193',	'124055',	'410999',	'75580',	'294404',	'93262',	'43124',	'493',	'548911',	'431454',	'119754',	'215232',	'300355',	'322092',	'183528',	'251663',	'31411',	'315416',	'201492',	'532725',	'70661',	'405925',	'660790',	'305614',	'101584',	'589172',	'109686',	'105298',	'1017312',	'30785',	'164620',	'37135',	'9476',	'631516',	'601042',	'530823',	'90185',	'63358',	'118407',	'55798',	'278239',	'201033',	'154223',	'70395',	'560403',	'153512',	'242314',	'523585',	'46151',	'132876',	'138774',	'84127',	'473549',	'23579',	'525636',	'109583',	'208630',	'201500',	'57182',	'169',	'6810',	'164157',	'559574',	'142277',	'20493',	'323975',	'443557',	'564886',	'107087',	'285139',	'539474',	'681699',	'596119',	'401678',	'423611',	'508134',	'151633',	'18594',	'437945',	'77166',	'213348',	'17433',	'134338',	'494671',	'19615',	'200486',	'2478',	'120473',	'103920',	'49362',	'44067',	'452967',	'293171',	'174579',	'550945',	'643749',	'59973',	'114753',	'1156',	'180532',	'624590',	'97321',	'215',	'163273',	'63712',	'530051',	'403695',	'21852',	'304178',	'248996',	'60556',	'424999',	'113908',	'181337',	'440417',	'46564',	'31331',	'637634',	'98023',	'499479',	'566828',	'148826',	'474085',	'308500',	'28671',	'95601',	'87519',	'213521',	'27725',	'72972',	'211483',	'291828',	'46489',	'186755',	'570124',	'320432',	'582283',	'215834',	'154065',	'247136',	'500654',	'441645',	'579960',	'231894',	'1021000',	'312436',	'92854',	'650618',	'523604',	'19004',	'285321',	'132734',	'550601',	'247380',	'147560',	'115150',	'247449',	'24289',	'120718',	'53680',	'120578',	'128375',	'582006',	'197175',	'646709',	'180573',	'630368',	'200411',	'124106',	'265639',	'108217',	'271688',	'321562',	'205889',	'130334',	'442430',	'619677',	'125019',	'476041',	'665742',	'1915',	'166976',	'611065',	'458547',	'13695',	'293031',	'497994',	'90552',	'215949',	'288525',	'145673',	'498141',	'424631',	'429504',	'326366',	'126868',	'461162',	'287264',	'424536',	'549849',	'101285',	'18275',	'85641',	'606580',	'415372',	'130467',	'50328',	'497490',	'519132',	'403346',	'85768',	'142611',	'537724',	'285139',	'532238',	'440688',	'470468',	'457481',	'158883',	'130973',	'22659',	'89208',	'119754',	'47639',	'166684',	'248791',	'437942',	'28521',	'92390',	'531125',	'437942',	'667468',	'1005147',	'485972',	'114825',	'120272',	'204240',	'33655',	'97070',	'194561',	'32987',	'121973',	'169977',	'487661',	'454103',	'106968',	'142324',	'494138',	'185899',	'130351',	'592541',	'35606',	'142353',	'501953',	'17071',	'285648',	'561845')
;

DELETE FROM QA_TCSU_AD
WHERE CSU_NIU IN ('288811',	'33916',	'484221',	'47036',	'124374',	'246628',	'319750',	'59073',	'305645',	'15535',	'194600',	'474052',	'540135',	'61453',	'28521',	'319413',	'314192',	'192213',	'218311',	'680533',	'119756',	'306815',	'605328',	'641254',	'498276',	'301314',	'502922',	'127512',	'12824',	'63650',	'289643',	'77165',	'299413',	'298516',	'264490',	'123443',	'272568',	'201572',	'10387',	'150309',	'457624',	'321327',	'488191',	'11664',	'572284',	'164436',	'232474',	'425952',	'205431',	'672136',	'80921',	'182869',	'565553',	'199432',	'416415',	'451993',	'452193',	'124055',	'410999',	'75580',	'294404',	'93262',	'43124',	'493',	'548911',	'431454',	'119754',	'215232',	'300355',	'322092',	'183528',	'251663',	'31411',	'315416',	'201492',	'532725',	'70661',	'405925',	'660790',	'305614',	'101584',	'589172',	'109686',	'105298',	'1017312',	'30785',	'164620',	'37135',	'9476',	'631516',	'601042',	'530823',	'90185',	'63358',	'118407',	'55798',	'278239',	'201033',	'154223',	'70395',	'560403',	'153512',	'242314',	'523585',	'46151',	'132876',	'138774',	'84127',	'473549',	'23579',	'525636',	'109583',	'208630',	'201500',	'57182',	'169',	'6810',	'164157',	'559574',	'142277',	'20493',	'323975',	'443557',	'564886',	'107087',	'285139',	'539474',	'681699',	'596119',	'401678',	'423611',	'508134',	'151633',	'18594',	'437945',	'77166',	'213348',	'17433',	'134338',	'494671',	'19615',	'200486',	'2478',	'120473',	'103920',	'49362',	'44067',	'452967',	'293171',	'174579',	'550945',	'643749',	'59973',	'114753',	'1156',	'180532',	'624590',	'97321',	'215',	'163273',	'63712',	'530051',	'403695',	'21852',	'304178',	'248996',	'60556',	'424999',	'113908',	'181337',	'440417',	'46564',	'31331',	'637634',	'98023',	'499479',	'566828',	'148826',	'474085',	'308500',	'28671',	'95601',	'87519',	'213521',	'27725',	'72972',	'211483',	'291828',	'46489',	'186755',	'570124',	'320432',	'582283',	'215834',	'154065',	'247136',	'500654',	'441645',	'579960',	'231894',	'1021000',	'312436',	'92854',	'650618',	'523604',	'19004',	'285321',	'132734',	'550601',	'247380',	'147560',	'115150',	'247449',	'24289',	'120718',	'53680',	'120578',	'128375',	'582006',	'197175',	'646709',	'180573',	'630368',	'200411',	'124106',	'265639',	'108217',	'271688',	'321562',	'205889',	'130334',	'442430',	'619677',	'125019',	'476041',	'665742',	'1915',	'166976',	'611065',	'458547',	'13695',	'293031',	'497994',	'90552',	'215949',	'288525',	'145673',	'498141',	'424631',	'429504',	'326366',	'126868',	'461162',	'287264',	'424536',	'549849',	'101285',	'18275',	'85641',	'606580',	'415372',	'130467',	'50328',	'497490',	'519132',	'403346',	'85768',	'142611',	'537724',	'285139',	'532238',	'440688',	'470468',	'457481',	'158883',	'130973',	'22659',	'89208',	'119754',	'47639',	'166684',	'248791',	'437942',	'28521',	'92390',	'531125',	'437942',	'667468',	'1005147',	'485972',	'114825',	'120272',	'204240',	'33655',	'97070',	'194561',	'32987',	'121973',	'169977',	'487661',	'454103',	'106968',	'142324',	'494138',	'185899',	'130351',	'592541',	'35606',	'142353',	'501953',	'17071',	'285648',	'561845')
;
COMMIT;


--INSERT INTO QA_TCSU_AD
SELECT T1.	CSU_NIU
,(CASE WHEN(T1.CSU_DIUM + NVL(T2.CSU_DIUM,0)<TO_NUMBER(TO_CHAR(LAST_DAY(TO_DATE(:PERIODO,'DD/MM/YYYY')),'DD'))*24) 
       THEN (T1.CSU_DIUM + NVL(T2.CSU_DIUM,0))
       ELSE (TO_NUMBER(TO_CHAR(LAST_DAY(TO_DATE(:PERIODO,'DD/MM/YYYY')),'DD'))*24))
       END ) + NVL(T3.CSU_DIU_AD,0) AS CSU_DIU
,(CASE WHEN(T1.CSU_DIUM + NVL(T2.CSU_DIUM,0)<TO_NUMBER(TO_CHAR(LAST_DAY(TO_DATE(:PERIODO,'DD/MM/YYYY')),'DD'))*24) 
       THEN (T1.CSU_DIUM + NVL(T2.CSU_DIUM,0))
       ELSE (TO_NUMBER(TO_CHAR(LAST_DAY(TO_DATE(:PERIODO,'DD/MM/YYYY')),'DD'))*24))
       END )AS CSU_DIUM 
,T1.	CSU_FIUM + NVL(T2.CSU_FIUM,0) + NVL(T4.CSU_FIU_AD,0) AS CSU_FIU
,T1.	CSU_FIUM + NVL(T2.CSU_FIUM,0) AS CSU_FIUM
,T1.	CSU_IDMERCADO
,T1.	CSU_FRECUENCIA_C1
,T1.	CSU_DURACION_C1
,T1.	CSU_FRECUENCIA_C2
,T1.	CSU_DURACION_C2
,T1.	CSU_FRECUENCIA_C3
,T1.	CSU_DURACION_C3
,T1.	CSU_FRECUENCIA_C4
,T1.	CSU_DURACION_C4
,T1.	CSU_FRECUENCIA_C5
,T1.	CSU_DURACION_C5
,T1.	CSU_FRECUENCIA_C6
,T1.	CSU_DURACION_C6
,T1.	CSU_FRECUENCIA_C7
,T1.	CSU_DURACION_C7
,T1.	CSU_FRECUENCIA_C8
,T1.	CSU_DURACION_C8
,T1.	CSU_FRECUENCIA_C9
,T1.	CSU_DURACION_C9
,T1.	CSU_FRECUENCIA_C10
,T1.	CSU_DURACION_C10
,T1.	CSU_FRECUENCIA_C11
,T1.	CSU_DURACION_C11
,T1.	CSU_FRECUENCIA_C12
,T1.	CSU_DURACION_C12
,T1.	CSU_FRECUENCIA_C13
,T1.	CSU_DURACION_C13
,T1.	CSU_FRECUENCIA_C14
,T1.	CSU_DURACION_C14
,T1.	CSU_FRECUENCIA_C15
,T1.	CSU_DURACION_C15
,T1.	CSU_PERIODO_OP
FROM QA_TCSU T1
LEFT OUTER JOIN (SELECT * FROM QA_TCSX_AD WHERE CSU_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')) T2 
                ON T2.CSU_NIU = T1.CSU_NIU
LEFT OUTER JOIN (SELECT CSU_NIU, SUM(NVL(CSU_DIUM,0)) AS CSU_DIU_AD 
                 FROM QA_TCSU_AD
                 WHERE CSU_PERIODO_OP IN (
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -1),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -2),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -3),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -4),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -5),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -6),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -7),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -8),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -9),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-10),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-11))
          GROUP BY CSU_NIU) T3 ON T3.CSU_NIU = T1.CSU_NIU
LEFT OUTER JOIN (SELECT CSU_NIU, SUM(NVL(CSU_FIUM,0)) AS CSU_FIU_AD 
                 FROM QA_TCSU_AD
                 WHERE CSU_PERIODO_OP IN (
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -1),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -2),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -3),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -4),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -5),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -6),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -7),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -8),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -9),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-10),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-11))
          GROUP BY CSU_NIU) T4 ON T4.CSU_NIU = T1.CSU_NIU          
WHERE T1.CSU_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
AND T1.	CSU_NIU IN ('288811',	'33916',	'484221',	'47036',	'124374',	'246628',	'319750',	'59073',	'305645',	'15535',	'194600',	'474052',	'540135',	'61453',	'28521',	'319413',	'314192',	'192213',	'218311',	'680533',	'119756',	'306815',	'605328',	'641254',	'498276',	'301314',	'502922',	'127512',	'12824',	'63650',	'289643',	'77165',	'299413',	'298516',	'264490',	'123443',	'272568',	'201572',	'10387',	'150309',	'457624',	'321327',	'488191',	'11664',	'572284',	'164436',	'232474',	'425952',	'205431',	'672136',	'80921',	'182869',	'565553',	'199432',	'416415',	'451993',	'452193',	'124055',	'410999',	'75580',	'294404',	'93262',	'43124',	'493',	'548911',	'431454',	'119754',	'215232',	'300355',	'322092',	'183528',	'251663',	'31411',	'315416',	'201492',	'532725',	'70661',	'405925',	'660790',	'305614',	'101584',	'589172',	'109686',	'105298',	'1017312',	'30785',	'164620',	'37135',	'9476',	'631516',	'601042',	'530823',	'90185',	'63358',	'118407',	'55798',	'278239',	'201033',	'154223',	'70395',	'560403',	'153512',	'242314',	'523585',	'46151',	'132876',	'138774',	'84127',	'473549',	'23579',	'525636',	'109583',	'208630',	'201500',	'57182',	'169',	'6810',	'164157',	'559574',	'142277',	'20493',	'323975',	'443557',	'564886',	'107087',	'285139',	'539474',	'681699',	'596119',	'401678',	'423611',	'508134',	'151633',	'18594',	'437945',	'77166',	'213348',	'17433',	'134338',	'494671',	'19615',	'200486',	'2478',	'120473',	'103920',	'49362',	'44067',	'452967',	'293171',	'174579',	'550945',	'643749',	'59973',	'114753',	'1156',	'180532',	'624590',	'97321',	'215',	'163273',	'63712',	'530051',	'403695',	'21852',	'304178',	'248996',	'60556',	'424999',	'113908',	'181337',	'440417',	'46564',	'31331',	'637634',	'98023',	'499479',	'566828',	'148826',	'474085',	'308500',	'28671',	'95601',	'87519',	'213521',	'27725',	'72972',	'211483',	'291828',	'46489',	'186755',	'570124',	'320432',	'582283',	'215834',	'154065',	'247136',	'500654',	'441645',	'579960',	'231894',	'1021000',	'312436',	'92854',	'650618',	'523604',	'19004',	'285321',	'132734',	'550601',	'247380',	'147560',	'115150',	'247449',	'24289',	'120718',	'53680',	'120578',	'128375',	'582006',	'197175',	'646709',	'180573',	'630368',	'200411',	'124106',	'265639',	'108217',	'271688',	'321562',	'205889',	'130334',	'442430',	'619677',	'125019',	'476041',	'665742',	'1915',	'166976',	'611065',	'458547',	'13695',	'293031',	'497994',	'90552',	'215949',	'288525',	'145673',	'498141',	'424631',	'429504',	'326366',	'126868',	'461162',	'287264',	'424536',	'549849',	'101285',	'18275',	'85641',	'606580',	'415372',	'130467',	'50328',	'497490',	'519132',	'403346',	'85768',	'142611',	'537724',	'285139',	'532238',	'440688',	'470468',	'457481',	'158883',	'130973',	'22659',	'89208',	'119754',	'47639',	'166684',	'248791',	'437942',	'28521',	'92390',	'531125',	'437942',	'667468',	'1005147',	'485972',	'114825',	'120272',	'204240',	'33655',	'97070',	'194561',	'32987',	'121973',	'169977',	'487661',	'454103',	'106968',	'142324',	'494138',	'185899',	'130351',	'592541',	'35606',	'142353',	'501953',	'17071',	'285648',	'561845')
;

COMMIT;

UPDATE QA_TCSU_AD
SET   CSU_DIUM = 744
WHERE CSU_DIUM > 744;

COMMIT;


--CONTINUAMOS

SELECT TO_NUMBER(TO_CHAR(LAST_DAY(SYSDATE),'DD'))*24 FROM DUAL;



INSERT INTO QA_TCSU_AD
SELECT T1.	CSU_NIU
,(CASE WHEN(T1.CSU_DIUM + NVL(T2.CSU_DIUM,0)<TO_NUMBER(TO_CHAR(LAST_DAY(TO_DATE(:PERIODO,'DD/MM/YYYY')),'DD'))*24) 
       THEN (T1.CSU_DIUM + NVL(T2.CSU_DIUM,0))
       ELSE (TO_NUMBER(TO_CHAR(LAST_DAY(TO_DATE(:PERIODO,'DD/MM/YYYY')),'DD'))*24)
       END ) + NVL(T3.CSU_DIU_AD,0) AS CSU_DIU
,(CASE WHEN(T1.CSU_DIUM + NVL(T2.CSU_DIUM,0)<TO_NUMBER(TO_CHAR(LAST_DAY(TO_DATE(:PERIODO,'DD/MM/YYYY')),'DD'))*24) 
       THEN (T1.CSU_DIUM + NVL(T2.CSU_DIUM,0))
       ELSE (TO_NUMBER(TO_CHAR(LAST_DAY(TO_DATE(:PERIODO,'DD/MM/YYYY')),'DD'))*24)
       END )AS CSU_DIUM 
,T1.	CSU_FIUM + NVL(T2.CSU_FIUM,0) + NVL(T4.CSU_FIU_AD,0) AS CSU_FIU
,T1.	CSU_FIUM + NVL(T2.CSU_FIUM,0) AS CSU_FIUM
,T1.	CSU_IDMERCADO
,T1.	CSU_FRECUENCIA_C1
,T1.	CSU_DURACION_C1
,T1.	CSU_FRECUENCIA_C2
,T1.	CSU_DURACION_C2
,T1.	CSU_FRECUENCIA_C3
,T1.	CSU_DURACION_C3
,T1.	CSU_FRECUENCIA_C4
,T1.	CSU_DURACION_C4
,T1.	CSU_FRECUENCIA_C5
,T1.	CSU_DURACION_C5
,T1.	CSU_FRECUENCIA_C6
,T1.	CSU_DURACION_C6
,T1.	CSU_FRECUENCIA_C7
,T1.	CSU_DURACION_C7
,T1.	CSU_FRECUENCIA_C8
,T1.	CSU_DURACION_C8
,T1.	CSU_FRECUENCIA_C9
,T1.	CSU_DURACION_C9
,T1.	CSU_FRECUENCIA_C10
,T1.	CSU_DURACION_C10
,T1.	CSU_FRECUENCIA_C11
,T1.	CSU_DURACION_C11
,T1.	CSU_FRECUENCIA_C12
,T1.	CSU_DURACION_C12
,T1.	CSU_FRECUENCIA_C13
,T1.	CSU_DURACION_C13
,T1.	CSU_FRECUENCIA_C14
,T1.	CSU_DURACION_C14
,T1.	CSU_FRECUENCIA_C15
,T1.	CSU_DURACION_C15
,T1.	CSU_PERIODO_OP
FROM QA_TCSU T1
LEFT OUTER JOIN (SELECT * FROM QA_TCSX_AD WHERE CSU_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')) T2 
                ON T2.CSU_NIU = T1.CSU_NIU
LEFT OUTER JOIN (SELECT CSU_NIU, SUM(NVL(CSU_DIUM,0)) AS CSU_DIU_AD 
                 FROM QA_TCSU_AD
                 WHERE CSU_PERIODO_OP IN (
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -1),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -2),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -3),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -4),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -5),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -6),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -7),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -8),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -9),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-10),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-11))
          GROUP BY CSU_NIU) T3 ON T3.CSU_NIU = T1.CSU_NIU
LEFT OUTER JOIN (SELECT CSU_NIU, SUM(NVL(CSU_FIUM,0)) AS CSU_FIU_AD 
                 FROM QA_TCSU_AD
                 WHERE CSU_PERIODO_OP IN (
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -1),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -2),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -3),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -4),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -5),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -6),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -7),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -8),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'), -9),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-10),
                         ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-11))
          GROUP BY CSU_NIU) T4 ON T4.CSU_NIU = T1.CSU_NIU          
WHERE T1.CSU_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
;

COMMIT;

--GENERAR CS1_AD

CREATE TABLE QA_TCS1_AD
AS
SELECT * FROM QA_TCS1
WHERE CS1_PERIODO_OP=DATE'2022-07-01';


SELECT * FROM QA_TCS1_AD;


SELECT * FROM QA_TCS1
WHERE CS1_PERIODO_OP=DATE'2019-02-01'
UNION ALL
SELECT * FROM QA_TCS1_AD
WHERE CS1_PERIODO_OP=DATE'2019-02-01';


EXEC QA_PCS1_AD(DATE'2019-02-01');

SELECT T1.CSU_NIU,(T2.CSU_DIUM-T1.CSU_DIUM) AS DIF_DIU ,(T2.CSU_FIUM-T1.CSU_FIUM) AS DIF_FIU
FROM QA_TCSU T1
LEFT OUTER JOIN (SELECT * FROM QA_TCSU_AD WHERE CSU_PERIODO_OP=DATE'2019-01-01') T2 ON T2.CSU_NIU = T1.CSU_NIU
WHERE T1.CSU_PERIODO_OP=DATE'2019-01-01'
;

SELECT * FROM QA_TCSU
WHERE CSU_NIU='424395'
AND CSU_PERIODO_OP=DATE'2019-01-01'
UNION ALL
SELECT * FROM QA_TCSU_AD
WHERE CSU_NIU='424395'
AND CSU_PERIODO_OP=DATE'2019-01-01'
;



SELECT SUM(CSU_DIUM) FROM QA_TCSU_AD
WHERE CSU_PERIODO_OP=DATE'2019-02-01';

UPDATE QA_TCSU_AD
SET   CSU_DIUM = 720
WHERE CSU_NIU = '408335'
AND CSU_PERIODO_OP=DATE'2019-06-01';
;

SELECT * FROM QA_TCSU_AD
WHERE CSU_NIU = '408335'
AND CSU_PERIODO_OP=DATE'2019-06-01';

COMMIT;


SELECT * FROM QA_TCS1
WHERE CS1_PERIODO_OP=DATE'2019-01-01';


EXEC QA_PCS1(DATE'2019-01-01');




UPDATE QA_TCS1
SET   CS1_SAIDI = CS1_SAIDI_M
     ,CS1_SAIFI = CS1_SAIFI_M
     ,CS1_CAIDI = CS1_CAIDI_M
     ,CS1_MAIFI = CS1_MAIFI_M
WHERE CS1_PERIODO_OP=DATE'2019-01-01';
COMMIT;


DELETE FROM QA_TCS1_AD;


--PROCEDIMIENTO DE AJUSTE POR HORAS EXCLUIBLES DE AP

SELECT CSU_PERIODO_OP, SUM (CSU_DIUM) FROM QA_TCSU
WHERE CSU_PERIODO_OP = DATE'2019-01-01'
GROUP BY CSU_PERIODO_OP;

SELECT CSU_PERIODO_OP, SUM (CSU_DIUM) FROM QA_TCSU_AD
WHERE CSU_PERIODO_OP = DATE'2019-01-01'
GROUP BY CSU_PERIODO_OP;

desc QA_TCS1;


--GESTIONAR LA DIFERENCIA DE CALCULO CON AP---

SELECT 
T1.	CS1_PERIODO_OP
,T1.	CS1_IDMERCADO
,T1.	CS1_UIXTI_M
,T1.	CS1_UI_M
,T1.	CS1_UT_M
,T1.	CS1_SAIDI_M
,T1.	CS1_SAIFI_M
,T1.	CS1_SAIDI
,T1.	CS1_SAIFI
,T1.	CS1_SAIDI_MAT
,T1.	CS1_SAIFI_MAT
,T1.	CS1_MAIFI_M
,T1.	CS1_MAIFI
,T1.	CS1_MAIFI_MAT
,T1.	CS1_CAIDI_M
,T1.	CS1_CAIDI
FROM QA_TCS1 T1
LEFT JOIN QA_TCS1_AD T2 ON T2.CS1_PERIODO_OP = T1.	CS1_PERIODO_OP
WHERE T1.CS1_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
;
CREATE TABLE QA_TCS1_TEMP
AS
SELECT * FROM QA_TCS1_AD;

--**************************PROCEDIMIENTO ANONIMO PARA EL CALCULO CS1_AD *******************************
--***************************************************************************************************
/
DECLARE 

    PERIODO DATE;
    SUM_CSU_DIUM_AD NUMBER;
    SUM_CSU_DIUM NUMBER;
    SUM_CSU_FIUM_AD NUMBER;
    SUM_CSU_FIUM NUMBER;
    CS1_SAIDI_AD NUMBER;
    CS1_SAIFI_AD NUMBER;


BEGIN

    --PERIODO:=DATE'2020-01-01';
    PERIODO := TO_DATE(:PERIODO,'DD/MM/YYYY');
    
    SELECT SUM (CSU_DIUM) 
    INTO SUM_CSU_DIUM_AD
    FROM QA_TCSU_AD
    WHERE CSU_PERIODO_OP = PERIODO
    ;
    
    SELECT SUM (CSU_DIUM) 
    INTO SUM_CSU_DIUM
    FROM QA_TCSU
    WHERE CSU_PERIODO_OP = PERIODO
    ;
    
    
    SELECT SUM (CSU_FIUM) 
    INTO SUM_CSU_FIUM_AD
    FROM QA_TCSU_AD
    WHERE CSU_PERIODO_OP = PERIODO
    ;
    
    SELECT SUM (CSU_FIUM) 
    INTO SUM_CSU_FIUM
    FROM QA_TCSU
    WHERE CSU_PERIODO_OP = PERIODO
    ;
    
    
    SELECT NVL(SUM(NVL(CS1_SAIDI_M,0)),0) AS CS1_SAIDI_AD 
    INTO CS1_SAIDI_AD
    FROM QA_TCS1_AD
    WHERE TO_CHAR(CS1_PERIODO_OP,'YYYY') = TO_CHAR(PERIODO,'YYYY')
    ;
    
    
    SELECT NVL(SUM(NVL(CS1_SAIFI_M,0)),0) AS CS1_SAIFI_AD 
    INTO CS1_SAIFI_AD
    FROM QA_TCS1_AD
    WHERE TO_CHAR(CS1_PERIODO_OP,'YYYY') = TO_CHAR(PERIODO,'YYYY')
    ;
    
    
    INSERT INTO QA_TCS1_AD
    SELECT 
         CS1_PERIODO_OP
        ,CS1_IDMERCADO
        ,CS1_UIXTI_M + (SUM_CSU_DIUM_AD-SUM_CSU_DIUM) AS CS1_UIXTI_M
        ,CS1_UI_M + (SUM_CSU_FIUM_AD-SUM_CSU_FIUM) AS CS1_UI_M
        ,CS1_UT_M
        ,(CS1_UIXTI_M + (SUM_CSU_DIUM_AD-SUM_CSU_DIUM))/CS1_UT_M AS CS1_SAIDI_M
        ,(CS1_UI_M    + (SUM_CSU_FIUM_AD-SUM_CSU_FIUM))/CS1_UT_M AS CS1_SAIFI_M
        ,((CS1_UIXTI_M + (SUM_CSU_DIUM_AD-SUM_CSU_DIUM))/CS1_UT_M) + CS1_SAIDI_AD AS CS1_SAIDI
        ,((CS1_UI_M    + (SUM_CSU_FIUM_AD-SUM_CSU_FIUM))/CS1_UT_M) + CS1_SAIFI_AD AS CS1_SAIFI
        ,CS1_SAIDI_MAT
        ,CS1_SAIFI_MAT
        ,CS1_MAIFI_M
        ,CS1_MAIFI
        ,CS1_MAIFI_MAT
        ,CS1_CAIDI_M
        ,CS1_CAIDI
    FROM QA_TCS1
    WHERE CS1_PERIODO_OP=PERIODO
    ;
COMMIT;
END;
/


SELECT *FROM QA_TCS1_AD;
COMMIT;

SELECT * FROM QA_TCS1
WHERE CS1_PERIODO_OP=DATE'2019-12-01'
UNION ALL
SELECT * FROM QA_TCS1_AD
WHERE CS1_PERIODO_OP=DATE'2019-12-01'
;


SELECT CSU_PERIODO_OP, COUNT(CSU_PERIODO_OP) FROM QA_TCSU_AD
GROUP BY CSU_PERIODO_OP
ORDER BY CSU_PERIODO_OP ASC;


SELECT * FROM QA_TCS1
WHERE CS1_PERIODO_OP=DATE'2019-12-01';




SELECT * FROM QA_TCSU
WHERE CSU_PERIODO_OP = DATE'2022-06-01'
AND CSU_DIUM = 720;


UPDATE QA_TCSU
SET CSU_DIU = CSU_DIU - (CSU_DIUM-720)
   ,CSU_DIUM =  720
WHERE CSU_PERIODO_OP = DATE'2022-06-01'
AND CSU_DIUM > 720;

COMMIT;


DELETE FROM QA_TCS1
WHERE CS1_PERIODO_OP=DATE'2022-06-01';


COMMIT;

EXEC QA_PCS1(DATE'2022-06-01');


SELECT * FROM qa_tcs1
WHERE CS1_PERIODO_OP=DATE'2022-06-01';






