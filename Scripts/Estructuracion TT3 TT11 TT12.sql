
SELECT * FROM QA_TFDDREGISTRO;

SELECT DISTINCT FDR_PERIODO_OP FROM QA_TFDDREPORTE_AJ;




SELECT * FROM QA_TT3_RESUMEN;


/*CREAR TABLA: QA_TTT3_REGISTRO*/
--*TT3_PERIODO_OP
--*TT3_ID
--*TT3_NOMBRE_DESCONEXION (ACTUAL LLAVE BUSCAR)
--TT3_FINICIAL
--TT3_FFINAL
--TT3_SUBESTACION
--TT3_DESCRIPCION (ACTIVIDAD PLANEADA)
--TT3_CODIGOPROYECTO



CREATE TABLE QA_TTT3_REGISTRO(
TT3_PERIODO_OP DATE,
TT3_ID NUMBER,
TT3_NOMBRE_DESCONEXION VARCHAR2(40), 
TT3_FINICIAL DATE,
TT3_FFINAL DATE,
TT3_SUBESTACION VARCHAR2(30),
TT3_IUS VARCHAR2(4),
TT3_DESCRIPCION VARCHAR2(400), 
TT3_CODIGOPROYECTO VARCHAR2(50)--sin validacion con PI3
);


SELECT * FROM QA_TTT3_REGISTRO;

--EL LLENADO DE LA TABLA QA_TTT3_REGISTRO SE REALIZA A TRAVES DE, YA SEA UN CARGUE MASIVO O A TRAVES DE LA INTERFAZ DEL USUARIO

--CREAMOS LA TABLA DE CIRCUITOS O LINEAS AFECTADAS QA_TTT3_AFECTACION-- ESTA ES LA ACTUAL TABLA LLAVE_BUSCAR

SELECT * FROM QA_TT3_LLAVEBUSCAR;

CREATE TABLE QA_TTT3_AFECTACION(
 TT3_PERIODO_OP DATE
,TT3_ID NUMBER
,TT3_NOMBRE_DESCONEXION VARCHAR2(40)
,TT3_CIRCUITO VARCHAR2(30)
,TT3_IUL VARCHAR2(4));


SELECT * FROM QA_TTT3_AFECTACION;

SELECT * FROM AC_TBRA1;


SELECT T.CODE, M.MUND_DESCRIPCION  
FROM SPARD.TRANSFOR T
LEFT OUTER JOIN QA_TMUNDANE M ON M.MUND_MUNDANE=T.MUNICIPIO
;


SELECT * FROM QA_TTT3_DESCONEXION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

CREATE TABLE QA_TTT11_REGISTRO AS
(SELECT * FROM QA_TTT3_DESCONEXION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
);

SELECT * FROM QA_TTT11_REGISTRO; --TABLA RESUMEN (VERSION MICHAEL)

DROP TABLE QA_TTT11_REGISTRO;

DESC QA_TTT3_DESCONEXION;

CREATE TABLE QA_TTT11_REGISTRO
(		TT11_PERIODO_OP	DATE
,	TT11_ID	NUMBER
,	TT11_NOMBRE_DESCONEXION	VARCHAR2(40)
,	TT11_FINICIAL	DATE
,	TT11_FFINAL	DATE
,	TT11_SUBESTACION	VARCHAR2(30)
,	TT11_IUS	VARCHAR2(4)
,	TT11_DESCRIPCION	VARCHAR2(400)
,	TT11_CODIGOPROYECTO	VARCHAR2(50)
,	TT11_CERTIFICADO	NUMBER
,	TT11_FMODIFICACION	DATE
,	TT11_FCERTIFICACION	DATE
,	TT11_FCREACION	DATE
);

DESC QA_TTT11_REGISTRO;
DESC QA_TTT3_DESCONEXION;

ALTER TABLE QA_TTT11_REGISTRO
ADD TT3_TIPOPROYECTO VARCHAR2(20);

INSERT INTO QA_TTT11_REGISTRO
SELECT * FROM QA_TTT3_DESCONEXION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

SELECT * FROM QA_TTT11_REGISTRO;

UPDATE QA_TTT11_REGISTRO
SET TT11_PERIODO_OP=TRUNC(TT11_FINICIAL,'MM')
WHERE TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
;

COMMIT;


SELECT * FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');



CREATE TABLE QA_TTT11_AFECTACION(
	TT11_PERIODO_OP	DATE
,	TT11_ID	NUMBER
,	TT11_NOMBRE_DESCONEXION	VARCHAR2(40)
,	TT11_CIRCUITO	VARCHAR2(30)
,	TT11_IUL	VARCHAR2(4)
);

INSERT    INTO QA_TTT11_AFECTACION
SELECT 	* FROM QA_TTT3_AFECTACION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');



SELECT * FROM QA_TTT3_AFECTACION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

COMMIT;

--SCRIPT QA_TTT11_REPORTE - ENERO 2022

WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = '202111'
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = '202111'
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)

(
    SELECT '1'                                             AS ACTIVIDAD
          , RG.TT11_DESCRIPCION                            AS OBJETIVO
          , TC.TC1_IUA                                     AS CODIGOS_IUA_IUL --CRUCE TC1
          , TC.CANT_USRS_T                                 AS USUARIOS_AFECTADOS --CRUCE TC1
          , RG.TT11_FINICIAL                               AS FECHA_INICIAL
          , RG.TT11_FFINAL                                 AS FECHA_FINAL
          ,LPAD((RG.TT11_FFINAL-RG.TT11_FINICIAL)*24,2,0)  AS DURACION
          ,'MSJ TEXTO-CORREO-CARTA OFICIO'                 AS MEDIO_PUBLICACION
          , (CASE WHEN RG.TT11_ID=10 
                  THEN TO_DATE('11/01/2021','DD/MM/YYYY') 
                  ELSE TO_DATE('18/01/2021','DD/MM/YYYY') 
            END)                                           AS FECHA_ESTIMADA_PUBLICACION --CONFIGURAR
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_PROYECCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN BRAE.QA_TTT3_AFECTACION AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE('01/01/2022','DD/MM/YYYY')
)
UNION ALL
(
    SELECT '1'                                             AS ACTIVIDAD
          , RG.TT11_DESCRIPCION                            AS OBJETIVO
          , AF.TT3_IUL                                    AS CODIGOS_IUA_IUL --CRUCE TC1
          , TC.CANT_USRS_C                                 AS USUARIOS_AFECTADOS --CRUCE TC1
          , RG.TT11_FINICIAL                               AS FECHA_INICIAL
          , RG.TT11_FFINAL                                 AS FECHA_FINAL
          ,LPAD((RG.TT11_FFINAL-RG.TT11_FINICIAL)*24,2,0)  AS DURACION
          ,'MSJ TEXTO-CORREO-CARTA OFICIO'                 AS MEDIO_PUBLICACION
          , (CASE WHEN RG.TT11_ID=10 
                  THEN TO_DATE('11/01/2021','DD/MM/YYYY') 
                  ELSE TO_DATE('18/01/2021','DD/MM/YYYY') 
            END)                                           AS FECHA_ESTIMADA_PUBLICACION --CONFIGURAR
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_PROYECCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN BRAE.QA_TTT3_AFECTACION AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                           ,CANT_USRS_C
                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE('01/01/2022','DD/MM/YYYY')
)
;

SELECT COUNT(DISTINCT TC1_CODCONEX)
FROM QA_TTC1
WHERE TC1_PERIODO='202111'
AND TC1_CODCIRC IN ('0103','0142','0143')
;
--58
--285
--206
--SUMA:549 

---INFORMACION PARA ENVIAR DEL TT11

WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = '202112'
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = '202112'
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)
( SELECT RG.TT11_ID AS ITEM
      , RG.TT11_SUBESTACION AS SUBESTACION
      , RG.TT11_IUS AS IUS
      , RG.TT11_FINICIAL AS FECHA_INICIAL
      , RG.TT11_FFINAL AS FECHA_FINAL
      , RG.TT11_DESCRIPCION AS DESCRIPCION
      , AF.TT3_CIRCUITO AS CIRCUITO
      , TC.CANT_USRS_C AS USUARIOS_AFECTADOS
      , TC.CANT_TRF AS TRANSFORAMDORES_AFECTADOS
 FROM QA_TTT11_REGISTRO RG
 LEFT OUTER JOIN QA_TTT3_AFECTACION AF ON AF.TT3_ID = RG.TT11_ID
 LEFT OUTER JOIN (SELECT TC1_CODCIRC
                      ,COUNT(TC1_IUA) AS CANT_TRF
                      ,CANT_USRS_C
                  FROM TC1_CODIGOS
                  GROUP BY TC1_CODCIRC,CANT_USRS_C) TC ON TC.TC1_CODCIRC = AF.TT3_IUL
 --WHERE RG.TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
 );
    
SELECT * FROM QA_TTT3_DESCONEXION;

ALTER TABLE QA_TTT3_DESCONEXION
ADD TT3_TIPOPROYECTO VARCHAR2(20);

UPDATE QA_TTT3_DESCONEXION
SET TT3_TIPOPROYECTO='REPOSICION';


DESC QA_TTT3_DESCONEXION;


SELECT * FROM QA_TTT3_AFECTACION;


SELECT * FROM QA_TTT11_REGISTRO;

-------------GENERACION DE INFORMACION TT12--------------------------------------EJECUTADO
SELECT  T1.TT1_NOMBRECIRCUITO
      , T.TC1_CODCIRC AS CIRCUITO
      , 'XXXX' AS ACTIVIDAD
      , FDD_IUA AS CODIGO_CIR_TRA
      , T.CANT_USRS AS NUM_USRS      
      , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
      , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
      ,12 AS MES_EJECUCION
FROM QA_TFDDREGISTRO R
LEFT OUTER JOIN (
                SELECT DISTINCT 
                       TC1_CODCONEX
                      ,TC1_CODCIRC
                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                FROM QA_TTC1
                WHERE TC1_PERIODO=202201
                GROUP BY TC1_CODCONEX
                        ,TC1_CODCIRC
                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY')='01/2022'
AND FDD_CAUSA_SSPD IN ('14')

UNION ALL

SELECT TT1_NOMBRECIRCUITO
      ,CIRCUITO
      ,'XXXX' ACTIVIDAD
      ,CIRCUITO
      ,SUM(NUM_USRS) AS NUM_USRS
      ,FINICIAL
      ,FFINAL
      ,DURACION
      ,MES_EJECUCION
FROM(
SELECT T1.TT1_NOMBRECIRCUITO
      ,T.TC1_CODCIRC AS CIRCUITO
      , 'XXXX' AS ACTIVIDAD
      --, FDD_IUA AS CODIGO_CIR_TRA
      , T.CANT_USRS AS NUM_USRS      
      , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
      , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
      ,12 AS MES_EJECUCION
FROM QA_TFDDREGISTRO R
LEFT OUTER JOIN (
                SELECT DISTINCT 
                       TC1_CODCONEX
                      ,TC1_CODCIRC
                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                FROM QA_TTC1
                WHERE TC1_PERIODO=202112
                GROUP BY TC1_CODCONEX
                        ,TC1_CODCIRC
                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY')='12/2021'
AND FDD_CAUSA_SSPD IN ('14')
)
GROUP BY TT1_NOMBRECIRCUITO
        ,CIRCUITO
        ,FINICIAL
        ,FFINAL
        ,DURACION
        ,MES_EJECUCION;

--------TT12 SEGUNDA PARTE-- REGISTROS DEL TT11 SIN EJECUTAR--REPORTE

SELECT * FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');






SELECT * FROM QA_TTT3_DESCONEXION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

SELECT * FROM QA_TTT3_AFECTACION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

SELECT * FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');


UPDATE QA_TTT11_REGISTRO
SET TT11_CERTIFICADO=1,
    TT11_FCERTIFICACION = TO_DATE('21/12/2021','DD/MM/YYYY')
WHERE TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

COMMIT;


--FEBRERO 2022 TT11
SELECT * FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/02/2022','DD/MM/YYYY');


WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = '202112'
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = '202112'
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)

(
    SELECT  TO_NUMBER(CASE WHEN(RG.TT3_TIPOPROYECTO='EXPANSION')  THEN '2'
                           WHEN(RG.TT3_TIPOPROYECTO='REPOSICION') THEN '1'                       
             END)                                          AS ACTIVIDAD
          , RG.TT11_DESCRIPCION                            AS OBJETIVO
          , TC.TC1_IUA                                     AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(RG.TT11_FINICIAL,'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(RG.TT11_FFINAL  ,'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          ,ROUND((RG.TT11_FFINAL-RG.TT11_FINICIAL)*24,2)   AS DURACION
          ,'MSJ TEXTO-CORREO-CARTA OFICIO'                 AS MEDIO_PUBLICACION
          , (CASE WHEN RG.TT11_ID=3 THEN '27-01-2022' 
                  WHEN RG.TT11_ID=4 THEN '26-01-2022' 
                  WHEN RG.TT11_ID=5 THEN '02-02-2022' 
                  WHEN RG.TT11_ID=6 THEN '04-02-2022' 
                  WHEN RG.TT11_ID=7 THEN '11-02-2022'             
             END)                                          AS FECHA_ESTIMADA_PUBLICACION --CONFIGURAR
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_PROYECCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN BRAE.QA_TTT11_AFECTACION AF ON AF.TT11_ID     = RG.TT11_ID
    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT11_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE('01/02/2022','DD/MM/YYYY')
)
UNION ALL
(
    SELECT  TO_NUMBER(CASE WHEN(RG.TT3_TIPOPROYECTO='EXPANSION')  THEN '2'
                           WHEN(RG.TT3_TIPOPROYECTO='REPOSICION') THEN '1'                       
             END)                                          AS ACTIVIDAD
          , RG.TT11_DESCRIPCION                            AS OBJETIVO
          , AF.TT11_IUL                                    AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(RG.TT11_FINICIAL,'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(RG.TT11_FFINAL  ,'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          ,ROUND((RG.TT11_FFINAL-RG.TT11_FINICIAL)*24,2)   AS DURACION
          ,'MSJ TEXTO-CORREO-CARTA OFICIO'                 AS MEDIO_PUBLICACION
          , (CASE WHEN RG.TT11_ID=3 THEN '27-01-2022' 
                  WHEN RG.TT11_ID=4 THEN '26-01-2022' 
                  WHEN RG.TT11_ID=5 THEN '02-02-2022' 
                  WHEN RG.TT11_ID=6 THEN '04-02-2022' 
                  WHEN RG.TT11_ID=7 THEN '11-02-2022'             
             END)                                          AS FECHA_ESTIMADA_PUBLICACION --CONFIGURAR
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_PROYECCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN BRAE.QA_TTT11_AFECTACION AF ON AF.TT11_ID     = RG.TT11_ID
    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                           ,CANT_USRS_C
                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT11_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE('01/02/2022','DD/MM/YYYY')
)
;

SELECT * FROM QA_TTT11_AFECTACION
WHERE TT11_ID IN (11)
UNION
SELECT * FROM QA_TTT3_AFECTACION
WHERE TT3_ID IN (2);


SELECT * FROM QA_TTT3_AFECTACION
WHERE TT3_ID IN (1,2)
AND TT3_IUL = '0062';

SELECT * FROM QA_TTT11_REGISTRO;

DELETE FROM QA_TTT3_AFECTACION
WHERE TT3_ID IN (1,2)
AND TT3_IUL = '0062';
COMMIT;


DELETE FROM QA_TTT11_AFECTACION;

INSERT INTO QA_TTT11_AFECTACION
SELECT * FROM QA_TTT3_AFECTACION;

SELECT * FROM QA_TTC1 
WHERE TC1_PERIODO='202112'
AND TC1_CODCIRC='0062';

--MARCAR COMO CERTIFICADOS LOS EVENTOS CONFIRMADOS PARA FEBRERO 2022
SELECT * FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/02/2022','DD/MM/YYYY');

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO = 1,
      TT11_FCERTIFICACION = TO_DATE('19/01/2022','DD/MM/YYYY')
WHERE TT11_PERIODO_OP=TO_DATE('01/02/2022','DD/MM/YYYY');

COMMIT;


SELECT * FROM QA_TTT11_REGISTRO
WHERE TT11_CERTIFICADO=1;


SELECT * FROM QA_TTT11_REGISTRO;

ALTER TABLE QA_TTT11_REGISTRO
RENAME COLUMN TT3_TIPOPROYECTO TO TT11_TIPOPROYECTO;

SELECT * FROM QA_TTT11_AFECTACION;

UPDATE QA_TTT11_AFECTACION
SET TT11_PERIODO_OP = TRUNC(TT11_FINICIAL,'MM');

SELECT * FROM QA_TTT3_DESCONEXION;

--CAMBIAR LOS NOMBRES DE LOS CAMPOS NOMBRE_DESCONEXION POR DESCRIPCION 
-- Y EL CAMPO DESCRIPCIO POR TT11_ALCANCE

ALTER TABLE QA_TTT3_DESCONEXION
RENAME COLUMN TT3_DESCRIPCION TO TT3_ALCANCE;

ALTER TABLE QA_TTT3_DESCONEXION
RENAME COLUMN TT3_NOMBRE_DESCONEXION TO TT3_DESCRIPCION;


ALTER TABLE QA_TTT3_AFECTACION
RENAME COLUMN TT3_NOMBRE_DESCONEXION TO TT3_DESCRIPCION;


ALTER TABLE QA_TTT11_REGISTRO
RENAME COLUMN TT11_DESCRIPCION TO TT11_ALCANCE;

ALTER TABLE QA_TTT11_REGISTRO
RENAME COLUMN TT11_NOMBRE_DESCONEXION TO TT11_DESCRIPCION;

--CAMBIAR EL NOMBRE DE LA TABLA QA_TTT3_DESCONEXION TO QA_TTT3_REGISTRO;

RENAME QA_TTT3_DESCONEXION TO QA_TTT3_REGISTRO;

SELECT * FROM QA_TTT3_AFECTACION;

DROP TABLE QA_TTT11_AFECTACION;

SELECT * FROM QA_TTT3_REPORTE;

--CREACION DEL PROCEDIMIENTO  QA_PTT3_REPORTE()

WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = '202112'
                     AND    TC1_TIPCONEX = 'T'
                     AND    TC1_CODCONEX NOT LIKE 'ALPM%'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = '202112'
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)

(
    SELECT  RG.TT3_IUS                                     AS IUS
          , 2                                              AS CLASIFICACION
          , TC.TC1_IUA                                     AS CODIGOS_TRF_CIR --CRUCE TC1
          , TO_CHAR(RG.TT3_FINICIAL,'DD-MM-YYYY HH24:MI')  AS FECHA_INICIAL
          , TO_CHAR(RG.TT3_FFINAL  ,'DD-MM-YYYY HH24:MI')  AS FECHA_FINAL
          , RG.TT3_ALCANCE                                 AS DESC_DEL_TRABAJO
          , RG.TT3_CODIGOPROYECTO                          AS CODIGO_PROYECTO
          , '161'                                          AS ID_MERCADO
    FROM BRAE.QA_TTT3_REGISTRO RG
    LEFT OUTER JOIN (SELECT * 
                     FROM BRAE.QA_TTT3_AFECTACION 
                     WHERE TT3_PERIODO_OP = 
                           TO_DATE('01/01/2022','DD/MM/YYYY')
                     ) AF ON AF.TT3_ID = RG.TT3_ID    
    LEFT OUTER JOIN  TC1_CODIGOS            TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT3_PERIODO_OP = TO_DATE('01/01/2022','DD/MM/YYYY')
    AND TC.TC1_IUA IS NOT NULL
)
UNION ALL
(
    SELECT  RG.TT3_IUS                                     AS IUS
          , 1                                              AS CLASIFICACION
          , AF.TT3_IUL                                     AS CODIGOS_TRF_CIR --CRUCE TC1
          , TO_CHAR(RG.TT3_FINICIAL,'DD-MM-YYYY HH24:MI')  AS FECHA_INICIAL
          , TO_CHAR(RG.TT3_FFINAL  ,'DD-MM-YYYY HH24:MI')  AS FECHA_FINAL
          , RG.TT3_ALCANCE                                 AS DESC_DEL_TRABAJO
          , RG.TT3_CODIGOPROYECTO                          AS CODIGO_PROYECTO
          , '161'                                          AS ID_MERCADO
    FROM BRAE.QA_TTT3_REGISTRO RG
    LEFT OUTER JOIN (SELECT * 
                     FROM BRAE.QA_TTT3_AFECTACION 
                     WHERE TT3_PERIODO_OP = 
                           TO_DATE('01/01/2022','DD/MM/YYYY')
                     ) AF ON AF.TT3_ID = RG.TT3_ID
    WHERE RG.TT3_PERIODO_OP = TO_DATE('01/01/2022','DD/MM/YYYY')
)
;


SELECT DISTINCT TC1_CODCONEX
FROM QA_TTC1
WHERE TC1_PERIODO=202112
AND TC1_CODCIRC='0008'
AND TC1_TIPCONEX='T';

--PRIMER PRODUCTO CARTESIANO
SELECT COUNT(*) FROM QA_TTT3_REGISTRO
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY'); --52

SELECT COUNT(*) FROM QA_TTT3_AFECTACION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY'); --325
--PRODUCTO CARTESIANO IGUAL A LA CANTIDAD DE REGISTRO DE LA TABLA B

--SEGUNDO PRODUCTO CARTESIANO
--A(52) , B(325)
--AB(325) INTERSECT C(53.695) = 53.695 CANTIDADES
--SUMAMOS LAS CANTIDADES POR CIRCUITO = 53.695+325 = 54.020

SELECT 53695+325 FROM DUAL;

SELECT * FROM QA_TTT3_AFECTACION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

SELECT TC1_CODCIRC, COUNT(DISTINCT TC1_CODCONEX) 
FROM QA_TTC1
WHERE TC1_PERIODO=202112
AND   TC1_TIPCONEX = 'T'
AND   TC1_CODCONEX NOT LIKE 'ALPM%'
GROUP BY TC1_CODCIRC;


SELECT * 
FROM QA_TTC1
WHERE TC1_PERIODO=202112
AND   TC1_TIPCONEX = 'T'
AND   TC1_CODCIRC IS NULL
;


SELECT * FROM QA_TTT3_REGISTRO
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

UPDATE QA_TTT3_REGISTRO
SET TT3_CERTIFICADO=1
   ,TT3_FCERTIFICACION=TO_DATE('31/01/2022','DD/MM/YYYY')
WHERE TT3_PERIODO_OP  =TO_DATE('01/01/2022','DD/MM/YYYY');

COMMIT;






---GENERACION DE FORMATO TT12 ENERO-2022

--PRIMERA PARTE SALE DE LA TABLA QA_TFDDREGISTRO
NULL
--SEGUNDA PARTE SALE DE LA TABLA QA_TT11_REGISTRO, PORQUE NO SE EJECUTARON LAS CONFIRMADAS

WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)

(
    SELECT  TO_NUMBER(CASE WHEN(RG.TT11_TIPOPROYECTO='EXPANSION')  THEN '2'
                           WHEN(RG.TT11_TIPOPROYECTO='REPOSICION') THEN '1'                       
             END)                                          AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , TC.TC1_IUA                                     AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN BRAE.QA_TTT3_AFECTACION AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
)
UNION ALL
(
    SELECT  TO_NUMBER(CASE WHEN(RG.TT11_TIPOPROYECTO='EXPANSION')  THEN '2'
                           WHEN(RG.TT11_TIPOPROYECTO='REPOSICION') THEN '1'                       
             END)                                          AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , AF.TT3_IUL                                    AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN BRAE.QA_TTT3_AFECTACION AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                           ,CANT_USRS_C
                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
)
;

SELECT * FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');
---PENDIENTES
select TO_CHAR(9,'0.0000000') AS XX FROM DUAL;


SELECT DISTINCT TT3_PERIODO_OP FROM QA_TTT3_REPORTE;


SELECT (TO_NUMBER(TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY'))-1)||'12' AS PERIODO FROM DUAL;

SELECT (TO_NUMBER(TO_CHAR(FECHAPERIODO,'YYYY'))-1)||'12' AS PERIODO FROM DUAL;

SELECT DISTINCT TT3_PERIODO_OP FROM QA_TTT3_REPORTE;



UPDATE QA_TTT3_REGISTRO
SET TT3_CERTIFICADO    = 0
   ,TT3_FCERTIFICACION = NULL
WHERE TT3_PERIODO_OP  =TO_DATE('01/01/2022','DD/MM/YYYY');

COMMIT;


EXEC QA_PTT3_REPORTE(TO_DATE('01/01/2022','DD/MM/YYYY'));

DESC QA_TTT3_REPORTE;

ALTER TABLE QA_TTT3_REPORTE
ADD TT3_IDMERCADO NUMBER;

DESC QA_TTT2_REGISTRO;

EXEC QA_PTT3_REPORTE(TO_DATE('01/01/2022','DD/MM/YYYY'));
SELECT * FROM QA_TTT3_REPORTE 
WHERE TT3_PERIODO_OP = TO_DATE('01/01/2022','DD/MM/YYYY');



                        SELECT (TT3_IUS||','||
                                TT3_CLASIFICACION||','||
                                TT3_IUA||','||
                                TO_CHAR(TT3_FINICIAL,'DD-MM-YYYY HH24:MI')||','||
                                TO_CHAR(TT3_FFINAL  ,'DD-MM-YYYY HH24:MI')||','||
                                TT3_DESCRIPCION||','||
                                TT3_CODIGOPROYECTO||','||
                                TT3_IDMERCADO) AS CONCAT
                        FROM BRAE.QA_TTT3_REPORTE QA
                        WHERE TT3_PERIODO_OP =  TO_DATE('01/01/2022','DD/MM/YYYY')
                        ;


SELECT TRIM('     PEPE PEREZ    ' ) FROM DUAL; 

SELECT REPLACE (REPLACE (REPLACE ('     PEPE PEREZ    ', CHR (10), ' '), CHR (13), ' '),
                ' ',
                ' ')
          AS COLUMNA_NUEVA

  FROM DUAL;
  
  SELECT TRIM(REPLACE(REPLACE(REPLACE('     PEPE PEREZ    ',CHR(10),' ') ,CHR(13),' ') ,'  ',' ')) AS X FROM DUAL;


SELECT * FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/03/2022','DD/MM/YYYY');

SELECT DISTINCT(TT11_CERTIFICADO) AS TT11_CERTIFICADO 
                                         FROM QA_TTT11_REGISTRO  ;


SELECT * FROM QA_TTT3_REGISTRO
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');

SELECT * FROM QA_TTT3_AFECTACION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');


COMMIT;

SELECT * FROM QA_TTT3_REGISTRO;


UPDATE QA_TTT3_REGISTRO
SET TT3_CERTIFICADO=1
   ,TT3_FCERTIFICACION=TO_DATE('31/01/2022','DD/MM/YYYY')
   ,TT3_FMODIFICACION = TT3_FCREACION
WHERE TT3_PERIODO_OP  =TO_DATE('01/01/2022','DD/MM/YYYY');

COMMIT;


SELECT * FROM QA_TCS3;


SELECT * FROM QA_TFDDREPORTE_AJ
WHERE FDR_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
AND FDR_FFINAL IS NULL;

SELECT * FROM QA_TFDDREPORTE
WHERE FDR_CODIGOEVENTO = '886765';


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO='1T13169';

SELECT DISTINCT TC1_PERIODO FROM QA_TTC1
WHERE TC1_CODCONEX='1T13169';


DELETE FROM QA_TTT11_REGISTRO
WHERE TT11_DESCRIPCION = 'CACHIRA_TODAS_5SE';

COMMIT;

DELETE FROM QA_TTT3_REGISTRO
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2021','DD/MM/YYYY');


DELETE FROM QA_TTT3_AFECTACION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2021','DD/MM/YYYY');

COMMIT;


SELECT * FROM QA_TTT3_AFECTACION
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY');


SELECT * FROM QA_TTT11_REGISTRO
WHERE TO_CHAR(TT11_PERIODO_OP,'YYYY')='2021';

SELECT * FROM QA_TTT3_REGISTRO
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2021','DD/MM/YYYY');


SELECT * FROM QA_TTT3_REGISTRO
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
;


UPDATE QA_TTT3_REGISTRO
SET TT3_ID=10
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
AND TT3_ID = '55'
;

UPDATE QA_TTT3_AFECTACION
SET TT3_ID=10
WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
AND TT3_ID = '55'
;

UPDATE QA_TTT11_REGISTRO
SET TT11_ID=10
WHERE TO_CHAR(TT11_PERIODO_OP,'YYYY')='2022'
AND TT11_ID = '55'
;

COMMIT;


SELECT * FROM QA_TTT11_REGISTRO
WHERE TO_CHAR(TT11_PERIODO_OP,'YYYY')='2021';


CREATE TABLE BRAE.QA_TTT11_REPORTE(
 TT11_PERIODO_OP     DATE
,TT11_ID             NUMBER
,TT11_ACTIVIDAD      VARCHAR2(20)
,TT11_OBJETIVO       VARCHAR2(400)
,TT11_CODE_IUA_IUL   VARCHAR2(20)
,TT11_USRS_AFECTADOS NUMBER
,TT11_FINICIAL       DATE
,TT11_FFINAL         DATE
,TT11_DURACION       NUMBER
,TT11_MEDIO_PUB      VARCHAR2(200)
,TT11_FECHA_PUB      DATE
,TT11_MES_PROYECCION NUMBER
);


SELECT *
FROM QA_TTT11_REPORTE
--WHERE LENGTH(TT11_CODE_IUA_IUL)=4
;
/

--GENERACION DE RETROACTIVO DEL MES DE ENERO 2022 PARA FORAMTO TT11 REPORTE
EXEC QA_PTT11_REPORTE(TO_DATE('01/01/2022','DD/MM/YYYY'));

SELECT *
FROM QA_TTT11_REPORTE
--WHERE LENGTH(TT11_CODE_IUA_IUL)=4
;

SELECT * FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
AND   TT11_ID = 2;

UPDATE QA_TTT11_REPORTE
SET   TT11_FECHA_PUB = TO_DATE('18/01/2022','DD/MM/YYYY')
WHERE TT11_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY')
AND   TT11_ID = 2;

COMMIT;

--GENERACION DE RETROACTIVO DEL MES DE FEBRERO 2022 PARA FORAMTO TT11 REPORTE
EXEC QA_PTT11_REPORTE(TO_DATE('01/02/2022','DD/MM/YYYY'));

SELECT DISTINCT TT11_FINICIAL,TT11_ID,TT11_OBJETIVO,TT11_FECHA_PUB FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/02/2022','DD/MM/YYYY')
;
--ID3:27 ENERO
--ID4:26 ENERO
--ID5:2 ENERO
--ID6:

UPDATE QA_TTT11_REPORTE
SET   TT11_FECHA_PUB=TT11_FECHA_PUB+1
WHERE TT11_PERIODO_OP=TO_DATE('01/02/2022','DD/MM/YYYY');
COMMIT;

UPDATE QA_TTT11_REPORTE
SET   TT11_FECHA_PUB=TT11_FECHA_PUB-2
WHERE TT11_PERIODO_OP=TO_DATE('01/02/2022','DD/MM/YYYY')
AND   TT11_ID = 4;

--GENERACION DE RETROACTIVO DEL MES DE MARZO 2022 PARA FORAMTO TT11 REPORTE
SELECT T1.TT11_ID,T1.TT11_FINICIAL,T3.TT3_FINICIAL 
FROM QA_TTT11_REGISTRO T1
LEFT OUTER JOIN (SELECT TT3_ID,TT3_FINICIAL FROM QA_TTT3_REGISTRO  WHERE TT3_PERIODO_OP=TO_DATE('01/01/2022','DD/MM/YYYY') ORDER BY 1) T3 ON T3.TT3_ID = T1.TT11_ID
WHERE TO_CHAR(T1.TT11_PERIODO_OP,'YYYY')='2022'
AND  T1.TT11_FINICIAL<>T3.TT3_FINICIAL
ORDER BY 1;

EXEC QA_PTT11_REPORTE(TO_DATE('01/04/2022','DD/MM/YYYY'));

SELECT TT3_IUL 
FROM QA_TTT11_REGISTRO T1
LEFT OUTER JOIN (SELECT * FROM QA_TTT3_AFECTACION WHERE TT3_PERIODO_OP = TO_DATE('01/01/2022','DD/MM/YYYY')) T3 ON T3.TT3_ID= T1.TT11_ID 
WHERE T1.TT11_PERIODO_OP=TO_DATE('01/03/2022','DD/MM/YYYY')
;


SELECT TC1_CODCIRC,COUNT(DISTINCT TC1_CODCONEX) AS CANT 
FROM QA_TTC1
WHERE TC1_PERIODO=202201
AND TC1_TIPCONEX='T'
GROUP BY TC1_CODCIRC
;

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/04/2022','DD/MM/YYYY')
;

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO=1
  ,   TT11_FCERTIFICACION=SYSDATE
WHERE TT11_PERIODO_OP=TO_DATE('01/04/2022','DD/MM/YYYY')
;
COMMIT;


--FORMA DE ENLISTAR LAS FILAS DE UN MISMO GRUPO
SELECT TT3_ID
      ,TT3_DESCRIPCION
      , LISTAGG (TT3_CIRCUITO, ' ')  WITHIN GROUP (ORDER BY TT3_CIRCUITO) AS CIRCUITOS
      , LISTAGG (TT3_IUL     , ' ')  WITHIN GROUP (ORDER BY TT3_IUL)      AS IULS
FROM BRAE.QA_TTT3_AFECTACION 
WHERE TT3_PERIODO_OP = '01/01/2022' 
GROUP BY TT3_ID, TT3_DESCRIPCION
ORDER BY TT3_ID ;




---GENERACION DE FORMATO TT12 OCTUBRE 2021

--PRIMERA PARTE SALE DE LA TABLA QA_TFDDREGISTRO
SELECT  T1.TT1_NOMBRECIRCUITO
      , T.TC1_CODCIRC AS CIRCUITO
      , 'XXXX' AS ACTIVIDAD
      , FDD_IUA AS CODIGO_CIR_TRA
      , T.CANT_USRS AS NUM_USRS      
      , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
      , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
      ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
FROM QA_TFDDREGISTRO R
LEFT OUTER JOIN (
                SELECT DISTINCT 
                       TC1_CODCONEX
                      ,TC1_CODCIRC
                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                FROM QA_TTC1
                WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                GROUP BY TC1_CODCONEX
                        ,TC1_CODCIRC
                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
AND FDD_CAUSA_SSPD IN ('14')

UNION ALL

SELECT TT1_NOMBRECIRCUITO
      ,CIRCUITO
      ,'XXXX' ACTIVIDAD
      ,CIRCUITO
      ,SUM(NUM_USRS) AS NUM_USRS
      ,FINICIAL
      ,FFINAL
      ,DURACION
      ,MES_EJECUCION
FROM(
SELECT T1.TT1_NOMBRECIRCUITO
      ,T.TC1_CODCIRC AS CIRCUITO
      , 'XXXX' AS ACTIVIDAD
      --, FDD_IUA AS CODIGO_CIR_TRA
      , T.CANT_USRS AS NUM_USRS      
      , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
      , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
      ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
FROM QA_TFDDREGISTRO R
LEFT OUTER JOIN (
                SELECT DISTINCT 
                       TC1_CODCONEX
                      ,TC1_CODCIRC
                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                FROM QA_TTC1
                WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                GROUP BY TC1_CODCONEX
                        ,TC1_CODCIRC
                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
AND FDD_CAUSA_SSPD IN ('14')
)
GROUP BY TT1_NOMBRECIRCUITO
        ,CIRCUITO
        ,FINICIAL
        ,FFINAL
        ,DURACION
        ,MES_EJECUCION;
--SEGUNDA PARTE SALE DE LA TABLA QA_TT11_REGISTRO, PORQUE NO SE EJECUTARON LAS CONFIRMADAS
--UNION ALL

WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)

(
    SELECT  AF.TT3_ID
          , AF.TT3_CIRCUITO
          , AF.TT3_IUL
          , TO_NUMBER(CASE WHEN(RG.TT11_TIPOPROYECTO='EXPANSION')  THEN '2'
                           WHEN(RG.TT11_TIPOPROYECTO='REPOSICION') THEN '1'                       
             END)                                          AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , TC.TC1_IUA                                     AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
)
UNION ALL
(
    SELECT  AF.TT3_ID
          , AF.TT3_CIRCUITO
          , AF.TT3_IUL
          , TO_NUMBER(CASE WHEN(RG.TT11_TIPOPROYECTO='EXPANSION')  THEN '2'
                           WHEN(RG.TT11_TIPOPROYECTO='REPOSICION') THEN '1'                       
             END)                                          AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , AF.TT3_IUL                                    AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                           ,CANT_USRS_C
                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
)
;



--GENERACION DEL FORMATO TT11 ABIRL 2022

EXEC QA_PTT11_REPORTE(TO_DATE('01/04/2022','DD/MM/YYYY'));

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/04/2022','DD/MM/YYYY');
;

SELECT * 
FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/04/2022','DD/MM/YYYY')
;

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO=1
  ,   TT11_FCERTIFICACION=SYSDATE
WHERE TT11_PERIODO_OP=TO_DATE('01/04/2022','DD/MM/YYYY')
;
COMMIT;


---INFORMACION PARA ENVIAR DEL TT11 ABIL 2022

WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = '202202'
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = '202202'
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)
( SELECT RG.TT11_ID AS ITEM
      , RG.TT11_SUBESTACION AS SUBESTACION
      , RG.TT11_IUS AS IUS
      , RG.TT11_FINICIAL AS FECHA_INICIAL
      , RG.TT11_FFINAL AS FECHA_FINAL
      , RG.TT11_DESCRIPCION AS DESCRIPCION
      , AF.TT3_CIRCUITO AS CIRCUITO
      , TC.CANT_USRS_C AS USUARIOS_AFECTADOS
      , TC.CANT_TRF AS TRANSFORAMDORES_AFECTADOS
FROM QA_TTT11_REGISTRO RG
LEFT OUTER JOIN QA_TTT3_AFECTACION AF ON AF.TT3_ID = RG.TT11_ID
LEFT OUTER JOIN (SELECT TC1_CODCIRC
                      ,COUNT(TC1_IUA) AS CANT_TRF
                      ,CANT_USRS_C
                  FROM TC1_CODIGOS
                  GROUP BY TC1_CODCIRC,CANT_USRS_C) TC ON TC.TC1_CODCIRC = AF.TT3_IUL
WHERE RG.TT11_PERIODO_OP=TO_DATE('01/04/2022','DD/MM/YYYY')
);




--GENERACION DE FORMATO TT12 DE MARZO 2022

WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)

(
    SELECT  AF.TT3_ID
          , AF.TT3_CIRCUITO
          , AF.TT3_IUL
          , TO_NUMBER(CASE WHEN(RG.TT11_TIPOPROYECTO='EXPANSION')  THEN '2'
                           WHEN(RG.TT11_TIPOPROYECTO='REPOSICION') THEN '1'                       
             END)                                          AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , TC.TC1_IUA                                     AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
)
UNION ALL
(
    SELECT  AF.TT3_ID
          , AF.TT3_CIRCUITO
          , AF.TT3_IUL
          , TO_NUMBER(CASE WHEN(RG.TT11_TIPOPROYECTO='EXPANSION')  THEN '2'
                           WHEN(RG.TT11_TIPOPROYECTO='REPOSICION') THEN '1'                       
             END)                                          AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , AF.TT3_IUL                                    AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM BRAE.QA_TTT11_REGISTRO RG
    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                           ,CANT_USRS_C
                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    WHERE RG.TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
);

SELECT * FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/03/2022','DD/MM/YYYY');



--GENERACION DEL FORMATO TT11 MAYO 2022

EXEC QA_PTT11_REPORTE(TO_DATE('01/05/2022','DD/MM/YYYY'));

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/05/2022','DD/MM/YYYY');
;

SELECT * 
FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/05/2022','DD/MM/YYYY')
;

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO=1
  ,   TT11_FCERTIFICACION=SYSDATE
WHERE TT11_PERIODO_OP=TO_DATE('01/05/2022','DD/MM/YYYY')
;
COMMIT;

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------


--GENERACION DE FORMATO TT12 DE ABRIL 2022

--*PARTE 2, CORRESPONDIENTE A LOS NO EJECUTADOS
WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)

(
    SELECT  TO_NUMBER(AF.TT3_ID)
          , AF.TT3_CIRCUITO
          , AF.TT3_IUL
          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , TC.TC1_IUA                                     AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
          AND TT11_ID <> 4) RG
    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    
)
UNION ALL
(
    SELECT  TO_NUMBER(AF.TT3_ID)
          , AF.TT3_CIRCUITO
          , AF.TT3_IUL
          , RG.TT11_ACTIVIDAD AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , AF.TT3_IUL                                    AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
          AND TT11_ID <> 4) RG
    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                           ,CANT_USRS_C
                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
)

UNION ALL
--*PARTE 1, CORRESPONDIENTE A LOS    EJECUTADOS
(
SELECT 4 AS TT3_ID
      , T1.TT1_NOMBRECIRCUITO
      , T.TC1_CODCIRC AS CIRCUITO
      , 1 AS ACTIVIDAD
      , FDD_IUA AS CODIGO_CIR_TRA
      , T.CANT_USRS AS NUM_USRS      
      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FINICIAL
      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FFINAL
      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
      ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
FROM QA_TFDDREGISTRO R
LEFT OUTER JOIN (
                SELECT DISTINCT 
                       TC1_CODCONEX
                      ,TC1_CODCIRC
                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                FROM QA_TTC1
                WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                GROUP BY TC1_CODCONEX
                        ,TC1_CODCIRC
                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
AND FDD_CAUSA_SSPD IN ('14')

UNION ALL

SELECT 4 AS TT3_ID
      ,TT1_NOMBRECIRCUITO
      ,CIRCUITO
      ,1 AS ACTIVIDAD
      ,CIRCUITO
      ,SUM(NUM_USRS) AS NUM_USRS
      ,TO_CHAR(FINICIAL,'DD-MM-YYYY HH24:MI') AS FINICIAL
      ,TO_CHAR(FFINAL,'DD-MM-YYYY HH24:MI') AS FFINAL
      ,DURACION
      ,MES_EJECUCION
FROM(
SELECT T1.TT1_NOMBRECIRCUITO
      ,T.TC1_CODCIRC AS CIRCUITO
      , 1 AS ACTIVIDAD
      --, FDD_IUA AS CODIGO_CIR_TRA
      , T.CANT_USRS AS NUM_USRS      
      , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
      , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
      ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
FROM QA_TFDDREGISTRO R
LEFT OUTER JOIN (
                SELECT DISTINCT 
                       TC1_CODCONEX
                      ,TC1_CODCIRC
                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                FROM QA_TTC1
                WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                GROUP BY TC1_CODCONEX
                        ,TC1_CODCIRC
                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
AND FDD_CAUSA_SSPD IN ('14')
)
GROUP BY TT1_NOMBRECIRCUITO
        ,CIRCUITO
        ,FINICIAL
        ,FFINAL
        ,DURACION
        ,MES_EJECUCION
)
;



-----------------------------------------------------------------GENERACION DEL FORMATO TT11 JUNIO 2022

EXEC QA_PTT11_REPORTE(TO_DATE('01/06/2022','DD/MM/YYYY'));

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/06/2022','DD/MM/YYYY');
;

SELECT * 
FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/06/2022','DD/MM/YYYY')
;

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO=1
  ,   TT11_FCERTIFICACION=SYSDATE
WHERE TT11_PERIODO_OP=TO_DATE('01/06/2022','DD/MM/YYYY')
;
COMMIT;

----TT11_VISTA PARA COMPARTIR INTERNAMENTE
SELECT  TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , LISTAGG (TT3_CIRCUITO, ',') WITHIN GROUP (ORDER BY TT3_CIRCUITO) AS CIRCUITOS
      , USRS_AFECT
      , CANT_TRAFOS
    FROM BRAE.QA_TTT11_REGISTRO 
    LEFT OUTER JOIN (SELECT TT3_ID, TT3_CIRCUITO FROM QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP=TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')
                     ) ON TT3_ID = TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID,SUM(TT11_USRS_AFECTADOS) AS USRS_AFECT FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=4
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID =TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID2,COUNT(TT11_USRS_AFECTADOS) AS CANT_TRAFOS FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=10
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID2=TT11_ID
    WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
    GROUP BY TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , USRS_AFECT
      , CANT_TRAFOS
    ORDER BY TT11_ID ;
    
----GENEARCION FORMATO TT12 MES DE MAYO

SELECT * FROM QA_TFDDREGISTRO
WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
AND FDD_CAUSA_SSPD IN ('14');


--*PARTE 2, CORRESPONDIENTE A LOS NO EJECUTADOS
WITH TC1_CODIGOS AS
(
    SELECT DISTINCT T1.TC1_CODCIRC
                ,T1.TC1_IUA
                ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                ,T2.CANT_USRS      AS CANT_USRS_C
    FROM   QA_TTC1 T1
    LEFT OUTER JOIN (
                     SELECT DISTINCT TC1_CODCIRC
                                 ,COUNT(TC1_CODCIRC) AS CANT_USRS
                     FROM   QA_TTC1
                     WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                     AND    TC1_TIPCONEX = 'T'
                     GROUP BY TC1_CODCIRC    
                     ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
    WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
    AND    T1.TC1_TIPCONEX = 'T'
    GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
)

(
    SELECT  TO_NUMBER(AF.TT3_ID)
          , AF.TT3_CIRCUITO
          , AF.TT3_IUL
          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , TC.TC1_IUA                                     AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
          AND TT11_ID <> 4) RG
    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
    
)
UNION ALL
(
    SELECT  TO_NUMBER(AF.TT3_ID)
          , AF.TT3_CIRCUITO
          , AF.TT3_IUL
          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
          , AF.TT3_IUL                                    AS CODIGOS_IUA_IUL --CRUCE TC1
          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
          AND TT11_ID <> 4) RG
    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                           ,CANT_USRS_C
                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
)
;





-----------------------------------------------------------------GENERACION DEL FORMATO TT11 JULIO 2022

EXEC QA_PTT11_REPORTE(TO_DATE('01/07/2022','DD/MM/YYYY'));

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/07/2022','DD/MM/YYYY');
;

SELECT * 
FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/07/2022','DD/MM/YYYY')
;

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO=1
  ,   TT11_FCERTIFICACION=SYSDATE
WHERE TT11_PERIODO_OP=TO_DATE('01/07/2022','DD/MM/YYYY')
;
COMMIT;

----TT11_VISTA PARA COMPARTIR INTERNAMENTE
SELECT  TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , LISTAGG (TT3_CIRCUITO, ',') WITHIN GROUP (ORDER BY TT3_CIRCUITO) AS CIRCUITOS
      , USRS_AFECT
      , CANT_TRAFOS
    FROM BRAE.QA_TTT11_REGISTRO 
    LEFT OUTER JOIN (SELECT TT3_ID, TT3_CIRCUITO FROM QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP=TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')
                     ) ON TT3_ID = TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID,SUM(TT11_USRS_AFECTADOS) AS USRS_AFECT FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=4
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID =TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID2,COUNT(TT11_USRS_AFECTADOS) AS CANT_TRAFOS FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=10
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID2=TT11_ID
    WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
    GROUP BY TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , USRS_AFECT
      , CANT_TRAFOS
    ORDER BY TT11_ID ;
    


--GENERACION DEL FORMATO TT12 JUNIO 2022


        --*PARTE 2, CORRESPONDIENTE A LOS NO EJECUTADOS
        WITH TC1_CODIGOS AS
        (
            SELECT DISTINCT T1.TC1_CODCIRC
                        ,T1.TC1_IUA
                        ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                        ,T2.CANT_USRS      AS CANT_USRS_C
            FROM   QA_TTC1 T1
            LEFT OUTER JOIN (
                             SELECT DISTINCT TC1_CODCIRC
                                         ,COUNT(TC1_CODCIRC) AS CANT_USRS
                             FROM   QA_TTC1
                             WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                             AND    TC1_TIPCONEX = 'T'
                             GROUP BY TC1_CODCIRC    
                             ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
            WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
            AND    T1.TC1_TIPCONEX = 'T'
            GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
        )
        
                (
                    SELECT  TO_NUMBER(AF.TT3_ID) AS TT3_ID
                          , AF.TT3_CIRCUITO
                          , AF.TT3_IUL
                          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
                          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
                          , TO_CHAR(TC.TC1_IUA)                                     AS CODIGOS_IUA_IUL --CRUCE TC1
                          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
                          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
                          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
                    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
                          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
                          AND TT11_ID <> 4) RG
                    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
                    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
                    
                )
        UNION ALL
                (
                    SELECT  TO_NUMBER(AF.TT3_ID) AS TT3_ID
                          , AF.TT3_CIRCUITO
                          , AF.TT3_IUL
                          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
                          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
                          , TO_CHAR(AF.TT3_IUL)                                    AS CODIGOS_IUA_IUL --CRUCE TC1
                          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
                          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
                          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
                    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
                          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
                          AND TT11_ID <> 4) RG
                    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
                    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                                           ,CANT_USRS_C
                                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
                )

UNION ALL
         --*PARTE 1, CORRESPONDIENTE A LOS    EJECUTADOS
                (
                SELECT (CASE WHEN (T1.TT1_NOMBRECIRCUITO LIKE 'ABR%') THEN (15) 
                             WHEN (T1.TT1_NOMBRECIRCUITO LIKE 'TIB%') THEN (37)
                        END) AS TT3_ID
                      ,T1.TT1_NOMBRECIRCUITO
                      , T.TC1_CODCIRC AS CIRCUITO
                      , 1 AS ACTIVIDAD
                      , FDD_IUA AS CODIGO_CIR_TRA
                      , T.CANT_USRS AS NUM_USRS      
                      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FINICIAL
                      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FFINAL
                      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                      ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
                FROM QA_TFDDREGISTRO R
                LEFT OUTER JOIN (
                                SELECT DISTINCT 
                                       TC1_CODCONEX
                                      ,TC1_CODCIRC
                                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                                FROM QA_TTC1
                                WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                                AND   TC1_TIPCONEX =  'T'
                                AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                                GROUP BY TC1_CODCONEX
                                        ,TC1_CODCIRC
                                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
                LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
                WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                AND FDD_CAUSA_SSPD IN ('14')
        
        UNION ALL
        
                SELECT (CASE WHEN (TT1_NOMBRECIRCUITO LIKE 'ABR%') THEN (15) 
                             WHEN (TT1_NOMBRECIRCUITO LIKE 'TIB%') THEN (37)
                        END) AS TT3_ID
                      ,TT1_NOMBRECIRCUITO
                      ,CIRCUITO
                      ,1 AS ACTIVIDAD
                      ,CIRCUITO
                      ,SUM(NUM_USRS) AS NUM_USRS
                      ,TO_CHAR(FINICIAL,'DD-MM-YYYY HH24:MI') AS FINICIAL
                      ,TO_CHAR(FFINAL,'DD-MM-YYYY HH24:MI') AS FFINAL
                      ,DURACION
                      ,MES_EJECUCION
                FROM(
                    SELECT T1.TT1_NOMBRECIRCUITO
                          ,T.TC1_CODCIRC AS CIRCUITO
                          , 1 AS ACTIVIDAD
                          --, FDD_IUA AS CODIGO_CIR_TRA
                          , T.CANT_USRS AS NUM_USRS      
                          , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
                          , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
                          , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                          - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                          ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
                    FROM QA_TFDDREGISTRO R
                    LEFT OUTER JOIN (
                                    SELECT DISTINCT 
                                           TC1_CODCONEX
                                          ,TC1_CODCIRC
                                          ,COUNT(TC1_CODCONEX) AS CANT_USRS
                                    FROM QA_TTC1
                                    WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                                    AND   TC1_TIPCONEX =  'T'
                                    AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                                    GROUP BY TC1_CODCONEX
                                            ,TC1_CODCIRC
                                     ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
                    LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
                    WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                    AND FDD_CAUSA_SSPD IN ('14')
                )
                GROUP BY TT1_NOMBRECIRCUITO
                        ,CIRCUITO
                        ,FINICIAL
                        ,FFINAL
                        ,DURACION
                        ,MES_EJECUCION
                )
        ;



-----------------------------------------------------------------GENERACION DEL FORMATO TT11 AGOSTO 2022

EXEC QA_PTT11_REPORTE(TO_DATE('01/08/2022','DD/MM/YYYY'));

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/08/2022','DD/MM/YYYY');
;

SELECT * 
FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/08/2022','DD/MM/YYYY')
;

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO=1
  ,   TT11_FCERTIFICACION=SYSDATE
WHERE TT11_PERIODO_OP=TO_DATE('01/08/2022','DD/MM/YYYY')
;
COMMIT;

----TT11_VISTA PARA COMPARTIR INTERNAMENTE
SELECT  TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , LISTAGG (TT3_CIRCUITO, ',') WITHIN GROUP (ORDER BY TT3_CIRCUITO) AS CIRCUITOS
      , USRS_AFECT
      , CANT_TRAFOS
    FROM BRAE.QA_TTT11_REGISTRO 
    LEFT OUTER JOIN (SELECT TT3_ID, TT3_CIRCUITO FROM QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP=TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')
                     ) ON TT3_ID = TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID,SUM(TT11_USRS_AFECTADOS) AS USRS_AFECT FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=4
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID =TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID2,COUNT(TT11_USRS_AFECTADOS) AS CANT_TRAFOS FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=10
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID2=TT11_ID
    WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
    GROUP BY TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , USRS_AFECT
      , CANT_TRAFOS
    ORDER BY TT11_ID ;
    
    

SELECT * FROM QA_TTT3_REGISTRO
WHERE TT3_PERIODO_OP=DATE'2022-01-01';

UPDATE QA_TTT11_REGISTRO
SET TT11_FMODIFICACION =  NULL
;
COMMIT;

ALTER TABLE QA_TTT11_REGISTRO
RENAME COLUMN TT11_FMODIFICACION TO TT11_EJECUTADO;

SELECT * FROM QA_TTT11_REGISTRO;


ALTER TABLE QA_TTT11_REGISTRO
MODIFY TT11_EJECUTADO NUMBER;


UPDATE QA_TTT11_REGISTRO
SET TT11_EJECUTADO =  0
;


ALTER TABLE QA_TTT3_REGISTRO
MODIFY TT3_EJECUTADO NUMBER;


UPDATE QA_TTT3_REGISTRO
SET TT3_EJECUTADO =  0;

COMMIT;


SELECT * FROM QA_TTT3_AFECTACION WHERE TT3_PERIODO_OP=DATE'2023-01-01';
SELECT * FROM QA_TTT3_REGISTRO WHERE TT3_PERIODO_OP=DATE'2023-01-01';
SELECT * FROM QA_TTT11_REGISTRO WHERE TT11_PERIODO_OP=DATE'2023-01-01';

DELETE FROM QA_TTT3_AFECTACION WHERE TT3_PERIODO_OP=DATE'2023-01-01';
DELETE FROM QA_TTT3_REGISTRO WHERE TT3_PERIODO_OP=DATE'2023-01-01';
DELETE FROM QA_TTT11_REGISTRO WHERE TT11_PERIODO_OP=DATE'2023-01-01';

COMMIT;


SELECT * FROM QA_TTT3_REPORTE
WHERE TT3_PERIODO_OP=DATE'2023-01-01';

SELECT * FROM QA_tTT3_REGISTRO;


SELECT * FROM QA_TTT3_REGISTRO 
    WHERE TT3_PERIODO_OP =  DATE'2023-01-01'
    ;--AND   TT3_CERTIFICADO = 0;


  UPDATE QA_TTT3_REGISTRO 
    SET   TT3_CERTIFICADO = 1
         ,TT3_FCERTIFICACION = SYSDATE
    WHERE TT3_PERIODO_OP =  DATE'2023-01-01'
    AND   TT3_CERTIFICADO = 0;
    



SELECT TT3_IUS
   ,TT3_CLASIFICACION
   ,TT3_IUA
   ,TO_CHAR(TT3_FINICIAL,'DD-MM-YYYY HH24:MI')
   ,TO_CHAR(TT3_FFINAL  ,'DD-MM-YYYY HH24:MI')
   ,TT3_DESCRIPCION
   ,TT3_CODIGOPROYECTO
   ,TT3_IDMERCADO
FROM BRAE.QA_TTT3_REPORTE QA
WHERE TT3_PERIODO_OP = DATE'';




--***********************************************GENERACION DEL FORMATO TT12 JULIO 2022

SELECT * FROM QA_TTT1_REGISTRO;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202207
AND TC1_TIPCONEX<>'P'
AND TC1_CODCONEX NOT LIKE 'ALPM%'
;--AND TC1_CODCIRC = 'NA';


UPDATE QA_TTC1 T
SET   TC1_CODCIRC = (SELECT DISTINCT TC1_CODCIRC FROM QA_TTC1 WHERE TC1_PERIODO=202205 AND TC1_TC1 = T.TC1_TC1)
WHERE TC1_PERIODO=202207
AND TC1_TIPCONEX<>'P'
AND TC1_CODCONEX NOT LIKE 'ALPM%'
AND TC1_CODCIRC = 'NA';




SELECT * FROM QA_TTC1 WHERE TC1_PERIODO=202206
AND TC1_TC1 IN (
SELECT TC1_TC1 FROM QA_TTC1
WHERE TC1_PERIODO=202207
AND TC1_TIPCONEX<>'P'
AND TC1_CODCONEX NOT LIKE 'ALPM%'
AND TC1_CODCIRC = 'NA'
);

SELECT * FROM QA_TTC1 
WHERE TC1_PERIODO=202206
AND TC1_TC1 = '1046636'
AND TC1_CODCONEX NOT LIKE 'STN%'
;


DELETE FROM QA_TTC1 
WHERE TC1_PERIODO=202206
AND TC1_TC1 = '1046636'
AND TC1_CODCONEX NOT LIKE 'STN%'
;

COMMIT;




--********************
        --*PARTE 2, CORRESPONDIENTE A LOS NO EJECUTADOS
SELECT   TO_NUMBER(TT3_ID)	AS	TT3_ID
        ,TO_CHAR(NOMBRE_CIRCUITO)	AS	NOMBRE_CIRCUITO
        ,TO_CHAR(CIRCUITO)	AS	CIRCUITO
        ,TO_NUMBER(ACTIVIDAD)	AS	ACTIVIDAD
        ,TO_CHAR(CODIGO_IUA_IUL)	AS	CODIGO_IUA_IUL
        ,TO_NUMBER(USUARIOS_AFECTADOS)	AS	USUARIOS_AFECTADOS
        ,FECHA_INICIAL	AS	FECHA_INICIAL
        ,FECHA_FINAL	AS	FECHA_FINAL
        ,TO_CHAR(DURACION)	AS	DURACION
        ,TO_CHAR(MES_EJECUCION)	AS	MES_EJECUCION 
     FROM(        
        WITH TC1_CODIGOS AS
        (
            SELECT DISTINCT T1.TC1_CODCIRC
                        ,T1.TC1_IUA
                        ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                        ,T2.CANT_USRS      AS CANT_USRS_C
            FROM   QA_TTC1 T1
            LEFT OUTER JOIN (
                             SELECT DISTINCT TC1_CODCIRC
                                         ,COUNT(TC1_CODCIRC) AS CANT_USRS
                             FROM   QA_TTC1
                             WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                             AND    TC1_TIPCONEX = 'T'
                             GROUP BY TC1_CODCIRC    
                             ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
            WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
            AND    T1.TC1_TIPCONEX = 'T'
            GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
        )
        
                (
                    SELECT  TO_NUMBER(AF.TT3_ID) AS TT3_ID
                          , AF.TT3_CIRCUITO NOMBRE_CIRCUITO
                          , AF.TT3_IUL AS CIRCUITO
                          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
                          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
                          , TO_CHAR(TC.TC1_IUA)                                     AS CODIGO_IUA_IUL --CRUCE TC1
                          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
                          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
                          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
                    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
                          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
                          AND TT11_ID <> 4) RG
                    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
                    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
                    
                )
        UNION ALL
                (
                    SELECT  TO_NUMBER(AF.TT3_ID) AS TT3_ID
                          , AF.TT3_CIRCUITO
                          , AF.TT3_IUL
                          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
                          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
                          , TO_CHAR(AF.TT3_IUL)                                    AS CODIGOS_IUA_IUL --CRUCE TC1
                          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
                          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
                          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
                    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
                          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
                          AND TT11_ID <> 4) RG
                    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
                    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                                           ,CANT_USRS_C
                                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
                )
)
WHERE TT3_ID = 3
UNION ALL
         --*PARTE 1, CORRESPONDIENTE A LOS    EJECUTADOS
SELECT   TO_NUMBER(TT3_ID)	AS	TT3_ID
        ,TO_CHAR(NOMBRE_CIRCUITO)	AS	NOMBRE_CIRCUITO
        ,TO_CHAR(CIRCUITO)	AS	CIRCUITO
        ,TO_NUMBER(ACTIVIDAD)	AS	ACTIVIDAD
        ,TO_CHAR(CODIGO_IUA_IUL)	AS	CODIGO_IUA_IUL
        ,TO_NUMBER(USUARIOS_AFECTADOS)	AS	USUARIOS_AFECTADOS
        ,FECHA_INICIAL	AS	FECHA_INICIAL
        ,FECHA_FINAL	AS	FECHA_FINAL
        ,TO_CHAR(DURACION)	AS	DURACION
        ,TO_CHAR(MES_EJECUCION)	AS	MES_EJECUCION 
FROM            (
                SELECT (CASE WHEN (T1.TT1_NOMBRECIRCUITO IN  ('CONS65','CONSAL_CARMEN','CONSAL_CONVE','CONSAL_SANPABLO','CONSAL_TEORA','TARC1','TARC2'))    THEN (3) 
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('TIBPOZOS','TIBTIBU1','TIBTIBU2','TIBTIBU3')) THEN (5)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('AGUC2','AGUC3','AGUC4','AGUC5','AGUC7','AGUC8','AGUGAMA','AGUIG5')) THEN (26)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('ABRC1','ABRC2','OCAILA5')) THEN (41)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('OCAGONZALES','OCALA_PLAYA','OCAOCANA1','OCAOCANA2','OCAOCANA3')) THEN (44)
                        END) AS TT3_ID
                      ,T1.TT1_NOMBRECIRCUITO AS NOMBRE_CIRCUITO
                      , T.TC1_CODCIRC AS CIRCUITO
                      , 1 AS ACTIVIDAD
                      , FDD_IUA AS CODIGO_IUA_IUL
                      , T.CANT_USRS AS USUARIOS_AFECTADOS      
                      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                      ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
                FROM QA_TFDDREGISTRO R
                LEFT OUTER JOIN (
                                SELECT DISTINCT 
                                       TC1_CODCONEX
                                      ,TC1_CODCIRC
                                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                                FROM QA_TTC1
                                WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                                AND   TC1_TIPCONEX =  'T'
                                AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                                GROUP BY TC1_CODCONEX
                                        ,TC1_CODCIRC
                                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
                LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
                WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                AND FDD_CAUSA_SSPD IN ('14')
        
        UNION ALL
        
                SELECT (CASE WHEN (TT1_NOMBRECIRCUITO IN  ('CONS65','CONSAL_CARMEN','CONSAL_CONVE','CONSAL_SANPABLO','CONSAL_TEORA','TARC1','TARC2'))    THEN (3) 
                             WHEN (TT1_NOMBRECIRCUITO IN  ('TIBPOZOS','TIBTIBU1','TIBTIBU2','TIBTIBU3')) THEN (5)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('AGUC2','AGUC3','AGUC4','AGUC5','AGUC7','AGUC8','AGUGAMA','AGUIG5')) THEN (26)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('ABRC1','ABRC2','OCAILA5')) THEN (41)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('OCAGONZALES','OCALA_PLAYA','OCAOCANA1','OCAOCANA2','OCAOCANA3')) THEN (44)
                        END) AS TT3_ID
                      ,TT1_NOMBRECIRCUITO
                      ,CIRCUITO
                      ,1 AS ACTIVIDAD
                      ,CIRCUITO
                      ,SUM(NUM_USRS) AS NUM_USRS
                      ,TO_CHAR(FINICIAL,'DD-MM-YYYY HH24:MI') AS FINICIAL
                      ,TO_CHAR(FFINAL,'DD-MM-YYYY HH24:MI') AS FFINAL
                      ,DURACION
                      ,MES_EJECUCION
                FROM(
                    SELECT T1.TT1_NOMBRECIRCUITO
                          ,T.TC1_CODCIRC AS CIRCUITO
                          , 1 AS ACTIVIDAD
                          --, FDD_IUA AS CODIGO_CIR_TRA
                          , T.CANT_USRS AS NUM_USRS      
                          , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
                          , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
                          , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                          - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                          ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
                    FROM QA_TFDDREGISTRO R
                    LEFT OUTER JOIN (
                                    SELECT DISTINCT 
                                           TC1_CODCONEX
                                          ,TC1_CODCIRC
                                          ,COUNT(TC1_CODCONEX) AS CANT_USRS
                                    FROM QA_TTC1
                                    WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                                    AND   TC1_TIPCONEX =  'T'
                                    AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                                    GROUP BY TC1_CODCONEX
                                            ,TC1_CODCIRC
                                     ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
                    LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
                    WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                    AND FDD_CAUSA_SSPD IN ('14')
                )
                GROUP BY TT1_NOMBRECIRCUITO
                        ,CIRCUITO
                        ,FINICIAL
                        ,FFINAL
                        ,DURACION
                        ,MES_EJECUCION
                )
        ;



/**********************************************************************************************************************************************************
*----------------------------------------------------------------GENERACION DEL FORMATO TT11 SEPTIEMBRE 2022----------------------------------------------*
***********************************************************************************************************************************************************/

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP = DATE'2022-09-01'
AND TT11_ID NOT IN (47,48,50);


UPDATE QA_TTT11_REGISTRO
SET TT11_FINICIAL = ADD_MONTHS(TT11_FINICIAL,1) 
   ,TT11_FFINAL =  ADD_MONTHS(TT11_FFINAL,1) 
   ,TT11_PERIODO_OP = DATE'2022-10-01'
WHERE TT11_PERIODO_OP = DATE'2022-09-01'
AND TT11_ID NOT IN (47,48,50);


COMMIT;

SELECT ADD_MONTHS(SYSDATE,-1) AS MONTH FROM DUAL;


--ECXECUTION OF PROCEDURE
EXEC QA_PTT11_REPORTE(TO_DATE('01/09/2022','DD/MM/YYYY'));

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/09/2022','DD/MM/YYYY');
;

SELECT * 
FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/09/2022','DD/MM/YYYY')
;

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO=1
  ,   TT11_FCERTIFICACION=SYSDATE
WHERE TT11_PERIODO_OP=TO_DATE('01/09/2022','DD/MM/YYYY')
;
COMMIT;


SELECT * FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=DATE'2022-09-01';


DELETE FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=DATE'2022-09-01';

COMMIT;


SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP = DATE'2022-09-01'
;


UPDATE QA_TTT11_REGISTRO
SET  TT11_FINICIAL = TO_DATE('29/09/2022 04:00:00','DD/MM/YYYY HH24:MI:SS')
    ,TT11_FFINAL = TO_DATE('29/09/2022 23:59:00','DD/MM/YYYY HH24:MI:SS')
WHERE TT11_PERIODO_OP = DATE'2022-09-01'
AND TT11_ID=50;


COMMIT;


--ECXECUTION OF PROCEDURE
EXEC QA_PTT11_REPORTE(TO_DATE('01/09/2022','DD/MM/YYYY'));

SELECT * 
FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/09/2022','DD/MM/YYYY')
;

------------------------------------------------------------------------------------------------END TT11_JUN_2022


/**********************************************************************************************************************************************************
*----------------------------------------------------------------GENERACION DEL FORMATO TT12 AGOSTO 2022    ----------------------------------------------*
***********************************************************************************************************************************************************/



SELECT * FROM QA_TTT1_REGISTRO;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202208
AND TC1_TIPCONEX<>'P'
AND TC1_CODCONEX NOT LIKE 'ALPM%'
and tc1_tc1='1046636'
;--AND TC1_CODCIRC = 'NA';


UPDATE QA_TTC1 T
SET   TC1_CODCIRC = (SELECT DISTINCT TC1_CODCIRC FROM QA_TTC1 WHERE TC1_PERIODO=202207 AND TC1_TC1 = T.TC1_TC1)
WHERE TC1_PERIODO=202208
AND TC1_TIPCONEX<>'P'
AND TC1_CODCONEX NOT LIKE 'ALPM%'
AND TC1_CODCIRC = 'NA';


delete QA_TTC1
WHERE TC1_PERIODO=202208
AND TC1_TIPCONEX<>'P'
AND TC1_CODCONEX NOT LIKE 'ALPM%'
and tc1_tc1='1046636';

COMMIT;



COMMIT;




--********************
        --*PARTE 2, CORRESPONDIENTE A LOS NO EJECUTADOS
SELECT   TO_NUMBER(TT3_ID)	AS	TT3_ID
        ,TO_CHAR(NOMBRE_CIRCUITO)	AS	NOMBRE_CIRCUITO
        ,TO_CHAR(CIRCUITO)	AS	CIRCUITO
        ,TO_NUMBER(ACTIVIDAD)	AS	ACTIVIDAD
        ,TO_CHAR(CODIGO_IUA_IUL)	AS	CODIGO_IUA_IUL
        ,TO_NUMBER(USUARIOS_AFECTADOS)	AS	USUARIOS_AFECTADOS
        ,FECHA_INICIAL	AS	FECHA_INICIAL
        ,FECHA_FINAL	AS	FECHA_FINAL
        ,TO_CHAR(DURACION)	AS	DURACION
        ,TO_CHAR(MES_EJECUCION)	AS	MES_EJECUCION 
     FROM(        
        WITH TC1_CODIGOS AS
        (
            SELECT DISTINCT T1.TC1_CODCIRC
                        ,T1.TC1_IUA
                        ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                        ,T2.CANT_USRS      AS CANT_USRS_C
            FROM   QA_TTC1 T1
            LEFT OUTER JOIN (
                             SELECT DISTINCT TC1_CODCIRC
                                         ,COUNT(TC1_CODCIRC) AS CANT_USRS
                             FROM   QA_TTC1
                             WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                             AND    TC1_TIPCONEX = 'T'
                             GROUP BY TC1_CODCIRC    
                             ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
            WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
            AND    T1.TC1_TIPCONEX = 'T'
            GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
        )
        
                (
                    SELECT  TO_NUMBER(AF.TT3_ID) AS TT3_ID
                          , AF.TT3_CIRCUITO NOMBRE_CIRCUITO
                          , AF.TT3_IUL AS CIRCUITO
                          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
                          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
                          , TO_CHAR(TC.TC1_IUA)                                     AS CODIGO_IUA_IUL --CRUCE TC1
                          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
                          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                          ,    AS DURACION
                          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
                    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
                          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
                          AND TT11_ID <> 4) RG
                    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
                    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
                    
                )
        UNION ALL
                (
                    SELECT  TO_NUMBER(AF.TT3_ID) AS TT3_ID
                          , AF.TT3_CIRCUITO
                          , AF.TT3_IUL
                          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
                          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
                          , TO_CHAR(AF.TT3_IUL)                                    AS CODIGOS_IUA_IUL --CRUCE TC1
                          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
                          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
                          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
                    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
                          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
                          AND TT11_ID <> 4) RG
                    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
                    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                                           ,CANT_USRS_C
                                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
                )
)
WHERE TT3_ID = 3
UNION ALL
         --*PARTE 1, CORRESPONDIENTE A LOS    EJECUTADOS
SELECT   TO_NUMBER(TT3_ID)	AS	TT3_ID
        ,TO_CHAR(NOMBRE_CIRCUITO)	AS	NOMBRE_CIRCUITO
        ,TO_CHAR(CIRCUITO)	AS	CIRCUITO
        ,TO_NUMBER(ACTIVIDAD)	AS	ACTIVIDAD
        ,TO_CHAR(CODIGO_IUA_IUL)	AS	CODIGO_IUA_IUL
        ,TO_NUMBER(USUARIOS_AFECTADOS)	AS	USUARIOS_AFECTADOS
        ,FECHA_INICIAL	AS	FECHA_INICIAL
        ,FECHA_FINAL	AS	FECHA_FINAL
        ,TO_CHAR(DURACION)	AS	DURACION
        ,TO_CHAR(MES_EJECUCION)	AS	MES_EJECUCION 
FROM            (
                SELECT (CASE WHEN (T1.TT1_NOMBRECIRCUITO IN  ('CONS65','CONSAL_CARMEN','CONSAL_CONVE','CONSAL_SANPABLO','CONSAL_TEORA','TARC1','TARC2'))    THEN (3) 
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('TIBPOZOS','TIBTIBU1','TIBTIBU2','TIBTIBU3')) THEN (5)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('AGUC2','AGUC3','AGUC4','AGUC5','AGUC7','AGUC8','AGUGAMA','AGUIG5')) THEN (26)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('ABRC1','ABRC2','OCAILA5')) THEN (41)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('OCAGONZALES','OCALA_PLAYA','OCAOCANA1','OCAOCANA2','OCAOCANA3')) THEN (44)
                        END) AS TT3_ID
                      ,T1.TT1_NOMBRECIRCUITO AS NOMBRE_CIRCUITO
                      , T.TC1_CODCIRC AS CIRCUITO
                      , 1 AS ACTIVIDAD
                      , FDD_IUA AS CODIGO_IUA_IUL
                      , T.CANT_USRS AS USUARIOS_AFECTADOS      
                      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                      ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
                FROM QA_TFDDREGISTRO R
                LEFT OUTER JOIN (
                                SELECT DISTINCT 
                                       TC1_CODCONEX
                                      ,TC1_CODCIRC
                                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                                FROM QA_TTC1
                                WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                                AND   TC1_TIPCONEX =  'T'
                                AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                                GROUP BY TC1_CODCONEX
                                        ,TC1_CODCIRC
                                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
                LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
                WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                AND FDD_CAUSA_SSPD IN ('14')
        
        UNION ALL
        
                SELECT (CASE WHEN (TT1_NOMBRECIRCUITO IN  ('CONS65','CONSAL_CARMEN','CONSAL_CONVE','CONSAL_SANPABLO','CONSAL_TEORA','TARC1','TARC2'))    THEN (3) 
                             WHEN (TT1_NOMBRECIRCUITO IN  ('TIBPOZOS','TIBTIBU1','TIBTIBU2','TIBTIBU3')) THEN (5)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('AGUC2','AGUC3','AGUC4','AGUC5','AGUC7','AGUC8','AGUGAMA','AGUIG5')) THEN (26)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('ABRC1','ABRC2','OCAILA5')) THEN (41)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('OCAGONZALES','OCALA_PLAYA','OCAOCANA1','OCAOCANA2','OCAOCANA3')) THEN (44)
                        END) AS TT3_ID
                      ,TT1_NOMBRECIRCUITO
                      ,CIRCUITO
                      ,1 AS ACTIVIDAD
                      ,CIRCUITO
                      ,SUM(NUM_USRS) AS NUM_USRS
                      ,TO_CHAR(FINICIAL,'DD-MM-YYYY HH24:MI') AS FINICIAL
                      ,TO_CHAR(FFINAL,'DD-MM-YYYY HH24:MI') AS FFINAL
                      ,DURACION
                      ,MES_EJECUCION
                FROM(
                    SELECT T1.TT1_NOMBRECIRCUITO
                          ,T.TC1_CODCIRC AS CIRCUITO
                          , 1 AS ACTIVIDAD
                          --, FDD_IUA AS CODIGO_CIR_TRA
                          , T.CANT_USRS AS NUM_USRS      
                          , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
                          , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
                          , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                          - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                          ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
                    FROM QA_TFDDREGISTRO R
                    LEFT OUTER JOIN (
                                    SELECT DISTINCT 
                                           TC1_CODCONEX
                                          ,TC1_CODCIRC
                                          ,COUNT(TC1_CODCONEX) AS CANT_USRS
                                    FROM QA_TTC1
                                    WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                                    AND   TC1_TIPCONEX =  'T'
                                    AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                                    GROUP BY TC1_CODCONEX
                                            ,TC1_CODCIRC
                                     ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
                    LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
                    WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                    AND FDD_CAUSA_SSPD IN ('14')
                )
                GROUP BY TT1_NOMBRECIRCUITO
                        ,CIRCUITO
                        ,FINICIAL
                        ,FFINAL
                        ,DURACION
                        ,MES_EJECUCION
                )
        ;



/**********************************************************************************************************************************************************
*----------------------------------------------------------------GENERACION DEL FORMATO TT11 OCTUBRE 2022-------------------------------------------------*
***********************************************************************************************************************************************************/

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP = DATE'2022-10-01'
;


--ECXECUTION OF PROCEDURE
EXEC QA_PTT11_REPORTE(TO_DATE('01/11/2022','DD/MM/YYYY'));

SELECT * 
FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=TO_DATE('01/10/2022','DD/MM/YYYY');
;

SELECT * 
FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=TO_DATE('01/11/2022','DD/MM/YYYY')
;

UPDATE QA_TTT11_REGISTRO
SET   TT11_CERTIFICADO=1
  ,   TT11_FCERTIFICACION=SYSDATE
WHERE TT11_PERIODO_OP=TO_DATE('01/10/2022','DD/MM/YYYY')
;
COMMIT;


SELECT * FROM QA_TTT11_REPORTE
WHERE TT11_PERIODO_OP=DATE'2022-10-01';



--TT11 SHARED


SELECT  TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , LISTAGG (TT3_CIRCUITO, ',') WITHIN GROUP (ORDER BY TT3_CIRCUITO) AS CIRCUITOS
      , USRS_AFECT
      , CANT_TRAFOS
    FROM BRAE.QA_TTT11_REGISTRO 
    LEFT OUTER JOIN (SELECT TT3_ID, TT3_CIRCUITO FROM QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP=TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')
                     ) ON TT3_ID = TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID,SUM(TT11_USRS_AFECTADOS) AS USRS_AFECT FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=4
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID =TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID2,COUNT(TT11_USRS_AFECTADOS) AS CANT_TRAFOS FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=10
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID2=TT11_ID
    WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
    GROUP BY TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , USRS_AFECT
      , CANT_TRAFOS
    ORDER BY TT11_ID;
    
    SELECT * FROM QA_TTT11_REGISTRO
    WHERE TT11_PERIODO_OP=DATE'2022-03-01';
    
    SELECT * FROM QA_TTT3_REGISTRO
    WHERE TT3_PERIODO_OP=DATE'2022-01-01';
    
    
    UPDATE QA_TTT3_REGISTRO
    SET TT3_CERTIFICADO = 1
    WHERE TT3_PERIODO_OP=DATE'2022-01-01';
    
    COMMIT;
    
    SELECT * FROM QA_TTT3_REGISTRO
    WHERE TT3_PERIODO_OP=DATE'2022-01-01'
    AND TT3_ID IN ('4',	'5',	'12',	'15',	'26',	'37',	'41',	'44');
    
    
    UPDATE QA_TTT3_REGISTRO
    SET TT3_EJECUTADO=1
    WHERE TT3_PERIODO_OP=DATE'2022-01-01'
    AND TT3_ID IN ('4',	'5',	'12',	'15',	'26',	'37',	'41',	'44');
    COMMIT;
    
    
                  SELECT TO_CHAR(TT3_PERIODO_OP,'DD/MM/YYYY') AS PERIODO
                          ,TT3_ID AS ID_DESCONEXION
                          ,TT3_DESCRIPCION AS DESCRIPCION
                          ,TO_CHAR(TT3_FINICIAL,'DD/MM/YYYY HH24:MI') AS FECHA_INICIAL
                          ,TO_CHAR(TT3_FFINAL,'DD/MM/YYYY HH24:MI') AS FECHA_FINAL
                          ,TT3_SUBESTACION AS SUB_ESTACION
                          ,TT3_IUS AS IUS
                          ,TT3_CODIGOPROYECTO AS CODIGO_DE_PROYECTO
                          ,TT3_ALCANCE AS ALCANCE
                          ,TT3_CERTIFICADO AS CERTIFICADO
                          ,TT3_EJECUTADO AS EJECUTADO
                          ,TT3_FCERTIFICACION AS FECHA_CERTIFICACION
                          ,TT3_FCREACION AS FECHA_CRAECION
                          ,TT3_TIPOPROYECTO
                    FROM BRAE.QA_TTT3_REGISTRO
                    --WHERE TT11_PERIODO_OP = TO_DATE(TO_CHAR('" & Format(FDD_PERIODO_OP.Value(), "dd/MM/yyyy") & "'),'DD/MM/YYYY')
                    WHERE TT3_PERIODO_OP = DATE'2022-01-01'
                    AND TT3_EJECUTADO = 0
                    ORDER BY TT3_ID;

SELECT TRUNC(SYSDATE,'YYYY') FROM DUAL;


DELETE FROM QA_TTT11_REGISTRO;
commit;

INSERT INTO QA_TTT11_REGISTRO
SELECT * FROM QA_TTT3_REGISTRO
WHERE TT3_ID ='3'
AND TT3_PERIODO_OP = DATE'2022-01-01';

SELECT * FROM QA_TTT11_REGISTRO;


SELECT COUNT(TT11_ID) AS CANTIDAD 
FROM QA_TTT11_REGISTRO
WHERE TT11_ID = '1';

SELECT DISTINCT(TT11_PERIODO_OP) FROM QA_tTT11_REPORTE; --

DELETE FROM QA_TTT11_REGISTRO;

SELECT MAX(TT2_PERIODO_OP) FROM QA_TTT2_BACKUP;


SELECT * FROM QA_TTT2_REGISTRO;


--No coincide periodo con fechas de programacion.

--ha seleccionado un periodo diferente al periodo de programacion

SELECT COUNT(DISTINCT X) AS CANTIDAD
FROM(
    SELECT DISTINCT TRUNC(TT11_PERIODO_OP) AS X FROM QA_TTT11_REGISTRO
    UNION
    SELECT DISTINCT TRUNC(TT11_FINICIAL,'MM')AS X FROM QA_TTT11_REGISTRO
    UNION
    SELECT DISTINCT TRUNC(TT11_FFINAL,'MM') AS X FROM QA_TTT11_REGISTRO
    );
    
    SELECT DISTINCT TT11_PERIODO_OP FROM QA_TTT11_REGISTRO;



SELECT * FROM QA_TTT3_REGISTRO;


UPDATE QA_TTT3_REGISTRO
SET TT3_TIPOPROYECTO = 'MODERNIZACION'
WHERE TT3_TIPOPROYECTO = 'EXPANSION';

SELECT * FROM QA_TTT3_REGISTRO
WHERE TT3_TIPOPROYECTO = 'EXPANSION';

COMMIT;


SELECT * FROM QA_TTT11_REPORTE;


SELECT TT11_ID
,	TT11_ACTIVIDAD
,	TT11_OBJETIVO
,	TT11_FINICIAL
,	TT11_FFINAL
,	TT11_DURACION
,   LISTAGG (TT3_CIRCUITO, ',') WITHIN GROUP (ORDER BY TT3_CIRCUITO) AS CIRCUITOS
FROM(
    SELECT DISTINCT TT11_ID
    ,	TT11_ACTIVIDAD
    ,	TT11_OBJETIVO
    ,	TT11_FINICIAL
    ,	TT11_FFINAL
    ,	TT11_DURACION
    ,   TT3_CIRCUITO
    FROM QA_TTT11_REPORTE
    LEFT OUTER JOIN (SELECT * FROM QA_TTT3_AFECTACION WHERE TT3_PERIODO_OP=DATE'2022-01-01') ON TT3_ID = TT11_ID
    WHERE TT11_PERIODO_OP=DATE'2022-10-01'
    )
GROUP BY TT11_ID
,	TT11_ACTIVIDAD
,	TT11_OBJETIVO
,	TT11_FINICIAL
,	TT11_FFINAL
,	TT11_DURACION
;




                    
                    


SELECT  TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , LISTAGG (TT3_CIRCUITO, ',') WITHIN GROUP (ORDER BY TT3_CIRCUITO) AS CIRCUITOS
      , USRS_AFECT
      , CANT_TRAFOS
    FROM BRAE.QA_TTT11_REGISTRO 
    LEFT OUTER JOIN (SELECT TT3_ID, TT3_CIRCUITO FROM QA_TTT3_AFECTACION
                     WHERE TT3_PERIODO_OP=TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')
                     ) ON TT3_ID = TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID,SUM(TT11_USRS_AFECTADOS) AS USRS_AFECT FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=4
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID =TT11_ID
    LEFT OUTER JOIN (
                     SELECT TT11_ID AS CODIGO_ID2,COUNT(TT11_USRS_AFECTADOS) AS CANT_TRAFOS FROM QA_TTT11_REPORTE
                     WHERE TT11_PERIODO_OP=TO_DATE(:PERIODO,'DD/MM/YYYY')
                     AND LENGTH(TT11_CODE_IUA_IUL)=10
                     GROUP BY TT11_ID    
                     ) ON CODIGO_ID2=TT11_ID
    WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')
    GROUP BY TT11_ID
      , TT11_SUBESTACION
      , TT11_IUS
      , TT11_FINICIAL
      , TT11_FFINAL
      , TT11_DESCRIPCION
      , USRS_AFECT
      , CANT_TRAFOS
    ORDER BY TT11_ID;


SELECT TT11_ID
                    ,	TT11_ACTIVIDAD
                    ,	TT11_OBJETIVO
                    ,	TT11_FINICIAL
                    ,	TT11_FFINAL
                    ,	TT11_DURACION
                    ,   LISTAGG (TT3_CIRCUITO, ',') WITHIN GROUP (ORDER BY TT3_CIRCUITO) AS CIRCUITOS
                    FROM(
                        SELECT DISTINCT TT11_ID
                        ,	TT11_ACTIVIDAD
                        ,	TT11_OBJETIVO
                        ,	TT11_FINICIAL
                        ,	TT11_FFINAL
                        ,	TT11_DURACION
                        ,   TT3_CIRCUITO
                        FROM QA_TTT11_REPORTE
                        LEFT OUTER JOIN (SELECT *  
                                         FROM QA_TTT3_AFECTACION 
                                         WHERE TT3_PERIODO_OP=DATE'2022-01-01')
                                         ON TT3_ID = TT11_ID
                        WHERE TT11_PERIODO_OP=DATE'2022-07-01'
                        )
                    GROUP BY TT11_ID
                    ,	TT11_ACTIVIDAD
                    ,	TT11_OBJETIVO
                    ,	TT11_FINICIAL
                    ,	TT11_FFINAL
                    ,	TT11_DURACION;
                    
                    
SELECT CODIGOEVENTO
      ,FINICIAL
      ,FFINAL
      ,DURACION
      ,LISTAGG (NOMBRECIRCUITO, ',') WITHIN GROUP (ORDER BY NOMBRECIRCUITO) AS CIRCUITOS
          FROM(
                SELECT DISTINCT FDD_CODIGOEVENTO AS CODIGOEVENTO
                      ,  TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
                      , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
                      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                      , TT1_NOMBRECIRCUITO AS NOMBRECIRCUITO
                FROM QA_TFDDREGISTRO R
                LEFT OUTER JOIN (SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION') ON TT2_CODIGOELEMENTO = FDD_CODIGOELEMENTO
                LEFT OUTER JOIN QA_TTT1_REGISTRO ON TT1_CODIGOCIRCUITO = TT2_IUL
                WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                AND FDD_CAUSA_SSPD IN ('14')
                AND TT1_NOMBRECIRCUITO IS NOT NULL
             )
WHERE CODIGOEVENTO = '930827'             
GROUP BY CODIGOEVENTO
      ,FINICIAL
      ,FFINAL
      ,DURACION
;




SELECT DISTINCT FDD_CODIGOEVENTO AS CODIGOEVENTO
,  TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
, TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
, ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
- TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                FROM QA_TFDDREGISTRO R
                WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                AND FDD_CAUSA_SSPD IN ('14')
WHERE FDD_CODIGOEVENTO = ''
;


CREATE TABLE QA_TT12_PRECONSOLIDADO(
 TT12_CODIGOEVENTO VARCHAR2(20)
,TT12_FINICIAL DATE
,TT12_FFINAL DATE
,TT12_DURACION NUMBER
,TT12_CIRCUITOS VARCHAR2(400)
,TT12_ID NUMBER
);

INSERT INTO QA_TT12_PRECONSOLIDADO (TT12_CODIGOEVENTO,TT12_FINICIAL,TT12_FFINAL,TT12_DURACION,TT12_CIRCUITOS,TT12_ID)
VALUES();



ALTER TABLE QA_TTT12_PRECONSOLIDADO
RENAME TO QA_TTT12_TEMP;

INSERT INTO QA_TTT12_TEMP
SELECT CODIGOEVENTO
      ,FINICIAL
      ,FFINAL
      ,DURACION
      ,LISTAGG (NOMBRECIRCUITO, ',') WITHIN GROUP (ORDER BY NOMBRECIRCUITO) AS CIRCUITOS
      ,'' AS ID
          FROM(
                SELECT DISTINCT FDD_CODIGOEVENTO AS CODIGOEVENTO
                      ,  TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
                      , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
                      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                      , TT1_NOMBRECIRCUITO AS NOMBRECIRCUITO
                FROM QA_TFDDREGISTRO R
                LEFT OUTER JOIN (SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION') ON TT2_CODIGOELEMENTO = FDD_CODIGOELEMENTO
                LEFT OUTER JOIN QA_TTT1_REGISTRO ON TT1_CODIGOCIRCUITO = TT2_IUL
                WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                AND FDD_CAUSA_SSPD IN ('14')
                AND TT1_NOMBRECIRCUITO IS NOT NULL
             )
WHERE CODIGOEVENTO = '930827'             
GROUP BY CODIGOEVENTO
      ,FINICIAL
      ,FFINAL
      ,DURACION
;


SELECT * FROM QA_TTT12_TEMP;

DELETE FROM QA_TTT12_TEMP;
COMMIT;

DESC QA_TTT12_TEMP;


INSERT INTO QA_TTT12_TEMP 
SELECT  '123435'
    , SYSDATE
    , SYSDATE
    ,12.55
    , 'AD SD SD'
    , 10
FROM DUAL;
ROLLBACK;


DROP TABLE QA_TTT12_TEMP;
CREATE TABLE QA_TTT12_TEMP(
 TT12_CODIGOEVENTO NUMBER
,TT12_FINICIAL VARCHAR2(20)
,TT12_FFINAL VARCHAR2(20)
,TT12_DURACION VARCHAR2(20)
,TT12_CIRCUITOS VARCHAR2(400)
,TT12_ID NUMBER
);


SELECT TO_CHAR(10.22) FROM DUAL;

ALTER TABLE QA_TTT12_TEMP
MODIFY TT12_FINICIAL VARCHAR2(30);




                    SELECT CODIGOEVENTO,FINICIAL,FFINAL,DURACION
                          ,LISTAGG (NOMBRECIRCUITO, ',') WITHIN GROUP (ORDER BY NOMBRECIRCUITO) AS CIRCUITOS
                              FROM(
                                    SELECT DISTINCT FDD_CODIGOEVENTO AS CODIGOEVENTO
                                          ,  TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
                                          , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
                                          , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                                          - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                                          , TT1_NOMBRECIRCUITO AS NOMBRECIRCUITO
                                    FROM QA_TFDDREGISTRO R
                                    LEFT OUTER JOIN (SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION') ON TT2_CODIGOELEMENTO = FDD_CODIGOELEMENTO
                                    LEFT OUTER JOIN QA_TTT1_REGISTRO ON TT1_CODIGOCIRCUITO = TT2_IUL
                                    WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                                    AND FDD_CAUSA_SSPD IN ('14')
                                    AND TT1_NOMBRECIRCUITO IS NOT NULL
                                 )
                     WHERE CODIGOEVENTO NOT IN(SELECT DISTINCT TT12_CODIGOEVENTO FROM QA_TTT12_TEMP)
                     GROUP BY CODIGOEVENTO,FINICIAL,FFINAL,DURACION;

----------------LOGICA--------------------------------------------------------------------------------------------
--Los registros en TT3 se congelaran con la certificacion del formato TT12, campo TT3_EJECUTADO=1




--********************
        --*PARTE 2, CORRESPONDIENTE A LOS NO EJECUTADOS
SELECT   TO_NUMBER(TT3_ID)	AS	TT3_ID
        ,TO_CHAR(NOMBRE_CIRCUITO)	AS	NOMBRE_CIRCUITO
        ,TO_CHAR(CIRCUITO)	AS	CIRCUITO
        ,TO_NUMBER(ACTIVIDAD)	AS	ACTIVIDAD
        ,TO_CHAR(CODIGO_IUA_IUL)	AS	CODIGO_IUA_IUL
        ,TO_NUMBER(USUARIOS_AFECTADOS)	AS	USUARIOS_AFECTADOS
        ,FECHA_INICIAL	AS	FECHA_INICIAL
        ,FECHA_FINAL	AS	FECHA_FINAL
        ,TO_CHAR(DURACION)	AS	DURACION
        ,TO_CHAR(MES_EJECUCION)	AS	MES_EJECUCION 
     FROM(        
        WITH TC1_CODIGOS AS
        (
            SELECT DISTINCT T1.TC1_CODCIRC
                        ,T1.TC1_IUA
                        ,COUNT(T1.TC1_IUA) AS CANT_USRS_T
                        ,T2.CANT_USRS      AS CANT_USRS_C
            FROM   QA_TTC1 T1
            LEFT OUTER JOIN (
                             SELECT DISTINCT TC1_CODCIRC
                                         ,COUNT(TC1_CODCIRC) AS CANT_USRS
                             FROM   QA_TTC1
                             WHERE  TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
                             AND    TC1_TIPCONEX = 'T'
                             GROUP BY TC1_CODCIRC    
                             ) T2 ON T2.TC1_CODCIRC =  T1.TC1_CODCIRC
            WHERE  T1.TC1_PERIODO  = TO_CHAR(ADD_MONTHS(TO_DATE(:PERIODO,'DD/MM/YYYY'),-2),'YYYYMM')
            AND    T1.TC1_TIPCONEX = 'T'
            GROUP BY T1.TC1_CODCIRC,TC1_IUA,T2.CANT_USRS
        )
        
                (
                    SELECT  TO_NUMBER(AF.TT3_ID) AS TT3_ID
                          , AF.TT3_CIRCUITO NOMBRE_CIRCUITO
                          , AF.TT3_IUL AS CIRCUITO
                          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
                          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
                          , TO_CHAR(TC.TC1_IUA)                                     AS CODIGO_IUA_IUL --CRUCE TC1
                          , NVL(TC.CANT_USRS_T,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
                          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                          ,''    AS DURACION
                          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
                    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
                          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')) RG
                    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
                    LEFT OUTER JOIN  TC1_CODIGOS             TC ON TC.TC1_CODCIRC = AF.TT3_IUL
                    
                )
        UNION ALL
                (
                    SELECT  TO_NUMBER(AF.TT3_ID) AS TT3_ID
                          , AF.TT3_CIRCUITO
                          , AF.TT3_IUL
                          , TO_NUMBER(RG.TT11_ACTIVIDAD) AS ACTIVIDAD
                          --, RG.TT11_DESCRIPCION                            AS OBJETIVO
                          , TO_CHAR(AF.TT3_IUL)                                    AS CODIGOS_IUA_IUL --CRUCE TC1
                          , NVL(TC.CANT_USRS_C,0)                          AS USUARIOS_AFECTADOS --CRUCE TC1
                          , TO_CHAR(TRUNC(RG.TT11_FINICIAL),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                          , TO_CHAR(TRUNC(RG.TT11_FFINAL  ),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                          , TO_CHAR((TRUNC(RG.TT11_FFINAL)-TRUNC(RG.TT11_FINICIAL))*24,'0.00')   AS DURACION
                          , TO_CHAR(RG.TT11_FINICIAL,'MM')                 AS MES_EJECUCION
                    FROM (SELECT DISTINCT TT11_ID,TT11_ACTIVIDAD,TT11_FINICIAL,TT11_FFINAL FROM QA_TTT11_REPORTE
                          WHERE TT11_PERIODO_OP = TO_DATE(:PERIODO,'DD/MM/YYYY')) RG
                    LEFT OUTER JOIN (SELECT * FROM BRAE.QA_TTT3_AFECTACION
                                     WHERE TT3_PERIODO_OP =  TRUNC(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYY')) AF ON AF.TT3_ID     = RG.TT11_ID
                    LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCIRC
                                           ,CANT_USRS_C
                                           FROM TC1_CODIGOS)              TC ON TC.TC1_CODCIRC = AF.TT3_IUL
                )
)
WHERE TT3_ID = 3
UNION ALL
         --*PARTE 1, CORRESPONDIENTE A LOS    EJECUTADOS
SELECT   TO_NUMBER(TT3_ID)	AS	TT3_ID
        ,TO_CHAR(NOMBRE_CIRCUITO)	AS	NOMBRE_CIRCUITO
        ,TO_CHAR(CIRCUITO)	AS	CIRCUITO
        ,TO_NUMBER(ACTIVIDAD)	AS	ACTIVIDAD
        ,TO_CHAR(CODIGO_IUA_IUL)	AS	CODIGO_IUA_IUL
        ,TO_NUMBER(USUARIOS_AFECTADOS)	AS	USUARIOS_AFECTADOS
        ,FECHA_INICIAL	AS	FECHA_INICIAL
        ,FECHA_FINAL	AS	FECHA_FINAL
        ,TO_CHAR(DURACION)	AS	DURACION
        ,TO_CHAR(MES_EJECUCION)	AS	MES_EJECUCION 
FROM            (
                SELECT (CASE WHEN (T1.TT1_NOMBRECIRCUITO IN  ('CONS65','CONSAL_CARMEN','CONSAL_CONVE','CONSAL_SANPABLO','CONSAL_TEORA','TARC1','TARC2'))    THEN (3) 
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('TIBPOZOS','TIBTIBU1','TIBTIBU2','TIBTIBU3')) THEN (5)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('AGUC2','AGUC3','AGUC4','AGUC5','AGUC7','AGUC8','AGUGAMA','AGUIG5')) THEN (26)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('ABRC1','ABRC2','OCAILA5')) THEN (41)
                             WHEN (T1.TT1_NOMBRECIRCUITO IN  ('OCAGONZALES','OCALA_PLAYA','OCAOCANA1','OCAOCANA2','OCAOCANA3')) THEN (44)
                        END) AS TT3_ID
                      ,T1.TT1_NOMBRECIRCUITO AS NOMBRE_CIRCUITO
                      , T.TC1_CODCIRC AS CIRCUITO
                      , 1 AS ACTIVIDAD
                      , FDD_IUA AS CODIGO_IUA_IUL
                      , T.CANT_USRS AS USUARIOS_AFECTADOS      
                      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FECHA_INICIAL
                      , TO_CHAR(TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'),'DD-MM-YYYY HH24:MI') AS FECHA_FINAL
                      , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                      - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                      ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
                FROM QA_TFDDREGISTRO R
                LEFT OUTER JOIN (
                                SELECT DISTINCT 
                                       TC1_CODCONEX
                                      ,TC1_CODCIRC
                                      ,COUNT(TC1_CODCONEX) AS CANT_USRS
                                FROM QA_TTC1
                                WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                                AND   TC1_TIPCONEX =  'T'
                                AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                                GROUP BY TC1_CODCONEX
                                        ,TC1_CODCIRC
                                 ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
                LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
                WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                AND FDD_CAUSA_SSPD IN ('14')
        
        UNION ALL
        
                SELECT (CASE WHEN (TT1_NOMBRECIRCUITO IN  ('CONS65','CONSAL_CARMEN','CONSAL_CONVE','CONSAL_SANPABLO','CONSAL_TEORA','TARC1','TARC2'))    THEN (3) 
                             WHEN (TT1_NOMBRECIRCUITO IN  ('TIBPOZOS','TIBTIBU1','TIBTIBU2','TIBTIBU3')) THEN (5)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('AGUC2','AGUC3','AGUC4','AGUC5','AGUC7','AGUC8','AGUGAMA','AGUIG5')) THEN (26)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('ABRC1','ABRC2','OCAILA5')) THEN (41)
                             WHEN (TT1_NOMBRECIRCUITO IN  ('OCAGONZALES','OCALA_PLAYA','OCAOCANA1','OCAOCANA2','OCAOCANA3')) THEN (44)
                        END) AS TT3_ID
                      ,TT1_NOMBRECIRCUITO
                      ,CIRCUITO
                      ,1 AS ACTIVIDAD
                      ,CIRCUITO
                      ,SUM(NUM_USRS) AS NUM_USRS
                      ,TO_CHAR(FINICIAL,'DD-MM-YYYY HH24:MI') AS FINICIAL
                      ,TO_CHAR(FFINAL,'DD-MM-YYYY HH24:MI') AS FFINAL
                      ,DURACION
                      ,MES_EJECUCION
                FROM(
                    SELECT T1.TT1_NOMBRECIRCUITO
                          ,T.TC1_CODCIRC AS CIRCUITO
                          , 1 AS ACTIVIDAD
                          --, FDD_IUA AS CODIGO_CIR_TRA
                          , T.CANT_USRS AS NUM_USRS      
                          , TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FINICIAL
                          , TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') AS FFINAL
                          , ROUND((TO_DATE(TO_CHAR(FDD_FFINAL  ,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS')
                          - TO_DATE(TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS'))*24,2) AS DURACION
                          ,TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM') AS MES_EJECUCION
                    FROM QA_TFDDREGISTRO R
                    LEFT OUTER JOIN (
                                    SELECT DISTINCT 
                                           TC1_CODCONEX
                                          ,TC1_CODCIRC
                                          ,COUNT(TC1_CODCONEX) AS CANT_USRS
                                    FROM QA_TTC1
                                    WHERE TC1_PERIODO = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'YYYYMM')
                                    AND   TC1_TIPCONEX =  'T'
                                    AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                                    GROUP BY TC1_CODCONEX
                                            ,TC1_CODCIRC
                                     ) T ON T.TC1_CODCONEX = R.FDD_CODIGOELEMENTO 
                    LEFT OUTER JOIN QA_TTT1_REGISTRO T1 ON T1.TT1_CODIGOCIRCUITO = T.TC1_CODCIRC
                    WHERE TO_CHAR(FDD_FINICIAL,'MM/YYYY') = TO_CHAR(TO_DATE(:PERIODO,'DD/MM/YYYY'),'MM/YYYY')
                    AND FDD_CAUSA_SSPD IN ('14')
                )
                GROUP BY TT1_NOMBRECIRCUITO
                        ,CIRCUITO
                        ,FINICIAL
                        ,FFINAL
                        ,DURACION
                        ,MES_EJECUCION
                )
        ;


SELECT * FROM QA_TTT12_TEMP;

EXEC QA_PTT12_REPORTE(DATE'2022-07-01');








