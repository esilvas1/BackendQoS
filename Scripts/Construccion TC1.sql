EXEC QA_PTT2_REGISTRO(DATE'2022-05-01');

SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_PERIODO_OP=DATE'2022-05-01';

SELECT * FROM QA_TTC1_TEMP;


--/
--DECLARE
--BEGIN
--SET SERVEROUTPUT ON;
EXEC QA_PTC1_REGISTRO_FASE2(DATE'2022-05-01');
--END;
--/

SELECT DISTINCT TC1_IUA FROM QA_TTC1_TEMP
;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IUA = 'NA';

SELECT DISTINCT TC1_PERIODO FROM QA_TTC1_TEMP;

UPDATE QA_TTC1_TEMP 
SET    TC1_PERIODO=202205
WHERE  TC1_PERIODO=202204;

COMMIT;


--PASAR LOS REGISTROS IUA NA A LA TABLA QA_TTC1_OBS

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IUA = 'NA';

INSERT INTO QA_TTC1_OBS
SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IUA = 'NA';
COMMIT;


DELETE FROM QA_TTC1_TEMP
WHERE TC1_IUA = 'NA';
COMMIT;

SELECT DISTINCT TC1_CODCIRC FROM QA_TTC1_TEMP;

SELECT TC1_CODCONEX FROM QA_TTC1_TEMP
WHERE TC1_CODCIRC = 'NA';

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN (
                            SELECT TC1_CODCONEX FROM QA_TTC1_TEMP
                            WHERE TC1_CODCIRC = 'NA'
);


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCIRC = 'NA';

--AGREGAR LAS CALP DESDE EL FORMATO TT2

INSERT INTO QA_TTC1_TEMP
SELECT 	TT2_CODE_CALP AS	TC1_TC1
    ,	TT2_CODIGOELEMENTO AS	TC1_CODCONEX
    ,	'T' AS	TC1_TIPCONEX
    ,	0 AS	TC1_NT
    ,	0 AS	TC1_NTP
    ,	'' AS	TC1_PROPACTIV
    ,	'' AS	TC1_CONEXRED
    ,	'' AS	TC1_IDCOMER
    ,	'' AS	TC1_IDMERC
    ,	'' AS	TC1_GC
    ,	'' AS	TC1_CODFRONCOM
    ,	'' AS	TC1_CODCIRC
    ,	'' AS	TC1_CODTRANSF
    ,	'' AS	TC1_CODDANE
    ,	'' AS	TC1_UBIC
    ,	'' AS	TC1_DIREC
    ,	'' AS	TC1_CONESP
    ,	'' AS	TC1_CODARESP
    ,	'' AS	TC1_TIPARESP
    ,	'' AS	TC1_ESTSECT
    ,	0 AS	TC1_ALTITUD
    ,	0 AS	TC1_LONGITUD
    ,	0 AS	TC1_LATITUD
    ,	'' AS	TC1_AUTOGEN
    ,	'' AS	TC1_EXPENER
    ,	'' AS	TC1_CAPAUTOGENR
    ,	'' AS	TC1_TIPGENR
    ,	'' AS	TC1_CODFRONEXP
    ,	'' AS	TC1_FENTGEN
    ,	'' AS	TC1_CONTRESP
    ,	'' AS	TC1_CAPCONTRESP
    ,	202205 AS	TC1_PERIODO
    ,	TT2_CODE_IUA AS	TC1_IUA
FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_CALP <> '0'
AND   TT2_ESTADO IN ('OPERACION','CONSTRUCCION');

--COMMIT;



---AGREGAR LOS DOSMIL USUARIOS FALTANTES

SELECT DISTINCT TC1_TC1 
FROM QA_TTC1 
WHERE TC1_PERIODO = 202205
AND   TC1_TC1 NOT LIKE 'CALP%'
AND   TC1_CODCONEX NOT LIKE 'ALPM%'
AND   TC1_TIPCONEX = 'T'
AND   TC1_IDCOMER='604'
MINUS
SELECT DISTINCT TC1_TC1
FROM QA_TTC1_TEMP
WHERE   TC1_TC1 NOT LIKE 'CALP%'
AND   TC1_CODCONEX NOT LIKE 'ALPM%'
AND   TC1_TIPCONEX = 'T';

--ESTO DA VACIO, ENTENDIENDO QUE NINGUN USUARIO ESTA PRESENTE EN EL TC1 TEMPORAL
SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN (  SELECT DISTINCT TC1_TC1 
                    FROM QA_TTC1 
                    WHERE TC1_PERIODO = 202205
                    AND   TC1_TC1 NOT LIKE 'CALP%'
                    AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                    AND   TC1_TIPCONEX = 'T'
                    AND   TC1_IDCOMER='604'
                    MINUS
                    SELECT DISTINCT TC1_TC1
                    FROM QA_TTC1_TEMP
                    WHERE   TC1_TC1 NOT LIKE 'CALP%'
                    AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                    AND   TC1_TIPCONEX = 'T'
                  );


--AGREGAMOS ESTOS USUARIOS DIRECTAMENTE DEL TC1 ANTERIO EN ESTE CASO LOS DEL PERIODO ABRIL 2022
INSERT INTO QA_TTC1_TEMP
SELECT * FROM QA_TTC1
WHERE TC1_TC1 IN (  SELECT DISTINCT TC1_TC1 
                    FROM QA_TTC1 
                    WHERE TC1_PERIODO = 202205
                    AND   TC1_TC1 NOT LIKE 'CALP%'
                    AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                    AND   TC1_TIPCONEX = 'T'
                    AND   TC1_IDCOMER='604'
                    MINUS
                    SELECT DISTINCT TC1_TC1
                    FROM QA_TTC1_TEMP
                    WHERE   TC1_TC1 NOT LIKE 'CALP%'
                    AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                    AND   TC1_TIPCONEX = 'T'
                  )
AND TC1_PERIODO = 202204;--2638  Filas
COMMIT;

--SE ACTUALIZA EL PERIODO AL PERIODO ACUTAL PARA LOS USUARIOS AGREGADOS DE LA EXCLUSION SAC
UPDATE QA_TTC1_TEMP
SET   TC1_PERIODO= 202205
WHERE TC1_PERIODO= 202204
;

COMMIT;


SELECT DISTINCT TC1_PERIODO FROM QA_TTC1_TEMP;


----DUPLICIDAD Y DIFERENCIA DE IUA CON TRAFO 1T01441

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO='1T01441';

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX = '1T01441';

SELECT TT2_CODE_IUA FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO='1T01441'
AND   TT2_ESTADO = 'OPERACION';

UPDATE QA_TTC1_TEMP
SET TC1_IUA = (SELECT TT2_CODE_IUA FROM QA_TTT2_REGISTRO WHERE TT2_CODIGOELEMENTO='1T01441' AND TT2_ESTADO = 'OPERACION')
WHERE TC1_CODCONEX = '1T01441';
COMMIT;


--USUARIO CON DIFERENTE IUA
SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 = '1046636';


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 = '1046636'
AND TC1_TIPCONEX='T';

DELETE FROM QA_TTC1_TEMP
WHERE TC1_TC1 = '1046636'
AND TC1_TIPCONEX='T';

COMMIT;


SELECT DISTINCT FDD_CODIGOELEMENTO FROM QA_TFDDPRELIMINAR_AJ
WHERE FDD_TIPOCARGA='TR'
AND   FDD_TIPOAJUSTE = 1;


SELECT * FROM QA_TFDDPRELIMINAR_AJ
WHERE FDD_CODIGOEVENTO='911266';


SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_CODIGOEVENTO='911266';


SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
WHERE TT2_PERIODO_OP = DATE'2022-05-01'
AND  TT2_CODIGOELEMENTO IN (
                            SELECT DISTINCT FDD_CODIGOELEMENTO FROM QA_TFDDPRELIMINAR_AJ
                            WHERE FDD_TIPOCARGA='TR'
                            AND   FDD_TIPOAJUSTE = 1
                            );

SELECT * FROM QA_TFDDPRELIMINAR_AJ;

SELECT * FROM QA_TFDDRESUMEN_AJ
DISTINC;


SELECT * FROM QA_TTT9
WHERE TT9_PERIODO_OP=DATE'2022-05-01';

SET SERVEROUTPUT ON;
EXEC QA_PTT9(DATE'2022-05-01');

SELECT DISTINCT TT9_PERIODO_OP FROM QA_TTT9;

DELETE FROM QA_TTT9
WHERE TT9_PERIODO_OP=DATE'2022-06-01';
COMMIT;


SELECT COUNT(FDD_AJUSTADO) FROM QA_TFDDREGISTRO
WHERE TO_CHAR(FDD_FINICIAL,'YYYYMM')='202205'
AND FDD_AJUSTADO='S';



SELECT DISTINCT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
WHERE TT2_PERIODO_OP=DATE'2022-05-01';

SELECT DISTINCT TC1_CODCONEX,TC1_IUA FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND   TC1_CODCONEX IN (SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                       WHERE TT2_PERIODO_OP=DATE'2022-05-01')

MINUS                  
                       
SELECT DISTINCT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
WHERE TT2_PERIODO_OP=DATE'2022-05-01';


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_PERIODO_OP=DATE'2022-05-01';

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_CODCONEX = '1T01441';


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1 LIKE 'CALP%';


SELECT DISTINCT TT2_CODIGOELEMENTO,TT2_CODE_IUA,TC1_IUA 
FROM BRAE.QA_TTT2_REGISTRO
LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCONEX,TC1_IUA FROM BRAE.QA_TTC1
                 WHERE TC1_PERIODO=202205
                 AND   TC1_CODCONEX IN (SELECT DISTINCT TT2_CODIGOELEMENTO FROM BRAE.QA_TTT2_REGISTRO
                                        WHERE TT2_PERIODO_OP=DATE'2022-05-01')
                 ) ON TC1_CODCONEX=TT2_CODIGOELEMENTO 
WHERE TT2_PERIODO_OP=DATE'2022-05-01'
AND TC1_IUA IS NOT NULL
AND TT2_CODE_IUA<>TC1_IUA
AND TT2_ESTADO = 'OPERACION';





SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205;



SELECT 	TT2_CODE_CALP AS	TC1_TC1
    ,	TT2_CODIGOELEMENTO AS	TC1_CODCONEX
    ,	'T' AS	TC1_TIPCONEX
    ,	0 AS	TC1_NT
    ,	0 AS	TC1_NTP
    ,	'' AS	TC1_PROPACTIV
    ,	'' AS	TC1_CONEXRED
    ,	'' AS	TC1_IDCOMER
    ,	'' AS	TC1_IDMERC
    ,	'' AS	TC1_GC
    ,	'' AS	TC1_CODFRONCOM
    ,	'' AS	TC1_CODCIRC
    ,	'' AS	TC1_CODTRANSF
    ,	'' AS	TC1_CODDANE
    ,	'' AS	TC1_UBIC
    ,	'' AS	TC1_DIREC
    ,	'' AS	TC1_CONESP
    ,	'' AS	TC1_CODARESP
    ,	'' AS	TC1_TIPARESP
    ,	'' AS	TC1_ESTSECT
    ,	0 AS	TC1_ALTITUD
    ,	0 AS	TC1_LONGITUD
    ,	0 AS	TC1_LATITUD
    ,	'' AS	TC1_AUTOGEN
    ,	'' AS	TC1_EXPENER
    ,	'' AS	TC1_CAPAUTOGENR
    ,	'' AS	TC1_TIPGENR
    ,	'' AS	TC1_CODFRONEXP
    ,	'' AS	TC1_FENTGEN
    ,	'' AS	TC1_CONTRESP
    ,	'' AS	TC1_CAPCONTRESP
    ,	202205 AS	TC1_PERIODO
    ,	TT2_CODE_IUA AS	TC1_IUA
FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_CALP <> '0'
AND   TT2_ESTADO IN ('OPERACION','CONSTRUCCION');

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202204
AND   TC1_TC1 LIKE 'CALP%'
AND   TC1_NT=2;

SELECT * FROM QA_TTT2_REGISTRO;




SELECT DISTINCT TT2_CODIGOELEMENTO,TT2_CODE_CALP,TC1_TC1 
FROM BRAE.QA_TTT2_REGISTRO
LEFT OUTER JOIN (SELECT DISTINCT TC1_CODCONEX,TC1_TC1 FROM BRAE.QA_TTC1
                 WHERE TC1_PERIODO=202205
                 AND   TC1_TC1 LIKE 'CALP%'
                 ) ON TC1_CODCONEX=TT2_CODIGOELEMENTO 
WHERE TT2_ESTADO = 'OPERACION'
AND   TT2_CODE_CALP <> '0'
AND TC1_TC1 IS NOT NULL
AND TT2_CODE_CALP <> TC1_TC1
;

--SE VERIFICA QUE NO EXISTE DUPLICADO EN LA CONCATENACION DE USUARIO-ID_COMERCIALIZADORA
SELECT SUM(CANT) AS SUMA
FROM(
    SELECT TC1_TC1||TC1_IDCOMER AS CONCAT,COUNT(TC1_TC1||TC1_IDCOMER) AS CANT
    FROM QA_TTC1
    WHERE TC1_PERIODO = 202205
    GROUP BY TC1_TC1||TC1_IDCOMER
    );--587759

SELECT COUNT(TC1_TC1)
FROM QA_TTC1
WHERE TC1_PERIODO=202205;--587759


--VERIFICACION DE LA CANTIDAD EN LA QUE EXISTE UN USUARIOS, MAXIMO DOS VECES POR TRANSICION DE COMERCIALIZADORA

SELECT TC1_TC1,COUNT(TC1_TC1)
FROM QA_TTC1
WHERE TC1_PERIODO=202205
GROUP BY TC1_TC1
HAVING COUNT(TC1_TC1)=2
;
--RESULTS
/*
154655	3
532295	3
687024	3
*/

--154655
SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='154655'
AND TC1_IDCOMER<>'48305';


DELETE FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='154655'
AND TC1_IDCOMER<>'48305';
COMMIT;

--532295
SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='532295'
AND TC1_IDCOMER<>'44077';

DELETE FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='532295'
AND TC1_IDCOMER<>'44077';
COMMIT;




--687024
SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='687024'
AND TC1_IDCOMER<>'604';


--687024
DELETE FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='687024'
AND TC1_IDCOMER<>'604';
COMMIT;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND SUBSTR(TC1_CODCONEX,2,1)<>'T';

--VERIFICACION DEL CAMPO TC1_TIPCONEX

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TIPCONEX='P'
;

--VERIFICACION DEL CAMPO TC1_NT
SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_NT = 0;

--OBTENER EL NIVEL DE TENSION DE ENTRADA Y SALIDA DE TENSION DE LOS TRANSFORMADORES PARA ASIGNAR A LOS USUARIOS CALPS.
SELECT NODO_TRANSFORM_V, TENSION, TENSION_SECUNDARIA 
FROM                CCONECTIVIDAD_E@GTECH  CON
    LEFT OUTER JOIN CCOMUN@GTECH           COM  ON  COM.G3E_FID            = CON.G3E_FID
    LEFT OUTER JOIN ETRANSFO_AT@GTECH      ET   ON  ET.G3E_FID             = COM.G3E_FID
    LEFT OUTER JOIN CPROPIETARIO@GTECH     CPRO ON  CPRO.G3E_FID           = CON.G3E_FID
    LEFT OUTER JOIN QA_TTT1_REGISTRO       TT1  ON  TT1.TT1_NOMBRECIRCUITO = CON.CIRCUITO
WHERE               COM.G3E_FNO = 20400
;



SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_NT = 0
AND TC1_TC1 LIKE 'CALP%' ;

UPDATE QA_TTC1
SET TC1_NT = 1
   ,TC1_NTP = 2
WHERE TC1_PERIODO=202205
AND TC1_NT = 0
AND TC1_TC1 LIKE 'CALP%' ;


--REALIZAR CAMBIOS DE COMERCIALIZADORA
SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='1045931'
AND TC1_IDCOMER='604';


DELETE FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='1045931'
AND TC1_IDCOMER='604';

COMMIT;



SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='1077866'
;--AND TC1_IDCOMER='604';

DESC QA_TTC1;


INSERT INTO QA_TTC1
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'2322' AS TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='1077866'
;

COMMIT;

UPDATE QA_TTC1
SET   TC1_CODFRONCOM='FRT46078'
WHERE TC1_PERIODO=202205
AND TC1_TC1='1077866'
AND TC1_IDCOMER='2322'
;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='1077866'
;--AND TC1_IDCOMER='604';

COMMIT;


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='625089'
;--AND TC1_IDCOMER='604';



INSERT INTO QA_TTC1
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'2322' AS TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='625089'
;


UPDATE QA_TTC1
SET   TC1_CODFRONCOM='FRT46061'
WHERE TC1_PERIODO=202205
AND TC1_TC1='625089'
AND TC1_IDCOMER='2322'
;

COMMIT;

/*************************************************************/

SELECT *
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='154655'
;


/
BEGIN
INSERT INTO QA_TTC1
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'597' AS TC1_IDCOMER --NO MODIFICAR
,	TC1_IDMERC
,	TC1_GC
,	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1= '154655'   
;


UPDATE QA_TTC1
SET   TC1_CODFRONCOM='Frt13056'
WHERE TC1_PERIODO=202205
AND TC1_TC1='154655'
AND TC1_IDCOMER='597' --NO MODIFICAR
;
END;
/
COMMIT;


--EXPORTAR PARA COMERCIALIZADORAS


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_IDCOMER<>'604' OR TC1_IDCOMER IS NULL;

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_ESTADO='OPERACION';

SELECT CODE,ADDRESS FROM SPARD.TRANSFOR;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T04584');

SELECT FPARENT FROM SPARD.TRANSFOR
WHERE CODE = '1T04584';

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_PERIODO_OP=DATE'2022-05-01'
AND TT2_CODIGOELEMENTO='1T13241';


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205;


DELETE FROM QA_TTC1_TEMP;
COMMIT;

INSERT INTO QA_TTC1_TEMP
SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205;

--REALIZAR LOS CAMBIOS DEL PROCECIMIENTO EN LA TABLA TEMPORAL DEL TC1

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='313328';;


UPDATE QA_TTC1
SET TC1_CODFRONCOM='FRT04385'
WHERE TC1_PERIODO=202205
AND TC1_TC1='313328'
AND TC1_CODFRONCOM='FRT36767';

COMMIT;


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='452565';


UPDATE QA_TTC1
SET TC1_PROPACTIV=0
WHERE TC1_PERIODO=202205
AND TC1_TC1='452565';

COMMIT;


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='687024';


SELECT * FROM QA_TTC1
WHERE TC1_CODFRONCOM='Frt33173';

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='452565';

SELECT * FROM QA_TTC1
WHERE TC1_CODFRONCOM='FRT13056';


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_CALP='CALP000000105';

SELECT * FROM QA_TTC1 
WHERE TC1_TC1='CALP000000105';
---*******************
SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1='263987';

UPDATE QA_TTC1
SET   TC1_IDCOMER='604'
     ,TC1_CODFRONCOM='OR0001'
WHERE TC1_PERIODO=202205
AND TC1_TC1='263987';


COMMIT;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1 IN ('478809'
,'263987'
,'451860'
,'451857'
,'426'
,'263987'
,'426');


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1 IN ('263987');

UPDATE QA_TTC1
SET TC1_DIREC='KM 13 VIA CORREJIMIENTO DE CORNEJO'
WHERE TC1_PERIODO=202205
AND TC1_TC1 IN ('263987');

COMMIT;


DELETE FROM QA_TTC1_TEMP;

COMMIT;

SELECT TC1_NT,COUNT(TC1_NT) FROM QA_TTC1
WHERE TC1_PERIODO=202205
GROUP BY TC1_NT;

---CONSEGUIR EL NT DE TODOS LOS TRAFO PARA ALIMENTAR TT2 Y TC1 ACTUAL SOLO PARA APLICAR A LAS CALPS, LOS USUARIOS YA TRANE CONSIGO LOS NIVLES DE TENSION DESDE EL INSUMO SAC

CREATE TABLE QA_TTC1_TEMPORAL_NT(
 CODE VARCHAR2(20)
,TENSION_PRIMARIO VARCHAR2(20)
,TENSION_SECUNDARIA VARCHAR2(20)
);

DELETE FROM QA_TTC1_TEMPORAL_NT;
COMMIT;

INSERT INTO QA_TTC1_TEMPORAL_NT
SELECT CON.NODO_TRANSFORM_V,CON.TENSION, CON.TENSION_SECUNDARIA
       FROM                CCONECTIVIDAD_E@GTECH  CON
            LEFT OUTER JOIN CCOMUN@GTECH           COM  ON  COM.G3E_FID            = CON.G3E_FID
            LEFT OUTER JOIN ETRANSFO_AT@GTECH      ET   ON  ET.G3E_FID             = COM.G3E_FID
            LEFT OUTER JOIN CPROPIETARIO@GTECH     CPRO ON  CPRO.G3E_FID           = CON.G3E_FID
            LEFT OUTER JOIN QA_TTT1_REGISTRO       TT1  ON  TT1.TT1_NOMBRECIRCUITO = CON.CIRCUITO
        WHERE               COM.G3E_FNO = 20400
        AND                 COM.ESTADO = 'OPERACION'
        ;
        
        COMMIT;
        
SELECT * FROM QA_TTC1_TEMPORAL_NT
WHERE TENSION_SECUNDARIA IS NULL; 

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_NT = 0
AND TC1_TC1 LIKE 'CALP%';


SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1
LEFT OUTER JOIN (SELECT  DISTINCT * FROM QA_TTC1_TEMPORAL_NT) ON CODE=TC1_CODCONEX
WHERE TC1_PERIODO=202205
AND TC1_TC1 LIKE 'CALP%';



SELECT * FROM QA_TTC1
LEFT OUTER JOIN (SELECT  DISTINCT * FROM QA_TTC1_TEMPORAL_NT) ON CODE=TC1_CODCONEX
WHERE TC1_PERIODO=202205
AND TC1_TC1 LIKE 'CALP%';


---0.24
--0.12
--0.22
--CONCLUYENDO QUE EL NINVEL DE TENSION SECUNDARIA OSCILA EN EN NT 1 SE ACTUALIZA A CONTINAUCION
UPDATE QA_TTC1
SET   TC1_NT = 1
WHERE TC1_PERIODO=202205
AND TC1_NT = 0
AND TC1_TC1 LIKE 'CALP%';

--COMMIT;



SELECT * FROM QA_TTC1
LEFT OUTER JOIN (SELECT  DISTINCT * FROM QA_TTC1_TEMPORAL_NT) ON CODE=TC1_CODCONEX
WHERE TC1_PERIODO=202205
AND TC1_TC1 LIKE 'CALP%';

UPDATE QA_TTC1 T
SET   T.TC1_NTP = (SELECT  TENSION_PRIMARIO FROM QA_TTC1_TEMPORAL_NT WHERE CODE = T.TC1_CODCONEX)
WHERE T.TC1_PERIODO=202205
AND T.TC1_TC1 LIKE 'CALP%';


SELECT TC1_NTP,COUNT(TC1_NTP)
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1 LIKE 'CALP%'
GROUP BY TC1_NTP;


UPDATE QA_TTC1
SET TC1_NTP=3
WHERE TC1_PERIODO=202205
AND TC1_TC1 LIKE 'CALP%'
AND TC1_NTP = 35
;



/*
14	6582
8	14
35	16
*/

COMMIT;

SELECT *
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_NTP=0;


SELECT *
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_IDMERC IS NULL;


UPDATE QA_TTC1
SET TC1_IDMERC='161'
WHERE TC1_PERIODO=202205
AND TC1_IDMERC IS NULL;


COMMIT;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_GC IS NULL;

--583844  Rows
INSERT INTO QA_TTC1_TEMP
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	TC1_IDCOMER
,	TC1_IDMERC
,	TT2_GRUPOCALIDAD
,	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1
LEFT OUTER JOIN (SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION') ON TT2_CODIGOELEMENTO =  TC1_CODCONEX
WHERE TC1_PERIODO = 202205
AND TC1_TIPCONEX = 'T'; --587757  Rows


DELETE FROM QA_TTC1
WHERE TC1_PERIODO = 202205
AND TC1_TIPCONEX = 'T'; --587757  Rows

COMMIT;

INSERT INTO QA_TTC1
SELECT * FROM QA_TTC1_TEMP;


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO = 202205
AND TC1_TIPCONEX = 'T'
AND TC1_GC IS NULL;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202204
AND TC1_CODCONEX LIKE 'ALPM%';


UPDATE QA_TTC1 T
SET T.TC1_GC = (SELECT DISTINCT TC1_GC FROM QA_TTC1 WHERE TC1_TC1 = T.TC1_TC1 AND TC1_PERIODO=202204)
WHERE T.TC1_PERIODO = 202205
AND T.TC1_TIPCONEX = 'T'
AND T.TC1_GC IS NULL;

COMMIT;


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO = 202205
AND TC1_TIPCONEX  = 'T'
AND TC1_GC IS NULL
;

UPDATE QA_TTC1
SET TC1_GC = '31'
WHERE TC1_PERIODO = 202205
AND TC1_TIPCONEX  = 'T'
AND TC1_GC IS NULL
;


SELECT *
FROM QA_TTC1 
WHERE TC1_PERIODO=202205
;

COMMIT;



SELECT * FROM QA_TTC1
WHERE TC1_PERIODO = 202205;


---CAMPO TC1_TC1 , REVISAR DUPLICIDAD Y SI EXISTE MAS DE UNA VEZ VERIFICAR QUE SEAN DE DIFERENTE TC1_IDCOMER, PERO QUE NO EXISTA MAS DE 3 VECES(OK)

SELECT TC1_TC1, COUNT(*) AS RecuentoFilas 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205
GROUP BY TC1_TC1
HAVING COUNT(*) > 1
ORDER BY TC1_TC1; 



---CAMPO TC1_CODCONEX, SE REVISAN QUE TODOS LOS CODIGOS DE LA FORMA XT#####  SEAN TIPO "T" DEL CAMPO TC1_TIPCONEX (OK)

SELECT *
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TIPCONEX = 'P'
--AND TC1_TIPCONEX<>'T'
--AND TC1_CODCONEX LIKE 'ST%'; 
;

SELECT *
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TIPCONEX = 'P'
AND TC1_CODCIRC LIKE 'ST%';




UPDATE BRAE.QA_TTC1
SET   TC1_CODCONEX=TC1_CODCIRC
WHERE TC1_PERIODO=202205
AND TC1_TIPCONEX = 'P'
AND TC1_CODCIRC LIKE 'ST%';


COMMIT;


SELECT TC1_CODCONEX,TC1_TIPCONEX 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205 
AND TC1_CODCONEX LIKE '_T%'
AND TC1_TIPCONEX <> 'T'; 



---CAMPO TC1_TIPCONEX, SE VERIFICAN QUE ESTE CAMPO CONTENGA LOS VALORES 'T & P' Y HASTA EL MOMENTO SOLO EXISTEN 7 TIPO 'P' (OK)

SELECT TC1_CODCONEX,TC1_TIPCONEX 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TIPCONEX='P'; 


---CAMPO TC1_PROPACTIV, REVISAR LA RESOLUCION Y APLICAR PARA LOS 101 (ACTUALIZAR LA PROPIEDAD DE ACTIVOS DE LAS CALPS)(OK)


SELECT tc1_nt,TC1_PROPACTIV 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_NT <> '1'
AND tc1_propactiv<>101 
; 


SELECT * 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205
AND tc1_propactiv IS NULL 
; 


UPDATE QA_TTC1 
SET TC1_PROPACTIV = (SELECT (CASE WHEN TT2_PROPIEDAD = 'CENS'       THEN 100
                                  WHEN TT2_PROPIEDAD = 'PARTICULAR' THEN 0
                                  WHEN TT2_PROPIEDAD = 'COMPARTIDO' THEN 50
                             END)AS TT2_PROPIEDAD 
                     FROM QA_TTT2_REGISTRO 
                     WHERE TT2_ESTADO='OPERACION' 
                     AND TT2_CODIGOELEMENTO=TC1_CODCONEX)
WHERE TC1_TC1 LIKE 'CALP%'
AND TC1_PERIODO = 202205
;

UPDATE QA_TTC1 
SET TC1_PROPACTIV = '100'
--SELECT *FROM QA_TTC1
WHERE TC1_TC1 LIKE 'CALP%'
AND TC1_PERIODO = 202205
AND TC1_CODCONEX='1T13241'
;


SELECT DISTINCT TC1_NT FROM QA_TTC1 WHERE TC1_PERIODO=202205 AND TC1_TC1 LIKE 'CALP%';

SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_CODIGOELEMENTO='1T13241';

SELECT * FROM QA_TTC1;
COMMIT;

SELECT * FROM SPARD.TRANSFOR
WHERE CODE ='1T13241';

---CAMPO TC1_CONEXRED, REVISAR QUE CUMPLAN LOS VALORES 1 Y 2 (POBLAR ESTE CAMPO PARA LAS CALP)(OK)

SELECT TC1_CODCONEX,TC1_CONEXRED 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205 
AND TC1_CONEXRED IS NULL; 


UPDATE BRAE.QA_TTC1 T
SET   T.TC1_CONEXRED = (
                      SELECT (CASE WHEN TIPO_RED='A' THEN '1' ELSE '2' END) AS TIPO_RED 
                      FROM SPARD.TRANSFOR
                      WHERE CODE = T.TC1_CODCONEX
                      )
WHERE T.TC1_PERIODO=202205 
AND T.TC1_CONEXRED IS NULL; 

COMMIT;


SELECT CODE,(CASE WHEN TIPO_RED='A' THEN '1' ELSE '2' END) AS TIPO_RED 
FROM SPARD.TRANSFOR;

SELECT DISTINCT TC1_CODCONEX
              , TC1_CONEXRED
FROM QA_TTC1
WHERE TC1_PERIODO=202205;

SELECT * FROM QA_TTT2_REGISTRO;

SELECT DISTINCT TC1_CONEXRED FROM QA_TTC1 
WHERE TC1_PERIODO=202205
;

---CAMPO TC1_CODFRONCOM, REVISAR QUE TODOS LOS IDCOMER=604 CONTENGAN SOLO EL CODIGO DE FRONTERA OR0001, Y LOS DEMAS CONTENGAN UN  CODIGO DE FRONTERA FRTXXX
--(ACUTALIAR LOS CALP PARA LOS CODIGOS DE FRONTERAS)
SELECT TC1_TC1,TC1_IDCOMER,TC1_CODFRONCOM FROM BRAE.QA_TTC1
WHERE  TC1_PERIODO=202205 
AND    TC1_CODFRONCOM IS NULL; 

SELECT DISTINCT TC1_IDCOMER FROM BRAE.QA_TTC1
WHERE TC1_PERIODO = 202205 
;

---CAMPO TC1_CODCIRC,  REVISAR QUE TODOS TENGAN UN CODIGO, VER TABLA QA_TTT1_REGISTRO Y LA TABLA QA_TTT2_REGISTRO, TENER EN CUENTA LA RESOLUCION PARA IDENTFICAR COMO(OK)
SELECT TC1_TC1,TC1_CODCONEX, TC1_CODCIRC 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO = 202205 
and (TC1_CODCIRC IS NULL ); ACUTALIAR LAS CALPS Y REVISAR LOS AP

SELECT TC1_TC1,TC1_CODCONEX, TC1_CODCIRC, TT2_IUL 
FROM BRAE.QA_TTC1
LEFT OUTER JOIN (SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION') ON TT2_CODIGOELEMENTO=TC1_CODCONEX
WHERE TC1_PERIODO = 202205 
AND TC1_CODCIRC IS NOT NULL
AND TC1_CODCIRC <> TT2_IUL; 


---CAMPO TC1_CODTRANSF, REVISAR QUE TODOS LOS TIPO DE CONEXION 'T' CONTENGAN UN CODIGO IUA EN EL CAMPO TC1_CODTRANSF, VER REGLA EN LA RESOLUCION PARA LOS TIPO 'P'(OK)

SELECT TC1_TC1,TC1_TIPCONEX,TC1_CODTRANSF 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205 
AND TC1_CODTRANSF IS NULL 
AND TC1_TIPCONEX='P';

SELECT TC1_TC1,TC1_TIPCONEX,TC1_CODTRANSF 
FROM BRAE.QA_TTC1
WHERE TC1_PERIODO=202205 
AND TC1_TIPCONEX='T'
AND TC1_CODTRANSF IS NULL;

UPDATE BRAE.QA_TTC1
SET  TC1_CODTRANSF = TC1_IUA
WHERE TC1_PERIODO=202205 
AND TC1_TIPCONEX='T';

COMMIT;

---REQUERIMIENTO DE LEIDY ZARATE COMERCIALIZADOR INTERNO(OK)

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T12923'
,'1T08618'
,'1T12267'
,'1T12923'
,'1T12106');

SELECT * FROM QA_TTT2_REGISTRO;

SELECT * FROM QA_TTC1
WHERE TC1_TC1 IN ('1073140');

--INSERT INTO QA_TTC1
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1 IN ('1045931','656822');


COMMIT;


SELECT * FROM QA_TTC1
WHERE TC1_CODCONEX LIKE 'XT%'
AND TC1_PERIODO = 202205;

INSERT INTO QA_TTC1
SELECT * FROM QA_TTC1_TEMP;
COMMIT;



SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1 IN ('155363'
,'155406'
,'636860');

SELECT TT2_CODIGOELEMENTO, TT2_PROPIEDAD
FROM BRAE.QA_TTT2_REGISTRO;


--EXPORTAR TC1 PARA CONTINUAR EN EXCEL

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205;

SELECT CODE, MUNICIPIO FROM SPARD.TRANSFOR;

SELECT TT2_CODIGOELEMENTO,TT2_IUL FROM QA_TTT2_REGISTRO
WHERE TT2_ESTADO='OPERACION';


SELECT CODE,TT1_CODIGOCIRCUITO 
FROM SPARD.TRANSFOR
LEFT OUTER JOIN QA_TTT1_REGISTRO ON TT1_NOMBRECIRCUITO=FPARENT
;


SELECT * FROM QA_TTT1_REGISTRO;

SELECT TT2_CODIGOELEMENTO,TT2_NOMBRE_CIRCUITO FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T02482',	'1T00340',	'1T09818',	'4T01430',	'4T01429',	'4T01427',	'4T01426',	'4T01421',	'4T01422',	'4T01423',	'4T01424',	'4T01425',	'4T01428',	'4T01431',	'1T08032',	'1T08033',	'4T00361',	'4T01519',	'5T02729',	'4T01552',	'1T02263',	'4T01556',	'4T01551',	'4T01553',	'4T01554',	'5T02735',	'1T01731',	'1T11167',	'1T06765');


SELECT * FROM QA_TTT2_TEMP;


SELECT NODO_TRANSFORM_V,CIRCUITO
        FROM                CCONECTIVIDAD_E@GTECH  CON
            LEFT OUTER JOIN CCOMUN@GTECH           COM  ON  COM.G3E_FID            = CON.G3E_FID
            LEFT OUTER JOIN ETRANSFO_AT@GTECH      ET   ON  ET.G3E_FID             = COM.G3E_FID
            LEFT OUTER JOIN CPROPIETARIO@GTECH     CPRO ON  CPRO.G3E_FID           = CON.G3E_FID
            LEFT OUTER JOIN QA_TTT1_REGISTRO       TT1  ON  TT1.TT1_NOMBRECIRCUITO = CON.CIRCUITO
        WHERE               COM.G3E_FNO = 20400
        AND                 COM.ESTADO <> 'CONSTRUCCION';



SELECT DISTINCT TC1_CODCONEX,TC1_CODCIRC FROM QA_TTC1
WHERE TC1_CODCONEX IN ('4T01430'
,'4T01429'
,'4T01556'
,'4T01553'
,'4T01554'
,'5T02735'
,'1T01731'
)
AND TC1_PERIODO=202204;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T02482'
,'1T02263'
,'1T11167'
,'1T09818'
,'1T00340'
,'1T01731'
,'1T06765'
);



SELECT * FROM QA_TTC1
WHERE TC1_CODCONEX IN ('1T02482'
,'1T02263'
,'1T11167'
,'1T09818'
,'1T00340'
,'1T01731'
,'1T06765'
);



SELECT * FROM QA_TTT2_REGISTRO;


SELECT CODE,ADDRESS FROM SPARD.TRANSFOR;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO='1T01441';


SELECT TT2_CODE_CALP	
      ,TT2_CODIGOELEMENTO	
      ,TT2_AP_POTENCIA
FROM QA_TTT2_REGISTRO
WHERE TT2_ESTADO='OPERACION'
AND   TT2_CODE_CALP<>'0';


SELECT TC1_CODCONEX
      ,TC1_IDCOMER
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_TC1 LIKE 'CALP%';


SELECT COUNT(DISTINCT TT2_CODIGOELEMENTO) FROM QA_TTT2_REGISTRO; --22535
SELECT COUNT(DISTINCT TC1_CODCONEX) FROM QA_TTC1 WHERE TC1_PERIODO=202205 AND TC1_TIPCONEX = 'T'; --21812

SELECT 22535 - 21812 AS DIFERENCIA FROM DUAL;

SELECT DISTINCT TC1_IDCOMER FROM QA_TTC1 
WHERE TC1_PERIODO=202205;

DELETE FROM QA_TTC1_TEMP;

COMMIT;


DESC QA_TTC1;


SELECT COUNT(*) FROM QA_TTC1
WHERE TC1_PERIODO=202205;

SELECT DISTINCT TC1_IUA FROM QA_TTC1
WHERE TC1_PERIODO=202205
MINUS
SELECT DISTINCT TC1_IUA FROM QA_TTC1_TEMP
;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_IUA IN(SELECT DISTINCT TC1_IUA FROM QA_TTC1
                WHERE TC1_PERIODO=202205
                MINUS
                SELECT DISTINCT TC1_IUA FROM QA_TTC1_TEMP
);

SELECT DISTINCT TC1_IUA
FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_CODCONEX='1T01441';


UPDATE QA_TTC1_TEMP
SET   TC1_IUA = (
                SELECT DISTINCT TC1_IUA
                FROM QA_TTC1
                WHERE TC1_PERIODO=202205
                AND TC1_CODCONEX='1T01441'
                )
WHERE TC1_CODCONEX='1T01441';


COMMIT;

DELETE FROM QA_TTC1
WHERE TC1_PERIODO=202205;

COMMIT;


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205;

INSERT INTO QA_TTC1
SELECT * FROM QA_TTC1_TEMP;

COMMIT;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205;

DELETE FROM QA_TTC1_TEMP;

COMMIT;


SELECT * FROM QA_TTC1_TEMP;

/
DECLARE
BEGIN
SERVEROUTPUT ON; 
EXEC QA_PTC1_REGISTRO_FASE1(DATE'2022-06-01');
END;
/

SET SERVEROUTPUT ON; 
EXEC QA_PTC1_REGISTRO_FASE1(DATE'2022-06-01');


SELECT COUNT(*) FROM QA_TTC1_TEMP; --583070 WITHOUT ACCOUNT THE CALPS
SELECT COUNT(*) FROM QA_TTC1 WHERE TC1_PERIODO=202205; --587772







--LUEGO DE EJECUTAR QA_PTC1_REGISTRO_FASE1 ESTA CONSULTA NO ARROJA REGISTROS
    SELECT DISTINCT TC1_TC1 
    FROM  QA_TTC1 
    WHERE     TC1_PERIODO = 202205
        AND   TC1_TC1 NOT LIKE 'CALP%'
        AND   TC1_CODCONEX NOT LIKE 'ALPM%'
        AND   TC1_TIPCONEX = 'T'
        AND   TC1_IDCOMER='604'
MINUS
    SELECT DISTINCT TC1_TC1
    FROM  QA_TTC1_TEMP
    WHERE     TC1_TC1 NOT LIKE 'CALP%'
        AND   TC1_CODCONEX NOT LIKE 'ALPM%'
        AND   TC1_TIPCONEX = 'T'
        AND   TC1_IDCOMER='604'
;

--SUPERVISION DE TRAFOS DE REPOSICION AFECTADOS EN EL FORMATO DIARIO
SELECT * FROM OMS.INTERUPC
LEFT OUTER JOIN OMS.MANIOBRAS ON CODE=MINICIAL
WHERE TRUNC(FINICIAL)=DATE'2022-07-01'
AND CAUSA<>'PRUEBA'
AND TYPEEQUIP='Transformer'
AND TRAFO IN (SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
              WHERE TT2_ESTADO='RETIRADO') ;
              
              
SELECT DISTINCT TC1_PERIODO FROM QA_TTC1_TEMP;

UPDATE BRAE.QA_TTC1_TEMP
SET TC1_PERIODO = NULL
WHERE TC1_PERIODO IS NOT NULL
;

SELECT DISTINCT TC1_PERIODO FROM QA_TTC1_TEMP;

COMMIT;

-------------------------------------REALIZACION DE ACTUALIZACION DEL TRAFOS DE TC1 ANTERIOR PARA POSTERGAR PROCECDIMIENTO TC1 FASE 2

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_CODCONEX IN (
                    SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                    )
;

--ACTUALIZACION
UPDATE QA_TTC1
SET   TC1_IUA = (SELECT TT2_CODE_IUA FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION' AND TT2_CODIGOELEMENTO = TC1_CODCONEX)
WHERE TC1_PERIODO=202205
AND TC1_CODCONEX IN (
                    SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                    )
;

UPDATE QA_TTC1
SET   TC1_IUA=TC1_CODTRANSF
WHERE TC1_PERIODO=202205
AND TC1_CODCONEX = '1T12414';


--REVERSION DE LA ACTUALIZACION
UPDATE QA_TTC1
SET   TC1_IUA = (SELECT TT2_CODE_IUA FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION' AND TT2_CODIGOELEMENTO = TC1_CODCONEX)
WHERE TC1_PERIODO=202205
AND TC1_CODCONEX IN (
                    SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                    )
;

COMMIT;



SELECT (CASE WHEN(TT2_PROPIEDAD IN ('CENS','COMPARTIDO')) THEN(100) 
             WHEN(TT2_PROPIEDAD IN ('PARTICULAR'       )) THEN(0  )    
        END) AS TT2_PROPIEDAD 
FROM QA_TTT2_REGISTRO;

SELECT * FROM QA_TTT2_REGISTRO;

SELECT DISTINCT MUNICIPIO
FROM                CCONECTIVIDAD_E@GTECH  CON
    LEFT OUTER JOIN CCOMUN@GTECH           COM  ON  COM.G3E_FID            = CON.G3E_FID
WHERE               COM.G3E_FNO = 20400
AND                 COM.ESTADO = 'OPERACION'
;

UPDATE QA_TTC1_OBS
SET TC1_IUA = 'ALPM0001'
WHERE TC1_PERIODO= 202206
AND TC1_CODCONEX LIKE 'ALPM%';

COMMIT;

INSERT INTO QA_TTC1_TEMP
SELECT * FROM QA_TTC1_OBS
WHERE TC1_PERIODO = 202206
AND TC1_CODCONEX LIKE 'ALPM%';
COMMIT;


SELECT * FROM QA_TTC1_OBS
WHERE TC1_PERIODO = 202206;
ROLLBACK;
COMMIT;

UPDATE QA_TTC1_TEMP
SET TC1_PERIODO=202206
WHERE TC1_TIPCONEX='P'
;

COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_PERIODO IS NULL
AND TC1_TC1 NOT LIKE 'CALP%';--583070 + 6614  Rows
;

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_CALP <>'0'
AND TT2_ESTADO='OPERACION';


SELECT 583070 + 6613 - 245 FROM DUAL;-589438


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_PERIODO IS NOT NULL;--589438  Rows


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_PERIODO IS NOT NULL
AND TC1_TC1 LIKE 'CALP%';


DELETE FROM QA_TTC1_OBS
WHERE TC1_PERIODO = 202206
AND TC1_TIPCONEX = 'P';

COMMIT;



DELETE FROM QA_TTC1_TEMP
WHERE TC1_PERIODO IS NULL;

SELECT * FROM QA_TTC1_TEMP;

COMMIT;

SELECT COUNT(*) FROM QA_TTC1 WHERE TC1_PERIODO=202205; --587772

SELECT COUNT(*) FROM QA_TTC1_TEMP; --587772


SELECT DISTINCT TC1_CODCONEX,TC1_IUA FROM QA_TTC1 WHERE TC1_PERIODO=202205
MINUS
SELECT DISTINCT TC1_CODCONEX,TC1_IUA FROM QA_TTC1_TEMP;


SELECT DISTINCT TC1_CODCONEX,TC1_IUA FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX IN (SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO');
                    
SELECT DISTINCT TC1_CODCONEX,TC1_IUA FROM QA_TTC1 WHERE TC1_PERIODO = 202205
AND TC1_CODCONEX IN (SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO');
                    
SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX IN (SELECT DISTINCT TC1_CODCONEX FROM QA_TTC1 WHERE TC1_PERIODO=202205
                        MINUS
                        SELECT DISTINCT TC1_CODCONEX FROM QA_TTC1_TEMP);


SELECT * FROM QA_TTC1 WHERE TC1_PERIODO = 202205
AND TC1_CODCONEX IN(
                    SELECT DISTINCT TC1_CODCONEX FROM QA_TTC1_TEMP
                    MINUS
                    SELECT DISTINCT TC1_CODCONEX FROM QA_TTC1 WHERE TC1_PERIODO=202205
);


COMMIT;


SELECT * FROM QA_TTC1 WHERE TC1_PERIODO=202206;


INSERT INTO QA_TTC1
SELECT * FROM QA_TTC1_TEMP;

COMMIT;


SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202205
AND TC1_CODCONEX IN (
                    SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                    )
;


UPDATE QA_TTC1
SET TC1_IUA = TC1_CODTRANSF
WHERE TC1_PERIODO=202205
AND TC1_CODCONEX IN (
                    SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                    )
;



SELECT DISTINCT FDR_CODIGOEVENTO,FDR_FINICIAL, FDR_FFINAL FROM QA_TFDDREPORTE
WHERE FDR_PERIODO_OP=DATE'2020-12-15';




SELECT * FROM OMS.INTERUPC
LEFT OUTER JOIN OMS.MANIOBRAS ON CODE=MINICIAL
WHERE FINICIAL>=DATE'2020-01-01'
AND SCADA = 1;




---ACTUALIZAR CAMBIOS A COMERCIALIZADORA PARA MES DE JUNIO 2022

/*************************************************************/

SELECT *
FROM QA_TTC1_TEMP
WHERE TC1_TC1='15917'
;

INSERT INTO QA_TTC1_TEMP
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'2322' AS TC1_IDCOMER 
,	TC1_IDMERC
,	TC1_GC
,	'Frt46217' AS TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1_TEMP
WHERE TC1_TC1= '15917'   
;


COMMIT;


--EXPORTAR PARA COMERCIALIZADORAS


SELECT TT2_CODE_IUA,TT2_GRUPOCALIDAD FROM QA_TTT2_REGISTRO;




--REALIZACION DEL FORAMTO TC1 JULIO 2022
/*************************************************************/

DESC QA_TTC1_TEMP; 

SELECT * FROM QA_TTC1_TEMP;

UPDATE QA_TTC1_TEMP
SET TC1_CODCONEX=TC1_CODTRANSF
;

ROLLBACK;

COMMIT;

SELECT * FROM QA_TTC1_TEMP;

--DELETE FROM QA_TTC1_TEMP;

COMMIT;
SELECT * FROM QA_TTC1_TEMP WHERE TC1_PERIODO=202206 AND TC1_IDCOMER<>'604';

 --584.365  Rows
 
EXEC QA_PTC1_REGISTRO_FASE1(TO_DATE('01/07/2022','DD/MM/YYYY'));

EXEC QA_PTT2_REGISTRO(DATE'2022-07-01');

EXEC QA_PTC1_REGISTRO_FASE2(DATE'2022-07-01');


DELETE FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE 'XT%';

COMMIT;

SELECT * FROM QA_TTC1_OBS
WHERE TC1_PERIODO=202207
AND TC1_TC1 IN (
SELECT DISTINCT TC1_TC1 
    FROM  QA_TTC1 
    WHERE     TC1_PERIODO = 202206--MAX_PERIODO_TC1
        AND   TC1_TC1 NOT LIKE 'CALP%'
        AND   TC1_CODCONEX NOT LIKE 'ALPM%'
        AND   TC1_TIPCONEX = 'T'
        AND   TC1_IDCOMER='604'
MINUS
    SELECT DISTINCT TC1_TC1
    FROM  QA_TTC1_TEMP
    WHERE     TC1_TC1 NOT LIKE 'CALP%'
        AND   TC1_CODCONEX NOT LIKE 'ALPM%'
        AND   TC1_TIPCONEX = 'T'
        AND   TC1_IDCOMER='604'
);


SELECT * FROM QA_TTC1_TEMP;
SELECT * FROM QA_TTC1 WHERE TC1_PERIODO=202207;

INSERT INTO QA_TTC1
SELECT * FROM QA_TTC1_TEMP;

COMMIT;

EXEC QA_PFDDPRELIMINAR_AJ(DATE'2022-07-01');


SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_CODIGOEVENTO||FDD_CODIGOELEMENTO IN (
                             SELECT FDD_CODIGOEVENTO||FDD_CODIGOELEMENTO FROM QA_TFDDPRELIMINAR_AJ
                             )
UNION                             

SELECT * FROM QA_TFDDPRELIMINAR_AJ
;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_ESTADO='OPERACION';



/******************************************************************************************************************************************/
--*                        ACTUALIZAR CAMBIOS A COMERCIALIZADORA PARA MES DE JULIO 2022                                                   *
/******************************************************************************************************************************************/

SELECT *
FROM QA_TTC1_TEMP
WHERE TC1_TC1='180006'
--AND TC1_IDCOMER='26641'
;

DELETE QA_TTC1_TEMP
WHERE TC1_TC1='180006'
AND TC1_IDCOMER='26641'
;


rollback;
COMMIT;

INSERT INTO QA_TTC1_TEMP
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'45298' AS TC1_IDCOMER 
,	TC1_IDMERC
,	TC1_GC
,	'Frt34916' AS TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1_TEMP
WHERE TC1_TC1= '180006'   
;

--CANCELACION DE FRONTERA
UPDATE QA_TTC1_TEMP
SET TC1_IDCOMER = 604
   ,TC1_CODFRONCOM='OR0001'
WHERE TC1_TC1= '479556'  
;

--ACTUALIZACION DE AUTOGENERADORES DE COMERCIALIZADORA
UPDATE QA_TTC1_TEMP
SET TC1_AUTOGEN = 1
   ,TC1_EXPENER = 1
   ,TC1_CAPAUTOGENR = 1
   ,TC1_TIPGENR = 1
   ,TC1_CODFRONEXP = 'AGPE0001'
   ,TC1_FENTGEN = DATE'2022-07-14'
   ,TC1_CONTRESP = 2
WHERE TC1_TC1='76869'
;


COMMIT;

--CREAR TABLA  QA_TTC1_COMERCIALIZADORAS

CREATE TABLE QA_TTC1_COMERCIO(
 TC1_IDCOMER NUMBER
,TC1_DESCRIPCION VARCHAR2(400 BYTE)
);

DELETE FROM QA_TTC1_COMERCIO
WHERE TC1_IDCOMER IS NULL;

COMMIT;

SELECT * FROM QA_TTC1_COMERCIO;

SELECT DISTINCT TC1_IDCOMER FROM QA_TTC1
WHERE TC1_PERIODO=202206;

--Revision de los codigos IUL

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODFRONCOM IS NULL;


UPDATE QA_TTC1_TEMP T
SET T.TC1_CODCIRC = (SELECT DISTINCT TC1_CODCIRC FROM QA_TTC1 WHERE TC1_PERIODO=202205 AND TC1_TC1 = T.TC1_TC1)
WHERE T.TC1_CODCIRC IN ('NA','XYZ');


SELECT * FROM QA_TTC1_TEMP;


UPDATE QA_TTC1_TEMP
SET   TC1_CODFRONCOM = 'OR0001'
WHERE TC1_IDCOMER = '604';

SELECT DISTINCT TC1_CODFRONCOM FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER <> '604';

COMMIT;

SELECT * 
FROM QA_TTC1_TEMP
WHERE TC1_TIPCONEX='P'
;


UPDATE QA_TTC1_TEMP
SET TC1_IUA = TC1_CODCIRC
WHERE TC1_TIPCONEX='P'
;

COMMIT;

--EXPORTAR PARA COMERCIALIZADORAS

--COMPARTIR FORMATO TC1 COMERCIALIZADORA MAS TARDAR DIA 7 DE CADA MES

--EXTRACCION DEL ARCHIVO PARA COMENTARIOS COMERCIALIZADORAS
SELECT TC1_TC1 AS "NIU"
,TC1_IUA AS "Codigo de Conexión"
,(CASE WHEN(TC1_TIPCONEX='T') THEN(2) ELSE(1) END) AS "Tipo de Conexión"
,TC1_NT AS "Nivel de Tensión del usuario"
,TC1_NTP AS "Nivel de Tensión"
,(TC1_PROPACTIV) AS "% propiedad del Activo"
,(TC1_CONEXRED) AS "Conexión Red"
,(TC1_IDCOMER) AS "ID Comercializador"
,(TC1_IDMERC) AS "ID Mercado"
,(TC1_GC) AS "GRUPO CALIDAD"
,TC1_CODFRONCOM AS "Código Frontera Comercial"
,(TC1_CODCIRC) AS "Código Circuito o Línea"
,TC1_CODTRANSF AS "CODIGO TRANFORMADOR TT2"
,(TC1_CODDANE) AS "Código DANE NIU"
,(TC1_UBIC) AS "Ubicación"
,TC1_DIREC AS "Direccion"
,(TC1_CONESP) AS "Condiciones Especiales"
,(TC1_CODARESP) AS "TIPO DE AREA ESPECIAL"
,(TC1_TIPARESP) AS "CODIGO DE AREA ESPECIAL"
,(TC1_ESTSECT) AS "Estrato - Sector"
,TC1_ALTITUD AS "Altitud"
,TC1_LONGITUD AS "LONGITUD"
,TC1_LATITUD AS "LATITUD"
,(TC1_AUTOGEN) AS "Autogenerador"
,TC1_EXPENER AS "Exporta Energía"
,TC1_CAPAUTOGENR AS "Capacidad Autogenerador kw"
,TC1_TIPGENR AS "Tipo de Generación"
,TC1_CODFRONEXP AS "Codigo frontera Autogenarador"
,TC1_FENTGEN AS "Fecha Entrada en Operación"
,TC1_CONTRESP AS "Contrato de Respaldo"
,TC1_CAPCONTRESP AS "Capacidad Contrato de Respaldo"
FROM  QA_TTC1_TEMP 
WHERE   TC1_IDCOMER <> '604'
;


--AGRAGAMOS NEU ENERGY COMERCIALIZADORA A LA RESPECTIVA TABLA QA_TTC1_COMERCIO.

INSERT INTO QA_TTC1_COMERCIO
SELECT 45298,'NEU ENERGY S.A.S E.S.P' FROM DUAL;

COMMIT;

SELECT * FROM QA_TTC1_COMERCIO;

SELECT * FROM QA_TTC1_TEMP WHERE TC1_IUA='100J1T009B'; 

SELECT * FROM QA_TTT2_REGISTRO;


SELECT * FROM QA_tTC1 WHERE TC1_CODCONEX='2T02442';
SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_CODIGOELEMENTO='2T02442';


SELECT * FROM QA_TTC1_TEMP 
WHERE TC1_TC1 IN ('323792','60172','180006');

SELECT * FROM QA_TTC1_TEMP;


SELECT * FROM USER_DEPENDENCIES
WHERE NAME = 'QA_PTT2_REGISTRO';

SELECT * FROM USER_OBJECTS;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODFRONCOM='Frt13056';

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1='154655'
AND TC1_IDCOMER<>48305;

DELETE FROM QA_TTC1_TEMP
WHERE TC1_TC1='154655'
AND TC1_IDCOMER<>48305;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1='154655'
;

COMMIT;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T08222'
,'1T09227'
,'1T00267');


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('254553',	'254714',	'420126',	'452565');

SELECT TC1_TC1,TC1_IDCOMER,TC1_CODCONEX, TC1_CODFRONCOM,TC1_PERIODO FROM QA_TTC1
WHERE UPPER(TC1_CODFRONCOM)='FRT10180'
ORDER BY TC1_TC1,TC1_PERIODO;

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T08618','1T12267');

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202206
AND TC1_CODCONEX LIKE 'XT%';

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('407624',	'675264',	'1064078',	'1076160',	'1079599',	'1085382',	'1086308',	'1086823',	'1087549',	'1087885',	'1088479',	'1088662',	'1088674',	'1088675',	'1088693',	'1088765');
;


---INSERTAR USUARIOS PROVISIONALES DEL COMERCIALIZADOR INCUMBENTE
INSERT INTO QA_TTC1_TEMP
SELECT USUARIOS	 AS TC1_TC1
,   TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA 
          FROM (
                SELECT 	'407624' AS USUARIOS,'XT00001' AS CODCONEX	FROM DUAL UNION ALL
                SELECT 	'675264','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1064078','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1076160','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1079599','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1085382','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1086308','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1086823','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1087549','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1087885','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1088479','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1088662','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1088674','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1088675','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1088693','XT00001'	FROM DUAL UNION ALL
                SELECT 	'1088765','XT00001'	FROM DUAL
                )
LEFT OUTER JOIN (
                SELECT DISTINCT	TC1_CODCONEX
                ,	TC1_TIPCONEX
                ,	TC1_NT
                ,	TC1_NTP
                ,	TC1_PROPACTIV
                ,	TC1_CONEXRED
                ,	TC1_IDCOMER
                ,	TC1_IDMERC
                ,	TC1_GC
                ,	TC1_CODFRONCOM
                ,	TC1_CODCIRC
                ,	TC1_CODTRANSF
                ,	'54810000' AS TC1_CODDANE
                ,	TC1_UBIC
                ,	'NA' AS TC1_DIREC
                ,	TC1_CONESP
                ,	TC1_CODARESP
                ,	TC1_TIPARESP
                ,	TC1_ESTSECT
                ,	TC1_ALTITUD
                ,	TC1_LONGITUD
                ,	TC1_LATITUD
                ,	TC1_AUTOGEN
                ,	TC1_EXPENER
                ,	TC1_CAPAUTOGENR
                ,	TC1_TIPGENR
                ,	TC1_CODFRONEXP
                ,	TC1_FENTGEN
                ,	TC1_CONTRESP
                ,	TC1_CAPCONTRESP
                ,	'202207' AS TC1_PERIODO
                ,	TC1_IUA
                 FROM QA_TTC1
                WHERE TC1_PERIODO=202206
                AND TC1_CODCONEX LIKE 'XT%'
                ) ON TC1_CODCONEX = CODCONEX ;

COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE 'XT%';

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('254553',	'254714',	'420126',	'452565')
AND TC1_IDCOMER=27691;



SELECT * FROM QA_TTC1_TEMP;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T08618');


SELECT TC1_TC1,TC1_ESTSECT FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('455936'
,'455938'
,'494463'
,'354'
);



SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('381'
,'455936'
,'254554'
,'455938'
,'633840'
,'494463'
,'354'
);

COMMIT;



UPDATE QA_TTC1_TEMP
SET TC1_CONESP = 3
WHERE TC1_TC1 IN ('19131',
'455936',
'455939',
'455938');


COMMIT;

SELECT * FROM QA_TTC1_TEMP 
WHERE TC1_CODCONEX = '1T10050';


SELECT * FROM QA_TTC1_TEMP 
WHERE TC1_TC1 IN ('407624')
AND TC1_PERIODO=202207;


SELECT TC1_TC1,TC1_CODCONEX, TC1_CODTRANSF, TC1_IUA 
FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE 'XT%'
AND TC1_TC1 IN ('407624');



UPDATE QA_TTC1_TEMP
SET TC1_CODCONEX ='1T10050'
   ,TC1_CODTRANSF='100A6Y0001'
   ,TC1_IUA      ='100A6Y0001'
WHERE TC1_CODCONEX LIKE 'XT%'
AND TC1_TC1 IN ('407624');


SELECT * FROM QA_TTC1_TEMP 
WHERE TC1_CODCONEX = '1T10050'
AND TC1_TC1='407624';

UPDATE QA_TTC1_TEMP
SET   TC1_PROPACTIV=0
     ,TC1_GC=32
     ,TC1_DIREC='NOA VDA SAN ROQUE NO MINA  SAN MARTIN 3A NOA'
     ,TC1_ALTITUD=408
     ,TC1_CODCIRC='0100'
WHERE TC1_CODCONEX = '1T10050'
AND TC1_TC1='407624';


COMMIT;





--EXPORTAR PARA CERTIFICACION

SELECT TC1_CODCONEX AS CODIGO_TRANSFORMADOR 
,TC1_TC1 AS "NIU"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "Codigo de Conexión"
,(CASE WHEN(TC1_TIPCONEX='T') THEN(2) ELSE(1) END) AS "Tipo de Conexión"
,TC1_NT AS "Nivel de Tensión del usuario"
,TC1_NTP AS "Nivel de Tensión"
,(TC1_PROPACTIV) AS "% propiedad del Activo"
,(TC1_CONEXRED) AS "Conexión Red"
,(TC1_IDCOMER) AS "ID Comercializador"
,(TC1_IDMERC) AS "ID Mercado"
,(TC1_GC) AS "GRUPO CALIDAD"
,TC1_CODFRONCOM AS "Código Frontera Comercial"
,(TC1_CODCIRC) AS "Código Circuito o Línea"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "CODIGO TRANFORMADOR"
,(TC1_CODDANE) AS "Código DANE NIU"
,(TC1_UBIC) AS "Ubicación"
,TC1_DIREC AS "Direccion"
,(TC1_CONESP) AS "Condiciones Especiales"
,(TC1_CODARESP) AS "TIPO DE AREA ESPECIAL"
,(TC1_TIPARESP) AS "CODIGO DE AREA ESPECIAL"
,(TC1_ESTSECT) AS "Estrato - Sector"
,TC1_ALTITUD AS "Altitud"
,TC1_LONGITUD AS "LONGITUD"
,TC1_LATITUD AS "LATITUD"
,(TC1_AUTOGEN) AS "Autogenerador"
,TC1_EXPENER AS "Exporta Energía"
,TC1_CAPAUTOGENR AS "Capacidad Autogenerador kw"
,TC1_TIPGENR AS "Tipo de Generación"
,TC1_CODFRONEXP AS "Codigo frontera Autogenarador"
,TC1_FENTGEN AS "Fecha Entrada en Operación"
,TC1_CONTRESP AS "Contrato de Respaldo"
,TC1_CAPCONTRESP AS "Capacidad Contrato de Respaldo"
FROM  QA_TTC1_TEMP
LEFT OUTER JOIN (
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='OPERACION'
                    AND TT2_CODIGOELEMENTO NOT IN (
                                                    SELECT DISTINCT TT2_CODIGOELEMENTO
                                                    FROM QA_TTT2_REGISTRO
                                                    WHERE TT2_ESTADO='RETIRADO'
                                                   )
                UNION ALL
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                ) ON TT2_CODIGOELEMENTO = TC1_CODCONEX
;

SELECT CODE,LONGITUD,LATITUD FROM SPARD.TRANSFOR
;

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_CALP<>'0'
AND TT2_ESTADO='OPERACION';


DESC QA_TTC1;





UPDATE QA_TTC1_TEMP
SET TC1_LONGITUD = NULL
   ,TC1_LATITUD = NULL
;

COMMIT;



ALTER TABLE QA_TTC1_TEMP
MODIFY (TC1_LONGITUD NUMBER(5,6)
      , TC1_LATITUD NUMBER(5,6)
        );


SELECT COUNT(*) FROM QA_TTC1
WHERE TC1_LATITUD IS NOT NULL;

ALTER TABLE QA_TTC1_TEMP
MODIFY TC1_CODCIRC VARCHAR2(50);



UPDATE QA_TTC1
SET TC1_LATITUD = NULL
WHERE TC1_LATITUD IS NOT NULL
;
COMMIT; 


SELECT * FROM QA_TTC1_TEMP;
DELETE FROM QA_TTC1_TEMP;


DESC QA_TTC1;


ALTER TABLE QA_TTC1
MODIFY (TC1_LONGITUD NUMBER(10,7)
      , TC1_LATITUD NUMBER(10,7)
        );

/*************************************************************/
/***--REALIZACION DEL FORAMTO TC1 AGOSTO 2022                */
/*************************************************************/

DESC QA_TTC1_TEMP; 

SELECT * FROM QA_TTC1_TEMP;

EXEC QA_PTC1_REGISTRO_FASE1(DATE'2022-08-01');

EXEC QA_PTT2_REGISTRO(DATE'2022-08-01');

EXEC QA_PTC1_REGISTRO_FASE2(DATE'2022-08-01');



SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE'XT%';

DELETE FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE 'XT%';

COMMIT;

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN(
                            SELECT DISTINCT TC1_CODCONEX FROM QA_TTC1_OBS
                            WHERE TC1_PERIODO=202208 
                            AND TC1_CODCONEX NOT IN (
                            'SAC00000'
                            ,'9T99999'
                            ,'6T00068'
                            ,'0TV00000')
);

SELECT * FROM QA_TTC1_OBS
WHERE TC1_CODCONEX IN ('1T06842'
,'5T00691'
,'5T00691');


SELECT * FROM QA_TTC1_OBS
WHERE TC1_PERIODO=202208
AND TC1_TC1 IN (
SELECT DISTINCT TC1_TC1 
    FROM  QA_TTC1 
    WHERE     TC1_PERIODO = 202207--MAX_PERIODO_TC1
        AND   TC1_TC1 NOT LIKE 'CALP%'
        AND   TC1_CODCONEX NOT LIKE 'ALPM%'
        AND   TC1_TIPCONEX = 'T'
        AND   TC1_IDCOMER='604'
MINUS
    SELECT DISTINCT TC1_TC1
    FROM  QA_TTC1_TEMP
    WHERE     TC1_TC1 NOT LIKE 'CALP%'
        AND   TC1_CODCONEX NOT LIKE 'ALPM%'
        AND   TC1_TIPCONEX = 'T'
        AND   TC1_IDCOMER='604'
)
;


SELECT * FROM QA_TTC1_TEMP;
SELECT * FROM QA_TTC1 WHERE TC1_PERIODO=202207;

INSERT INTO QA_TTC1
SELECT * FROM QA_TTC1_TEMP;

COMMIT;

EXEC QA_PFDDPRELIMINAR_AJ(DATE'2022-07-01');


SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_CODIGOEVENTO||FDD_CODIGOELEMENTO IN (
                             SELECT FDD_CODIGOEVENTO||FDD_CODIGOELEMENTO FROM QA_TFDDPRELIMINAR_AJ
                             )
UNION                             

SELECT * FROM QA_TFDDPRELIMINAR_AJ
;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_ESTADO='OPERACION';


SELECT * 
FROM QA_TTT2_TEMP
WHERE TT2_NOMBRE_CIRCUITO IN ('SEVC19');

UPDATE QA_TTT2_REGISTRO
SET   TT2_NOMBRE_CIRCUITO = 'TIBTIBU1' 
WHERE TT2_NOMBRE_CIRCUITO IN ('TIBC1');

COMMIT;

SELECT * FROM QA_TTT1_REGISTRO;

--,'AYACSAUX'
--,'BUTCSAUX'
--,'TIBCSAUX'
);

SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
MINUS
SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_BACKUP;


SELECT TT2_CODIGOELEMENTO,COUNT(TT2_CODIGOELEMENTO) FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN(
                            SELECT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                            WHERE TT2_ESTADO='RETIRADO')
GROUP BY TT2_CODIGOELEMENTO                            ;


SELECT * FROM QA_tTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN (SELECT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                            WHERE TT2_ESTADO='RETIRADO');
                            
                            
SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_PERIODO_OP=DATE'2022-08-01';

SELECT * FROM QA_TTT2_REPORTE
WHERE TT2_CODE_TRAFO IN (SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_OBS);       




DELETE FROM QA_TTT2_REGISTRO;

INSERT INTO QA_TTT2_REGISTRO
SELECT * FROM QA_TTT2_BACKUP;


SELECT * FROM QA_TTT2_REGISTRO;

COMMIT;

DELETE FROM QA_TTC1_OBS
WHERE TC1_PERIODO=202208;

COMMIT;

SELECT * FROM QA_TTC1_TEMP;


DELETE FROM QA_TTC1_TEMP;

SELECT * FROM ALL_TABLES
WHERE OWNER = 'BRAE'
AND TABLE_NAME LIKE 'QA_TTT2%';

SELECT * FROM QA_TTT2_BRAFO
WHERE TT2_PERIODO_OP=DATE'2022-08-01';


----------------------------
SELECT * FROM QA_TTC1_TEMP;

EXEC QA_PTC1_REGISTRO_FASE1(DATE'2022-08-01');

EXEC QA_PTT2_REGISTRO(DATE'2022-08-01');

EXEC QA_PTC1_REGISTRO_FASE2(DATE'2022-08-01');

SELECT * FROM QA_TTC1_OBS
WHERE TC1_PERIODO=202207;



SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO='5T00691';





SELECT * FROM QA_TTT2_REPORTE
WHERE TT2_CODE_tRAFO IN(
SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_TTT2_OBS);

SELECT * FROM QA_TTT2_OBS
WHERE TT2_CODIGOELEMENTO IN ('5T00691');


--5T00691


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('5T01343','5T00152');

SELECT TT2_CODIGOELEMENTO, COUNT(TT2_CODIGOELEMENTO) FROM QA_tTT2_REGISTRO
GROUP BY TT2_CODIGOELEMENTO;


SELECT * FROM QA_TTT2_BACKUP;

SELECT * FROM QA_tTT2_REGISTRO
WHERE TT2_CODE_IUA IN ('100JGF009B','100JGW009C');


DELETE FROM QA_tTT2_REGISTRO
WHERE TT2_CODE_IUA IN ('100JGF009B','100JGW009C');

COMMIT;

--INSERT INTO QA_TTT2_REGISTRO
SELECT * FROM QA_tTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO = '5T00691';

UPDATE QA_TTT2_REGISTRO
SET TT2_UNIDAD_CONSTRUCTIVA = 'N1T38'
,   TT2_CODE_IUA = '100JF60107'
,   TT2_ALTITUD = 2025
,   TT2_TIPOINVERSION = 3
WHERE TT2_UNIDAD_CONSTRUCTIVA = 'N/A#'; 


DELETE FROM QA_tTT2_REGISTRO
WHERE TT2_CODE_IUA = '100JF60107'
AND TT2_ESTADO ='RETIRADO';




DELETE FROM QA_tTT2_OBS
WHERE TT2_CODIGOELEMENTO = '5T00691';



SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX NOT LIKE 'ALPM%'
AND TC1_TIPCONEX NOT IN ('P');


SELECT COUNT(TC1_TC1) FROM QA_TTC1_TEMP;-- WHERE TC1_PERIODO=202207;--

SELECT 592307-590798 FROM DUAL;

SELECT * FROM QA_TTC1_TEMP;

INSERT INTO QA_TTC1
SELECT * FROM QA_TTC1_TEMP;

SELECT MAX(TC1_PERIODO) FROM QA_TTC1;


COMMIT;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 = '1045221';

SELECT * FROM QA_TTC1_COMERCIO;




/****************************************************************************************************************
***************************************EXPORTAR PARA COMERCIALIZADORA***AGOSTO**2022*****************************
****************************************************************************************************************/


--EXPORTAR PARA CERTIFICACION

SELECT TC1_CODCONEX AS CODIGO_TRANSFORMADOR 
,TC1_TC1 AS "NIU"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "Codigo de Conexión"
,(CASE WHEN(TC1_TIPCONEX='T') THEN(2) ELSE(1) END) AS "Tipo de Conexión"
,TC1_NT AS "Nivel de Tensión del usuario"
,TC1_NTP AS "Nivel de Tensión"
,(TC1_PROPACTIV) AS "% propiedad del Activo"
,(TC1_CONEXRED) AS "Conexión Red"
,(TC1_IDCOMER) AS "ID Comercializador"
,(TC1_IDMERC) AS "ID Mercado"
,(TC1_GC) AS "GRUPO CALIDAD"
,TC1_CODFRONCOM AS "Código Frontera Comercial"
,(TC1_CODCIRC) AS "Código Circuito o Línea"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "CODIGO TRANFORMADOR"
,(TC1_CODDANE) AS "Código DANE NIU"
,(TC1_UBIC) AS "Ubicación"
,TC1_DIREC AS "Direccion"
,(TC1_CONESP) AS "Condiciones Especiales"
,(TC1_CODARESP) AS "TIPO DE AREA ESPECIAL"
,(TC1_TIPARESP) AS "CODIGO DE AREA ESPECIAL"
,(TC1_ESTSECT) AS "Estrato - Sector"
,TC1_ALTITUD AS "Altitud"
,TC1_LONGITUD AS "LONGITUD"
,TC1_LATITUD AS "LATITUD"
,(TC1_AUTOGEN) AS "Autogenerador"
,TC1_EXPENER AS "Exporta Energía"
,TC1_CAPAUTOGENR AS "Capacidad Autogenerador kw"
,TC1_TIPGENR AS "Tipo de Generación"
,TC1_CODFRONEXP AS "Codigo frontera Autogenarador"
,TC1_FENTGEN AS "Fecha Entrada en Operación"
,TC1_CONTRESP AS "Contrato de Respaldo"
,TC1_CAPCONTRESP AS "Capacidad Contrato de Respaldo"
FROM  QA_TTC1_TEMP
LEFT OUTER JOIN (
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='OPERACION'
                    AND TT2_CODIGOELEMENTO NOT IN (
                                                    SELECT DISTINCT TT2_CODIGOELEMENTO
                                                    FROM QA_TTT2_REGISTRO
                                                    WHERE TT2_ESTADO='RETIRADO'
                                                   )
                UNION ALL
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                ) ON TT2_CODIGOELEMENTO = TC1_CODCONEX
WHERE TC1_IDCOMER <> '604'
;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_IUA='100JGM009B';

SELECT * FROM QA_TTC1_TEMP
WHERE UPPER(TC1_CODFRONCOM)='FRT03370';

SELECT * FROM QA_TTC1 
WHERE TC1_PERIODO=202206
AND UPPER(TC1_CODFRONCOM) IN ('FRT03370','FRT38279');

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_ESTADO IN ('OPERACION','RETIRADO')
AND TT2_CODIGOELEMENTO IN ('1T06842','1T09433');


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_PERIODO_OP=DATE'2022-08-01';


SELECT * FROM SPARD.TRANSFOR
WHERE CODE = '1T06842';

SELECT * FROM QA_TTT2_TEMP
WHERE TT2_CODIGOELEMENTO ='1T06842';

SELECT *
        FROM                CCONECTIVIDAD_E@GTECH  CON
            LEFT OUTER JOIN CCOMUN@GTECH           COM  ON  COM.G3E_FID            = CON.G3E_FID
            LEFT OUTER JOIN ETRANSFO_AT@GTECH      ET   ON  ET.G3E_FID             = COM.G3E_FID
            LEFT OUTER JOIN CPROPIETARIO@GTECH     CPRO ON  CPRO.G3E_FID           = CON.G3E_FID
            LEFT OUTER JOIN QA_TTT1_REGISTRO       TT1  ON  TT1.TT1_NOMBRECIRCUITO = CON.CIRCUITO
        WHERE               COM.G3E_FNO = 20400
        AND                 COM.ESTADO <> 'CONSTRUCCION'
        AND NODO_TRANSFORM_V = '1T06842'
        ;


SELECT * FROM QA_TTC1
WHERE TC1_CODCONEX = '1T09433'
and TC1_PERIODO=202208;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T09433');--1009SF0001 --1009SF0001

INSERT INTO QA_TTC1_TEMP
SELECT 	TC1_TC1
,	'1T08179' AS TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'2322' AS TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	'FRT03370' AS TC1_CODFRONCOM
,	TC1_CODCIRC
,	'100JFG010E' AS TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	202208 AS TC1_PERIODO
,	'100JFG010E' AS TC1_IUA 
FROM QA_TTC1
WHERE TC1_CODCONEX  = '1T06842'
AND TC1_PERIODO=202207;

SELECT * FROM QA_TTC1
WHERE UPPER(TC1_CODFRONCOM)='FRT03370';

SELECT * FROM QA_tTT2_rEGISTRO
WHERE TT2_CODIGOELEMENTO='1T08179';

COMMIT;

UPDATE QA_TTC1
SET TC1_CONESP = 9
WHERE TC1_TC1 IN ('228',	'11956',	'478975',	'464763',	'464170',	'188795',	'384',	'30',	'591575',	'589777',	'583609',	'583594',	'583588',	'390',	'150642',	'411651',	'410510',	'377',	'192523',	'155162',	'267707',	'188888',	'498015',	'200',	'132',	'53151',	'569518',	'254529',	'254557',	'254554',	'356',	'668205',	'494463',	'186746',	'433456',	'457492',	'155365',	'253',	'154946',	'370',	'368',	'364',	'362',	'358',	'62384',	'550768',	'512104',	'308533',	'306218',	'297803',	'463013',	'540566',	'319649',	'233892',	'233523',	'484621',	'212967')
AND TC1_PERIODO=202208;

UPDATE QA_tTC1_TEMP
SET TC1_CODARESP = 0
,   TC1_TIPARESP = 0
WHERE TC1_TC1 IN (
'233523',
'254557',
'254554',
'569518')
AND TC1_PERIODO=202208;

ROLLBACK;
COMMIT;

update QA_tTC1
SET TC1_CONESP=9
WHERE TC1_TC1 IN ('377',	'411651',	'410510',	'540566',	'478975',	'498015',	'200',	'132',	'494463',	'186746',	'433456',	'233523',	'254557',	'254554',	'455936',	'484621',	'188888',	'464763',	'464170',	'457492',	'297803',	'192523',	'356',	'155046',	'569518',	'390',	'150642',	'368',	'364',	'362',	'358',	'202283',	'19131',	'155162',	'267707',	'212967',	'384',	'591575',	'583594',	'583588',	'512104',	'306218',	'30',	'455939',	'455938',	'668205',	'155365',	'253',	'154946',	'370')
AND TC1_CONESP<>9
AND TC1_PERIODO=202208;

UPDATE QA_tTC1_TEMP SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '494463' AND TC1_PERIODO=202208;
UPDATE QA_tTC1_TEMP SET TC1_ESTSECT = 9 WHERE TC1_TC1 = '254554' AND TC1_PERIODO=202208;
UPDATE QA_tTC1_TEMP SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '455936' AND TC1_PERIODO=202208;
UPDATE QA_tTC1_TEMP SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '155046' AND TC1_PERIODO=202208;
UPDATE QA_tTC1_TEMP SET TC1_ESTSECT = 8 WHERE TC1_TC1 = '381' AND TC1_PERIODO=202208;
UPDATE QA_tTC1_TEMP SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '455938' AND TC1_PERIODO=202208;
UPDATE QA_tTC1_TEMP SET TC1_ESTSECT = 8 WHERE TC1_TC1 = '633840' AND TC1_PERIODO=202208;
UPDATE QA_tTC1_TEMP SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '354' AND TC1_PERIODO=202208;


UPDATE QA_tTC1 SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '494463' AND TC1_PERIODO=202208;
UPDATE QA_tTC1 SET TC1_ESTSECT = 9 WHERE TC1_TC1 = '254554' AND TC1_PERIODO=202208;
UPDATE QA_tTC1 SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '455936' AND TC1_PERIODO=202208;
UPDATE QA_tTC1 SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '155046' AND TC1_PERIODO=202208;
UPDATE QA_tTC1 SET TC1_ESTSECT = 8 WHERE TC1_TC1 = '381' AND TC1_PERIODO=202208;
UPDATE QA_tTC1 SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '455938' AND TC1_PERIODO=202208;
UPDATE QA_tTC1 SET TC1_ESTSECT = 8 WHERE TC1_TC1 = '633840' AND TC1_PERIODO=202208;
UPDATE QA_tTC1 SET TC1_ESTSECT = 7 WHERE TC1_TC1 = '354' AND TC1_PERIODO=202208;

COMMIT;






SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('426',	'11090',	'15304',	'263987',	'451857',	'451859',	'451860',	'457292',	'478809');
/
BEGIN
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '290', TC1_LONGITUD='-72.5021542', TC1_LATITUD='7.09083554' WHERE TC1_TC1 = '426' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '307', TC1_LONGITUD='-72.499102', TC1_LATITUD='7.888875' WHERE TC1_TC1 = '11090' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '304', TC1_LONGITUD='-72.484538', TC1_LATITUD='7.893286' WHERE TC1_TC1 = '15304' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '245', TC1_LONGITUD='-72.6309361', TC1_LATITUD='7.9063323' WHERE TC1_TC1 = '263987' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '283', TC1_LONGITUD='-72.4941209', TC1_LATITUD='7.9158277' WHERE TC1_TC1 = '451857' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '283', TC1_LONGITUD='-72.4937897', TC1_LATITUD='7.9178903' WHERE TC1_TC1 = '451859' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '283', TC1_LONGITUD='-72.4941209', TC1_LATITUD='7.9158277' WHERE TC1_TC1 = '451860' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '308', TC1_LONGITUD='-72.4967954', TC1_LATITUD='7.887864' WHERE TC1_TC1 = '457292' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1_TEMP SET TC1_ALTITUD = '245', TC1_LONGITUD='-72.630014', TC1_LATITUD='7.906366' WHERE TC1_TC1 = '478809' AND TC1_PERIODO = 202208;
END;
/

BEGIN
UPDATE QA_TTC1 SET TC1_ALTITUD = '290', TC1_LONGITUD='-72.5021542', TC1_LATITUD='7.09083554' WHERE TC1_TC1 = '426' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1 SET TC1_ALTITUD = '307', TC1_LONGITUD='-72.499102', TC1_LATITUD='7.888875' WHERE TC1_TC1 = '11090' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1 SET TC1_ALTITUD = '304', TC1_LONGITUD='-72.484538', TC1_LATITUD='7.893286' WHERE TC1_TC1 = '15304' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1 SET TC1_ALTITUD = '245', TC1_LONGITUD='-72.6309361', TC1_LATITUD='7.9063323' WHERE TC1_TC1 = '263987' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1 SET TC1_ALTITUD = '283', TC1_LONGITUD='-72.4941209', TC1_LATITUD='7.9158277' WHERE TC1_TC1 = '451857' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1 SET TC1_ALTITUD = '283', TC1_LONGITUD='-72.4937897', TC1_LATITUD='7.9178903' WHERE TC1_TC1 = '451859' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1 SET TC1_ALTITUD = '283', TC1_LONGITUD='-72.4941209', TC1_LATITUD='7.9158277' WHERE TC1_TC1 = '451860' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1 SET TC1_ALTITUD = '308', TC1_LONGITUD='-72.4967954', TC1_LATITUD='7.887864' WHERE TC1_TC1 = '457292' AND TC1_PERIODO = 202208;
UPDATE QA_TTC1 SET TC1_ALTITUD = '245', TC1_LONGITUD='-72.630014', TC1_LATITUD='7.906366' WHERE TC1_TC1 = '478809' AND TC1_PERIODO = 202208;
END;
/

COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_PERIODO=202208
AND TC1_TC1 IN ('308768','451861')
AND TC1_IDCOMER = '2020';

DELETE FROM QA_TTC1
WHERE TC1_PERIODO=202208
AND TC1_TC1 IN ('308768','451861')
AND TC1_IDCOMER = '2020';


SELECT * FROM QA_TTC1
WHERE TC1_TC1 = '263987'
ORDER BY TC1_PERIODO;


COMMIT;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER=2020
AND TC1_PERIODO=202208;


INSERT INTO QA_TTC1_TEMP
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'2020' AS TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	'FRT22836' AS TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA 
FROM QA_TTC1
WHERE TC1_TC1  = '263987'
AND TC1_PERIODO=202208;

SELECT * FROM QA_TTC1 WHERE TC1_TC1 = '263987'
ORDER BY TC1_PERIODO;


COMMIT;

SELECT * FROM QA_TTC1_TEMP T
WHERE TC1_TC1 IN ('478809','263987')
AND TC1_IDCOMER=2020
AND TC1_PERIODO=202208
;

UPDATE QA_TTC1_TEMP 
SET TC1_AUTOGEN = 1
,	TC1_EXPENER = 1
,	TC1_CAPAUTOGENR = 100
,	TC1_TIPGENR = 1
,	TC1_CODFRONEXP = 'Frt46573'
,	TC1_FENTGEN = DATE'2022-07-24'
,	TC1_CONTRESP = 2
WHERE TC1_TC1 IN ('478809')
AND TC1_IDCOMER=2020
AND TC1_PERIODO=202208
;

COMMIT;


select * from qa_ttc1_Temp where tc1_tc1 = '45';


SELECT * FROM QA_TTC1_temp WHERE TC1_CODFRONCOM = 'FRT13009' and tc1_periodo=202208;

SELECT TC1_TC1
FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER='604';


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO='1T12267';

SELECT * FROM QA_TTC1
WHERE TC1_TC1 = '407624'
ORDER BY TC1_PERIODO;

SELECT * FROM QA_TTT2_REPORTE
WHERE TT2_CODE_TRAFO='1T08618';


SELECT * FROM QA_TTC1_temp
WHERE TC1_TC1 in ('407624',	'675264',	'1032059',	'1064078',	'1079599',	'1086308',	'1088087',	'1088817',	'1088902',	'1089124',	'1089471',	'1089551',	'1089739',	'1089741',	'1089742',	'1089743',	'1089744',	'1090242',	'1090248',	'1090509',	'1090510',	'1090724') ;

--INSERT INTO QA_TTC1
SELECT  
 TI.    TC1_TC1
,TE.	TC1_CODCONEX
,TE.	TC1_TIPCONEX
,TE.	TC1_NT
,TE.	TC1_NTP
,TE.	TC1_PROPACTIV
,TE.	TC1_CONEXRED
,TE.	TC1_IDCOMER
,TE.	TC1_IDMERC
,TE.	TC1_GC
,TE.	TC1_CODFRONCOM
,TE.	TC1_CODCIRC
,TE.	TC1_CODTRANSF
,TE.	TC1_CODDANE
,TE.	TC1_UBIC
,TE.	TC1_DIREC
,TE.	TC1_CONESP
,TE.	TC1_CODARESP
,TE.	TC1_TIPARESP
,TE.	TC1_ESTSECT
,TE.	TC1_ALTITUD
,TE.	TC1_LONGITUD
,TE.	TC1_LATITUD
,TE.	TC1_AUTOGEN
,TE.	TC1_EXPENER
,TE.	TC1_CAPAUTOGENR
,TE.	TC1_TIPGENR
,TE.	TC1_CODFRONEXP
,TE.	TC1_FENTGEN
,TE.	TC1_CONTRESP
,TE.	TC1_CAPCONTRESP
,'202208' AS TC1_PERIODO
,TE.	TC1_IUA
FROM QA_TTC1 TE
LEFT OUTER JOIN(
SELECT * FROM(
                SELECT '407624'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '675264'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1032059'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1064078'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1079599'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1086308'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1088087'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1088817'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1088902'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1089124'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1089471'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1089551'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1089739'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1089741'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1089742'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1089743'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1089744'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1090242'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1090248'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1090509'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1090510'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL UNION
                SELECT '1090724'AS TC1_TC1 ,'XT00001' AS TC1_CODCONEX FROM DUAL)
                ) TI ON TI.TC1_CODCONEX = TE.TC1_CODCONEX
WHERE TE.TC1_PERIODO=202207
AND TE.TC1_CODCONEX LIKE 'XT%'
AND TE.TC1_TC1='1064078';


SELECT DISTINCT TC1_CODFRONCOM FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER=604;

UPDATE QA_TTC1_TEMP
SET TC1_CODFRONCOM='OR0001'
WHERE TC1_IDCOMER=604;

SELECT COUNT(*) FROM QA_tTC1_TEMP;

COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX NOT LIKE 'ALPM%'
AND TC1_TIPCONEX NOT IN ('P')
;--AND TC1_CODCIRC = 'NA';


UPDATE QA_TTC1_TEMP T
SET   TC1_CODCIRC = (SELECT DISTINCT TC1_CODCIRC FROM QA_TTC1 WHERE TC1_PERIODO=202207 AND TC1_TC1=T.TC1_TC1)
WHERE TC1_CODCONEX NOT LIKE 'ALPM%'
AND TC1_TIPCONEX NOT IN ('P')
AND TC1_CODCIRC = 'NA';



DELETE FROM QA_TTC1_TEMP
WHERE TC1_TC1='1046636'
AND TC1_CODCONEX='2T01495';
COMMIT;



SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX  LIKE 'ALPM%'
OR TC1_TIPCONEX IN ('P')
;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX  LIKE 'ALPM%'
;


UPDATE QA_TTC1_TEMP
SET TC1_CODCIRC = NULL
WHERE TC1_CODCONEX  LIKE 'ALPM%'
;

COMMIT;


UPDATE QA_TTC1_TEMP T
SET TC1_CODTRANSF = NULL
,   TC1_CODCIRC = (SELECT DISTINCT TC1_CODCIRC FROM QA_TTC1 WHERE TC1_PERIODO=202207 AND TC1_TC1=T.TC1_TC1)
WHERE TC1_TIPCONEX IN ('P')
;

SELECT * FROM QA_tTC1_TEMP
WHERE TC1_TIPCONEX='P';

UPDATE QA_tTC1_TEMP
SET   TC1_IUA = TC1_CODCONEX
WHERE TC1_TIPCONEX='P';

COMMIT;


DELETE FROM QA_TTC1
WHERE TC1_PERIODO=202208;


INSERT INTO QA_TTC1
SELECT * FROM QA_TTC1_TEMP;

/****************************************************************************************************************
***************************************EXPORTAR PARA CERTIFICACION***AGOSTO**2022********************************
****************************************************************************************************************/


--EXPORTAR PARA CERTIFICACION

SELECT TC1_CODCONEX AS CODIGO_TRANSFORMADOR 
,TC1_TC1 AS "NIU"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "Codigo de Conexión"
,(CASE WHEN(TC1_TIPCONEX='T') THEN(2) ELSE(1) END) AS "Tipo de Conexión"
,TC1_NT AS "Nivel de Tensión del usuario"
,TC1_NTP AS "Nivel de Tensión"
,(TC1_PROPACTIV) AS "% propiedad del Activo"
,(TC1_CONEXRED) AS "Conexión Red"
,(TC1_IDCOMER) AS "ID Comercializador"
,(TC1_IDMERC) AS "ID Mercado"
,(TC1_GC) AS "GRUPO CALIDAD"
,TC1_CODFRONCOM AS "Código Frontera Comercial"
,(TC1_CODCIRC) AS "Código Circuito o Línea"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "CODIGO TRANFORMADOR"
,(TC1_CODDANE) AS "Código DANE NIU"
,(TC1_UBIC) AS "Ubicación"
,TC1_DIREC AS "Direccion"
,(TC1_CONESP) AS "Condiciones Especiales"
,(TC1_CODARESP) AS "TIPO DE AREA ESPECIAL"
,(TC1_TIPARESP) AS "CODIGO DE AREA ESPECIAL"
,(TC1_ESTSECT) AS "Estrato - Sector"
,TC1_ALTITUD AS "Altitud"
,TC1_LONGITUD AS "LONGITUD"
,TC1_LATITUD AS "LATITUD"
,(TC1_AUTOGEN) AS "Autogenerador"
,TC1_EXPENER AS "Exporta Energía"
,TC1_CAPAUTOGENR AS "Capacidad Autogenerador kw"
,TC1_TIPGENR AS "Tipo de Generación"
,TC1_CODFRONEXP AS "Codigo frontera Autogenarador"
,TC1_FENTGEN AS "Fecha Entrada en Operación"
,TC1_CONTRESP AS "Contrato de Respaldo"
,TC1_CAPCONTRESP AS "Capacidad Contrato de Respaldo"
FROM  QA_TTC1_TEMP
LEFT OUTER JOIN (
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='OPERACION'
                    AND TT2_CODIGOELEMENTO NOT IN (
                                                    SELECT DISTINCT TT2_CODIGOELEMENTO
                                                    FROM QA_TTT2_REGISTRO
                                                    WHERE TT2_ESTADO='RETIRADO'
                                                   )
                UNION ALL
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                ) ON TT2_CODIGOELEMENTO = TC1_CODCONEX
--WHERE TC1_IDCOMER <> '604'
;



SELECT CODE, ADDRESS FROM SPARD.TRANSFOR;




--CREATE USER demoimp IDENTIFIED BY demoimp;
CREATE DIRECTORY dir_demoimp_dmp as 'c:/tmp/demo/import/';
--GRANT READ,WRITE ON DIRECTORY dir_demoimp_dmp to BRAE;

DESC DBA_DIRECTORIES;

SELECT * FROM DBA_DIRECTORIES WHERE DIRECTORY_NAME  LIKE '%DEMOIMP%';

    impdp "BRAE"/"Bra968*+-" 
    DIRECTORY="DIR_DEMOIMP_DMP" 
    DUMPFILE=scott.dmp 
    TABLES=scott.emp 
    --REMAP_SCHEMA=scott:admunsen
    ;





SELECT TT2_PERIODO_OP, TT2_CODE_TRAFO,TT2_CODE_IUA FROM QA_TTT2_REPORTE
WHERE TT2_PERIODO_OP>=DATE'2022-01-01'
ORDER BY 1;


SELECT *  FROM QA_TTT11_REGISTRO
WHERE TT11_PERIODO_OP=DATE'2022-10-01';



SELECT * FROM QA_TTT2_REGISTRO;

SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_CODIGOEVENTO='937679';--ABRIRLO


SELECT * FROM QA_TCSU
WHERE CSU_PERIODO_OP=DATE'2022-08-01'
        AND CSU_NIU IN(SELECT TC1_TC1 FROM QA_tTC1
        WHERE TC1_PERIODO = 202208
        AND TC1_CODCONEX='4T01064');

;


SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_CODIGOEVENTO='951024'
AND FDD_IUA ='1006WM0001';--ABRIRLO


SELECT * FROM QA_TFDDREGISTRO --ALZATE
WHERE FDD_CODIGOEVENTO='937679';--ABRIRLO


SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_CODIGOEVENTO='951761'
AND FDD_IUA ='1006Z70001';--PASAR A PRUEBA EN OMS Y ELIMINARLO DE QOS


UPDATE QA_TFDDREGISTRO
SET
FDD_FFINAL =  NULL,
FDD_CONTINUIDAD = 'S',
FDD_FREG_CIERRE = NULL,
FDD_PERIODO_OP = TRUNC(FDD_FINICIAL),
FDD_RECONFIG = 'N'
WHERE FDD_CODIGOEVENTO='951024'
AND FDD_IUA ='1006WM0001';


UPDATE QA_TFDDREGISTRO
SET
FDD_FFINAL =  NULL,
FDD_CONTINUIDAD = 'S',
FDD_FREG_CIERRE = NULL,
FDD_PERIODO_OP = TRUNC(FDD_FINICIAL),
FDD_RECONFIG = 'N'
WHERE FDD_CODIGOEVENTO='937679'
AND FDD_IUA ='100E270001';

COMMIT;


SELECT COUNT(*) FROM QA_TTC1_TEMP;

DELETE FROM QA_TTC1_TEMP;
COMMIT;


DESC QA_TTC1;

UPDATE QA_TTC1_OBS
SET TC1_LATITUD =  NULL
,   TC1_LONGITUD = NULL;
COMMIT;

ALTER TABLE QA_TTC1_OBS
MODIFY TC1_LONGITUD VARCHAR2(15); 

SELECT COUNT(*) FROM QA_TTC1 WHERE TC1_PERIODO=202208;--592.328

SELECT * FROM QA_TTT2_REGISTRO
;

UPDATE QA_TTT2_REGISTRO
SET   TT2_ESTADOREPORTE=1
WHERE TT2_ESTADOREPORTE=0;
COMMIT;

DELETE FROM QA_TTT2_BACKUP;
COMMIT;

INSERT INTO QA_TTT2_BACKUP
SELECT * FROM QA_TTT2_REGISTRO;
COMMIT;


       --V_QA_TTT2_REGISTRO.DELETE;
        WITH INFO_AP AS 
        (SELECT  SUBSTR(CON.NODO_TRANSFORM_V,1,20) AS NODO_TRANSFORM_V,SUM(LUM.POTENCIA) AS POTENCIA_INSTALADA
         FROM CCONECTIVIDAD_E@GTECH CON
         JOIN CCOMUN@GTECH COM ON CON.G3E_FID=COM.G3E_FID
         JOIN ELUMINAR_AT@GTECH LUM ON  LUM.G3E_FID = CON.G3E_FID
         WHERE CON.G3E_FNO = 21400
         GROUP BY CON.NODO_TRANSFORM_V)
            
        SELECT SUBSTR(CON.NODO_TRANSFORM_V,1,20)          AS TT2_CODIGOELEMENTO
            ,CON.CAPACIDAD_NOMINAL             AS TT2_CAPACIDAD_TRAFO
            ,ET.TIPO_SUBESTACION               AS TT2_TSUBESTACION
            ,COM.COOR_Z                        AS TT2_ALTITUD
            ,DECODE(CPRO.PROPIETARIO_1,'ESTADO',1,0)      AS TT2_RPP
            ,CON.TENSION                                  AS TT2_NT_PRIMARIA
            ,CON.TENSION_SECUNDARIA                       AS TT2_NT_SECUNDARIA
       -- BULK COLLECT INTO   V_QA_TTT2_REGISTRO
        FROM                CCONECTIVIDAD_E@GTECH  CON
            LEFT OUTER JOIN CCOMUN@GTECH           COM  ON  COM.G3E_FID            = CON.G3E_FID
            LEFT OUTER JOIN ETRANSFO_AT@GTECH      ET   ON  ET.G3E_FID             = COM.G3E_FID
            LEFT OUTER JOIN CPROPIETARIO@GTECH     CPRO ON  CPRO.G3E_FID           = CON.G3E_FID
            LEFT OUTER JOIN QA_TTT1_REGISTRO       TT1  ON  TT1.TT1_NOMBRECIRCUITO = CON.CIRCUITO
            LEFT OUTER JOIN INFO_AP                AP   ON AP.NODO_TRANSFORM_V     = SUBSTR(CON.NODO_TRANSFORM_V,1,20)
        WHERE               COM.G3E_FNO = 20400
        AND                 COM.ESTADO <> 'CONSTRUCCION'
        ;

DESC QA_TTT2_TEMP;




SELECT TO_NUMBER(NULL) FROM DUAL;


        WITH INFO_AP AS 
        (SELECT  SUBSTR(CON.NODO_TRANSFORM_V,1,20) AS NODO_TRANSFORM_V,SUM(LUM.POTENCIA) AS POTENCIA_INSTALADA
         FROM CCONECTIVIDAD_E@GTECH CON
         JOIN CCOMUN@GTECH COM ON CON.G3E_FID=COM.G3E_FID
         JOIN ELUMINAR_AT@GTECH LUM ON  LUM.G3E_FID = CON.G3E_FID
         WHERE CON.G3E_FNO = 21400
         GROUP BY CON.NODO_TRANSFORM_V)
            
        SELECT SUBSTR(CON.NODO_TRANSFORM_V,1,20)          AS TT2_CODIGOELEMENTO
            ,NULL                                         AS TT2_CODE_IUA --GESTIONADO POR PROCEDIMIENTO
            ,SUBSTR(COM.GRUPO_CALIDAD,1,2)                AS TT2_GRUPOCALIDAD
            ,SUBSTR(COM.ID_MERCADO,1,20)                  AS TT2_IDMERCADO
            ,TO_NUMBER(CON.CAPACIDAD_NOMINAL)             AS TT2_CAPACIDAD_TRAFO
            ,SUBSTR(CPRO.PROPIETARIO_1,1,20)              AS TT2_PROPIEDAD
            ,TO_NUMBER(ET.TIPO_SUBESTACION)               AS TT2_TSUBESTACION
            ,REPLACE(TRIM(COM.COOR_GPS_LON),',','.')      AS TT2_LONGITUD
            ,REPLACE(TRIM(COM.COOR_GPS_LAT),',','.')      AS TT2_LATITUD
            ,TO_NUMBER(COM.COOR_Z)                        AS TT2_ALTITUD
            ,COM.ESTADO                                   AS TT2_ESTADO
            ,(CASE WHEN(ET.PROVISIONAL = 'SI') 
                   THEN('PLANEACION'         ) 
                   ELSE(COM.ESTADO           ) 
              END)                                        AS TT2_ESTADO_BRA11
            ,'CREG 015'                                   AS TT2_RESMETODOLOGIA
            ,NULL                                         AS TT2_CLASS_CARGA --GESTIONADO POR PROCEDIMIENTO
            ,SUBSTR(CON.CIRCUITO,1,20)                    AS TT2_NOMBRE_CIRCUITO
            ,SUBSTR(TT1.TT1_CODIGOCIRCUITO,1,5)           AS TT2_IUL
            ,NULL                                         AS TT2_CODIGOPROYECTO --INDEFINIDO
            ,NULL                                         AS TT2_UNIDAD_CONSTRUCTIVA
            ,DECODE(CPRO.PROPIETARIO_1,'ESTADO',1,0)      AS TT2_RPP
            ,DECODE(COM.SALINIDAD, 'SI', '1', '2')        AS TT2_SALINIDAD
            ,(CASE WHEN (COM.TIPO_PROYECTO = 'T4')
                   THEN ('T4'                    )
                   ELSE (NULL                    ) 
              END)                                        AS TT2_TIPOINVERSION -- CONFIGURADO POR PROCEDIMIENTO
            ,2                                            AS TT2_REMUNERACION_PENDIENTE 
            ,DECODE
              (DECODE(ET.PROVISIONAL,'SI','PLANEACION',COM.ESTADO)
                       ,'PLANEACION','INVA'
                       ,'OPERACION','BRAEN'
                       ,'RETIRADO','BRAFO'
               )                                          AS TT2_ALTERNATIVA_VALORACION 
            ,NULL                                         AS TT2_ID_PLAN
            ,0                                            AS TT2_CANTIDAD_REPOSICIONES --GESTIONADO POR PROCEDIMIENTO
            ,COM.FECHA_OPERACION                          AS TT2_FESTADO --FECHA MANUAL DE OPERACION DEL ACTIVO
            ,COM.FECHA_COLOCACION                         AS TT2_FCOLOCACION -- FECHA SISTEMA DE CREACION DE ACTIVO
            ,COM.FECHA_MODIFICACION                       AS TT2_FMODIFICACION --FECHA SISTEMA DE MODIFICACION DE ACTIVO
            ,COM.USUARIO_COLOCACION                       AS TT2_USR_COLOCACION --PERS
            ,COM.USUARIO_MODIFICACION                     AS TT2_USR_MODFICACION
            ,DATE'2022-09-01'                             AS TT2_PERIODO_OP
            ,0                                            AS TT2_ESTADOREPORTE
            ,SYSDATE                                      AS TT2_FSISTEMA
            ,0                                            AS TT2_ACTIVOCONEXION --PENDIENTE TRAER DEL SISTEMA GTECH
            ,(CASE WHEN ET.PROVISIONAL='SI'
                   THEN 1 
                   ELSE 0 
              END)                                        AS TT2_ACTIVOPROVISIONAL --PENDIENTE TRAER DEL SISTEMA
            ,NVL(AP.POTENCIA_INSTALADA,0)                 AS TT2_AP_POTENCIA
            ,0                                            AS TT2_CODE_CALP
            ,CON.FASES                                    AS TT2_FASES
            ,COM.CLASIFICACION_MERCADO                    AS TT2_POBLACION
            ,NULL                                         AS TT2_VALOR_UC
            ,NULL                                         AS TT2_OBSERVACIONES
            ,CON.LOCALIZACION                             AS TT2_LOCALIZACION
            ,COM.MUNICIPIO                                AS TT2_DEPARTAMENTO
            ,COM.DEPARTAMENTO                             AS TT2_MINICIPIO
            --,TO_NUMBER(CON.TENSION)                       AS TT2_NT_PRIMARIA
            --,TO_NUMBER(CON.TENSION_SECUNDARIA)            AS TT2_NT_SECUNDARIA
        FROM                CCONECTIVIDAD_E@GTECH  CON
            LEFT OUTER JOIN CCOMUN@GTECH           COM  ON  COM.G3E_FID            = CON.G3E_FID
            LEFT OUTER JOIN ETRANSFO_AT@GTECH      ET   ON  ET.G3E_FID             = COM.G3E_FID
            LEFT OUTER JOIN CPROPIETARIO@GTECH     CPRO ON  CPRO.G3E_FID           = CON.G3E_FID
            LEFT OUTER JOIN QA_TTT1_REGISTRO       TT1  ON  TT1.TT1_NOMBRECIRCUITO = CON.CIRCUITO
            LEFT OUTER JOIN INFO_AP                AP   ON AP.NODO_TRANSFORM_V     = SUBSTR(CON.NODO_TRANSFORM_V,1,20)
        WHERE               COM.G3E_FNO = 20400
        AND                 COM.ESTADO <> 'CONSTRUCCION'
        ;


SELECT * FROM QA_tTT2_REGISTRO WHERE TT2_PERIODO_OP=DATE'2022-09-01' AND TT2_TIPOINVERSION IN (1,3);--EXISTENCIA DE DOBLE REPOSCION

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_IUA = '100JIF0102';--100JIF0102


DELETE FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_IUA = '100JIF0102';--100JIF0102
COMMIT;


SELECT DISTINCT FDR_CODIGOELEMENTO FROM QA_TFDDREPORTE
WHERE FDR_PERIODO_OP=DATE'2022-10-01'
AND FDR_CODIGOEVENTO NOT IN ('NA')
INTERSECT
SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_tTT2_REGISTRO WHERE TT2_PERIODO_OP=DATE'2022-09-01' AND TT2_TIPOINVERSION IN (1,3);--EXISTENCIA DE DOBLE REPOSCION

--35 TRANSFORMADORES AFECTADOS Y EN REPOSICION

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN (
                                SELECT DISTINCT FDR_CODIGOELEMENTO FROM QA_TFDDREPORTE
                                WHERE FDR_PERIODO_OP=DATE'2022-10-01'
                                AND FDR_CODIGOEVENTO NOT IN ('NA')
                                INTERSECT
                                SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_tTT2_REGISTRO WHERE TT2_PERIODO_OP=DATE'2022-09-01' AND TT2_TIPOINVERSION IN (1,3)--EXISTENCIA DE DOBLE REPOSCION
)
AND TT2_CLASS_CARGA = 'NA';

--ELIMINAR LOS NUEVOS DE REPOSICION PARA REALIZARSE DE FORMA MANUAL EN EL PROXIMO TT2 (TT2_OCT_2022)


DELETE FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN (
                                SELECT DISTINCT FDR_CODIGOELEMENTO FROM QA_TFDDREPORTE
                                WHERE FDR_PERIODO_OP=DATE'2022-10-01'
                                AND FDR_CODIGOEVENTO NOT IN ('NA')
                                INTERSECT
                                SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_tTT2_REGISTRO WHERE TT2_PERIODO_OP=DATE'2022-09-01' AND TT2_TIPOINVERSION IN (1,3)--EXISTENCIA DE DOBLE REPOSCION
)
AND TT2_CLASS_CARGA IS NULL;
COMMIT;

--ACTUALIZAR LOS 35


UPDATE QA_TTT2_REGISTRO
SET  TT2_ESTADO = 'OPERACION'
,    TT2_ESTADO_BRA11 = 'OPERACION'
,    TT2_TIPOINVERSION = 2
,    TT2_ALTERNATIVA_VALORACION = 'BRAEN'
,    TT2_PERIODO_OP = TRUNC(TT2_FSISTEMA)
WHERE TT2_CODIGOELEMENTO IN (
                                SELECT DISTINCT FDR_CODIGOELEMENTO FROM QA_TFDDREPORTE
                                WHERE FDR_PERIODO_OP=DATE'2022-10-01'
                                AND FDR_CODIGOEVENTO NOT IN ('NA')
                                INTERSECT
                                SELECT DISTINCT TT2_CODIGOELEMENTO FROM QA_tTT2_REGISTRO WHERE TT2_PERIODO_OP=DATE'2022-09-01' AND TT2_TIPOINVERSION IN (1,3)--EXISTENCIA DE DOBLE REPOSCION
)
AND TT2_CLASS_CARGA = 'NA'
;



COMMIT;

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_PERIODO_OP=DATE'2022-09-01'
AND TT2_TIPOINVERSION IN (1,3);




SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 LIKE 'CALP%'
;
/****************************************************************************************************************/
/***--REALIZACION DEL FORAMTO TC1 SEPTIEMBRE 2022                                                               */
/****************************************************************************************************************/

SELECT * FROM QA_TTC1_TEMP;

EXEC QA_PTC1_REGISTRO_FASE1(DATE'2022-10-01');

EXEC QA_PTC1_REGISTRO_FASE2(DATE'2022-10-01');



SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE'XT%';

DELETE FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE 'XT%';

COMMIT;

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN(
                            SELECT DISTINCT TC1_CODCONEX FROM QA_TTC1_OBS
                            WHERE TC1_PERIODO=202210 
                            AND TC1_CODCONEX NOT IN (
                            'SAC00000'
                            ,'9T99999'
                            ,'6T00068'
                            ,'0TV00000')
);

SELECT * FROM QA_TTC1_OBS
WHERE TC1_PERIODO = 202210;

--TRANSFORMADORES QUE SALIERON
SELECT DISTINCT TC1_CODCONEX FROM QA_TTC1_OBS
WHERE TC1_PERIODO=202210
AND TC1_TC1 IN (
                SELECT DISTINCT TC1_TC1 
                    FROM  QA_TTC1 
                    WHERE     TC1_PERIODO = 202210--MAX_PERIODO_TC1
                        AND   TC1_TC1 NOT LIKE 'CALP%'
                        AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                        AND   TC1_TIPCONEX = 'T'
                        AND   TC1_IDCOMER='604'
                MINUS
                    SELECT DISTINCT TC1_TC1
                    FROM  QA_TTC1_TEMP
                    WHERE     TC1_TC1 NOT LIKE 'CALP%'
                        AND   TC1_CODCONEX NOT LIKE 'ALPM%'
                        AND   TC1_TIPCONEX = 'T'
                        AND   TC1_IDCOMER='604'
                )
;--INVESTIGAR PORQUE SALIERO Y SI LOS USUARIOS SE REASIGNARON EN CASO DE QUE TUVIESEN 


SELECT * FROM QA_TTC1_TEMP;--596134  Filas
SELECT * FROM QA_TTC1 WHERE TC1_PERIODO=202209;--594455  Filas

--INSERTAR EN LA TABLA DE PRODUCION DEL TC1

INSERT INTO QA_TTC1
SELECT *
FROM QA_TTC1_TEMP;

COMMIT;


SELECT COUNT(TC1_PERIODO) FROM QA_TTC1 WHERE TC1_PERIODO=202210;


--LUZ VERDE TANTO REGISTRO COMO AJUSTES
EXEC QA_PFDDPRELIMINAR_AJ(DATE'2022-07-01');

DESC QA_TTC1_TEMP;

SELECT * FROM QA_TTC1 WHERE TC1_LATITUD IS NOT NULL;

UPDATE QA_TTC1
SET TC1_LATITUD = NULL, TC1_LONGITUD=NULL
WHERE TC1_LATITUD IS NOT NULL
OR TC1_LONGITUD IS NOT NULL;

SELECT * FROM QA_TFDDPRELIMINAR_AJ
;

SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_CODIGOEVENTO='951761';

SELECT * FROM QA_TFDDPRELIMINAR_AJ
WHERE FDD_CODIGOEVENTO='951761';--NO SE PUEDE AGREGAR


delete FROM QA_TFDDPRELIMINAR_AJ
WHERE FDD_CODIGOEVENTO='951761';--NO SE PUEDE AGREGAR
commit;

SELECT * FROM QA_TFDDPRELIMINAR_AJ
WHERE FDD_CODIGOEVENTO='951024'
AND FDD_IUA = '1006WM0001';


SELECT * FROM QA_TFDDREPORTE
WHERE FDR_CODIGOEVENTO='937679'
;

SELECT * FROM OMS.INTERUPC
LEFT OUTER JOIN 
WHERE MINICIAL='937679'
;

SELECT * FROM QA_TFDDREGISTRO
WHERE TO_CHAR(FDD_FINICIAL,'DD/MM/YYYY') = '01/10/2022'
AND FDD_CAUSA = '7FO15.';

SELECT * FROM QA_TFDDPRELIMINAR_AJ
WHERE FDD_CODIGOELEMENTO = '3T03691';

SELECT DISTINCT TC1_IDCOMER FROM QA_TTC1_TEMP;

--AJUSTES SOLICITADOS POR EL COMERCIALIZADOR CENS********************************************************************************SEP 2022

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1='474590'
AND TC1_IDCOMER<>'604';



SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1='474590'
AND TC1_IDCOMER<>'604';



DELETE FROM QA_TTC1_TEMP
WHERE TC1_TC1='474590'
AND TC1_IDCOMER<>'604';
COMMIT;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1='155267'
AND TC1_IDCOMER<>'604';



DELETE FROM QA_TTC1_TEMP
WHERE TC1_TC1='155267'
AND TC1_IDCOMER<>'604';

COMMIT;

INSERT INTO QA_TTC1_TEMP
SELECT TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'45298' TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	'FRT46991' TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA 
FROM QA_TTC1_TEMP
WHERE TC1_TC1='596846';

SELECT * FROM QA_TTC1_COMERCIO;
--45298	NEU ENERGY S.A.S E.S.P

INSERT INTO QA_TTC1_TEMP
SELECT TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	'45298' TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	'FRT46977' TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA 
FROM QA_TTC1_TEMP
WHERE TC1_TC1='19829';

COMMIT;

SELECT * FROM QA_TTC1_TEMP;



/****************************************************************************************************************
***************************************EXPORTAR PARA COMERCIALIZADORAS***SEPTIEMBRE**2022********************************
****************************************************************************************************************/


--EXPORTAR PARA CERTIFICACION

SELECT TC1_CODCONEX AS CODIGO_TRANSFORMADOR 
,TC1_TC1 AS "NIU"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "Codigo de Conexión"
,(CASE WHEN(TC1_TIPCONEX='T') THEN(2) ELSE(1) END) AS "Tipo de Conexión"
,TC1_NT AS "Nivel de Tensión del usuario"
,TC1_NTP AS "Nivel de Tensión"
,(TC1_PROPACTIV) AS "% propiedad del Activo"
,(TC1_CONEXRED) AS "Conexión Red"
,(TC1_IDCOMER) AS "ID Comercializador"
,(TC1_IDMERC) AS "ID Mercado"
,(TC1_GC) AS "GRUPO CALIDAD"
,TC1_CODFRONCOM AS "Código Frontera Comercial"
,(TC1_CODCIRC) AS "Código Circuito o Línea"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "CODIGO TRANFORMADOR"
,(TC1_CODDANE) AS "Código DANE NIU"
,(TC1_UBIC) AS "Ubicación"
,TC1_DIREC AS "Direccion"
,(TC1_CONESP) AS "Condiciones Especiales"
,(TC1_CODARESP) AS "TIPO DE AREA ESPECIAL"
,(TC1_TIPARESP) AS "CODIGO DE AREA ESPECIAL"
,(TC1_ESTSECT) AS "Estrato - Sector"
,TC1_ALTITUD AS "Altitud"
,TC1_LONGITUD AS "LONGITUD"
,TC1_LATITUD AS "LATITUD"
,(TC1_AUTOGEN) AS "Autogenerador"
,TC1_EXPENER AS "Exporta Energía"
,TC1_CAPAUTOGENR AS "Capacidad Autogenerador kw"
,TC1_TIPGENR AS "Tipo de Generación"
,TC1_CODFRONEXP AS "Codigo frontera Autogenarador"
,TC1_FENTGEN AS "Fecha Entrada en Operación"
,TC1_CONTRESP AS "Contrato de Respaldo"
,TC1_CAPCONTRESP AS "Capacidad Contrato de Respaldo"
FROM  QA_TTC1_TEMP
LEFT OUTER JOIN (
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='OPERACION'
                    AND TT2_CODIGOELEMENTO NOT IN (
                                                    SELECT DISTINCT TT2_CODIGOELEMENTO
                                                    FROM QA_TTT2_REGISTRO
                                                    WHERE TT2_ESTADO='RETIRADO'
                                                   )
                UNION ALL
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                ) ON TT2_CODIGOELEMENTO = TC1_CODCONEX
WHERE TC1_IDCOMER <> '604'
;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IUA = '100JJT0098';

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODE_IUA='100JJT0098';





DELETE FROM BRAE.QA_TCOMPENSAR
where fecha ='01/11/2021';


COMMIT;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 = '1033408';
--WHERE TC1_CODFRONCOM = 'FRT42616'; 


UPDATE QA_TTC1_TEMP
SET   TC1_CODFRONCOM='FRT42616'
WHERE TC1_TC1 = '1033408';
COMMIT;






SELECT *
FROM BRAE.QA_TCSU 
where CSU_NIU ='656822'
AND CSU_PERIODO_OP ='01/04/2022';


DELETE
FROM BRAE.QA_TTC1 
WHERE TC1_PERIODO = '202207'
AND tc1_tc1 ='656822'
AND TC1_IDCOMER = '2322'
; 
COMMIT;


INSERT INTO QA_TTC1
SELECT
	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,2322	TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,'Frt44617'	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM BRAE.QA_TTC1 
WHERE TC1_PERIODO = '202207'
AND tc1_tc1 ='656822'
AND TC1_IDCOMER = '604'
;
--

DESC QA_TTC1;

COMMIT;

SELECT*
FROM BRAE.QA_TTC1 
WHERE TC1_PERIODO = '202207'
AND tc1_tc1 ='656822';
AND TC1_IDCOMER = '2322';

SELECT * FROM QA_TCSU
WHERE CSU_PERIODO_OP=DATE'2022-08-01'
AND CSU_NIU='656822';


CREATE INDEX "BRAE"."FOR_QA_TCOMPENSAR_1" ON "BRAE"."QA_TCOMPENSAR" ("FECHA", "CLIENTE_ID", "VC") ;

DESC QA_TCOMPENSAR;


SELECT tc1_tc1, tc1_codconex,tc1_idcomer FROM QA_TTC1_TEMP;



SELECT  TC1_TC1
      , TC1_CODCONEX
      , TT2_AP_POTENCIA AS TC1_POTENCIA
      , TC1_IDCOMER
      , TC1_CODDANE 
      , MUND_DESCRIPCION
FROM QA_TTC1
LEFT OUTER JOIN (SELECT TT2_CODIGOELEMENTO
                       ,TT2_AP_POTENCIA
                 FROM QA_TTT2_REGISTRO
                 WHERE TT2_ESTADO='OPERACION') ON TT2_CODIGOELEMENTO =  TC1_CODCONEX
LEFT OUTER JOIN QA_TMUNDANE ON MUND_MUNDANE = SUBSTR(TC1_CODDANE,1,5)                
WHERE TC1_PERIODO=202208
AND TC1_TC1 LIKE 'CALP%';

INSERT INTO QA_TTC1_TEMP
SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1='15304'
AND TC1_IDCOMER=604;

COMMIT;


CREATE INDEX "BRAE"."FOR_QA_TC1_TC1" ON "BRAE"."QA_TTC1" ("TC1_TC1") ;


SELECT * FROM QA_TTC1_TEMP
WHERE UPPER(TC1_CODFRONCOM) = 'FRT46653';

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN (
'277529',
'277529',
'287104',
'287104',
'289048',
'289048',
'307039',
'307039',
'433522',
'433522',
'503638',
'503638',
'522464',
'522464',
'585834',
'585834',
'585836',
'585836',
'673144',
'673144',
'674776',
'674776',
'1046609'
);


SELECT DISTINCT TC1_TC1 FROM QA_TTC1
WHERE TC1_TC1 IN ('407624',
'675264',
'1048739',
'1091552',
'1091560',
'1091561',
'1091562',
'1091563',
'1091564',
'1091891',
'1091895',
'1091896',
'1091897',
'1091898',
'1093860',
'1093865',
'1093866',
'1093871',
'1093872',
'1093876',
'1093878',
'1093981');


SELECT * FROM QA_TTC1
WHERE TC1_TC1 IN ('289048',
'585834',
'585836');


SELECT * FROM QA_TTT2_OBS
WHERE TT2_CODIGOELEMENTO IN('1T08618'
,'1T12267');


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE 'ALPM%';


SELECT * FROM QA_TTC1 WHERE TC1_TC1 IN ('407624'
,'675264');


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_PERIODO IS NULL;


UPDATE QA_TTC1_TEMP 
SET   TC1_CODTRANSF = (SELECT TT2_CODE_IUA FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION' AND TT2_CODIGOELEMENTO=TC1_CODCONEX)
WHERE TC1_PERIODO IS NULL;


COMMIT;


UPDATE QA_TTC1_TEMP 
SET   TC1_CODCIRC = (SELECT TT2_IUL FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION' AND TT2_CODIGOELEMENTO=TC1_CODCONEX)
WHERE TC1_PERIODO IS NULL;



UPDATE QA_TTC1_TEMP 
SET   TC1_GC = (SELECT TT2_GRUPOCALIDAD FROM QA_TTT2_REGISTRO WHERE TT2_ESTADO='OPERACION' AND TT2_CODIGOELEMENTO=TC1_CODCONEX)
WHERE TC1_PERIODO IS NULL;

SELECT * FROM QA_TTT2_REGISTRO;

COMMIT;

UPDATE QA_TTC1_TEMP 
SET   TC1_PERIODO = 202209
WHERE TC1_PERIODO IS NULL;


SELECT DISTINCT TC1_PERIODO FROM QA_TTC1_TEMP;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODFRONCOM='FRT19822'
AND TC1_IDCOMER=2020;



DELETE FROM QA_TTC1_TEMP
WHERE TC1_CODFRONCOM='FRT19822'
AND TC1_IDCOMER=2020;
COMMIT;


SELECT * FROM QA_TTC1 WHERE UPPER(TC1_CODFRONCOM) = 'FRT22832';

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1='478809';


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('426'
,'451857'
,'478809'
,'263987'
,'451860'
);


UPDATE QA_TTC1_TEMP
SET TC1_CONESP = 9
WHERE TC1_TC1 IN ('426'
,'451857'
,'478809'
,'263987'
,'451860'
);

COMMIT;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('426','263987');

UPDATE QA_TTC1_TEMP
SET TC1_ESTSECT=7
WHERE TC1_TC1 IN ('426','263987');

COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 IN ('426','263987')
AND TC1_IDCOMER=2020;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODFRONCOM IN ('FRT05288'
,'FRT05297'
,'FRT12971'
,'FRT13009'
,'FRT13056'
);


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODFRONCOM IN ('FRT05288'
,'FRT05297'
,'FRT12971'
,'FRT13009'
,'FRT13056'
)
AND TC1_IDCOMER=48305;


UPDATE QA_TTC1_TEMP
SET TC1_ESTSECT=8
WHERE TC1_CODFRONCOM IN ('FRT05288'
,'FRT05297'
,'FRT12971'
,'FRT13009'
,'FRT13056'
);

COMMIT;


--ELIMINAR DUPLICADOS....

SELECT TC1_TC1, TC1_IDCOMER, COUNT(TC1_TC1) FROM QA_TTC1_TEMP
HAVING COUNT(TC1_TC1)>1
GROUP BY TC1_TC1, TC1_IDCOMER;

COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IUA IS NULL;


UPDATE QA_TTC1_TEMP
SET TC1_IUA = TC1_CODTRANSF
WHERE TC1_IUA IS NULL;

COMMIT;


UPDATE QA_TTC1_TEMP
SET   TC1_TIPCONEX='T'
WHERE TC1_TIPCONEX<>'P';

SELECT * FROM QA_TTC1_TEMP;
COMMIT;

SELECT COUNT(*) FROM QA_TTC1
WHERE TC1_LONGITUD IS NOT NULL;


SELECT COUNT(*) FROM QA_TTC1
WHERE TC1_LONGITUD IS NOT NULL;

UPDATE QA_TTC1
SET TC1_LATITUD = NULL
WHERE TC1_LATITUD IS NOT NULL;

COMMIT;


DESC QA_TTC1_TEMP

ALTER TABLE QA_TTC1
MODIFY (TC1_LONGITUD           VARCHAR2(15),  
        TC1_LATITUD            VARCHAR2(15));
        
        
        

/*CORREGIR EL CAMPO TC1_CODFRONCOM*/

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER=604
AND TC1_CODFRONCOM<>'OR0001';


UPDATE QA_TTC1--_TEMP 
SET   TC1_CODFRONCOM='OR0001'
WHERE TC1_IDCOMER=604
AND TC1_CODFRONCOM IS NULL
AND TC1_PERIODO=202209;

ROLLBACK;
COMMIT;



SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX LIKE 'ALPM%';


UPDATE QA_TTC1
SET   TC1_CODCIRC = NULL
WHERE TC1_CODCONEX LIKE 'ALPM%'
AND TC1_PERIODO = 202209;
COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TIPCONEX='P';

UPDATE QA_TTC1 T
SET   T.TC1_CODCIRC = (SELECT TC1_CODCIRC FROM QA_TTC1 WHERE TC1_PERIODO=202207 AND TC1_TIPCONEX='P' AND TC1_TC1=T.TC1_TC1)
     ,T.TC1_CODTRANSF = NULL
WHERE T.TC1_TIPCONEX='P'
AND TC1_PERIODO=202209;

COMMIT;

SELECT * FROM QA_TTC1
WHERE TC1_TC1='1046636'
AND TC1_PERIODO=202209
AND TC1_TIPCONEX = 'T';


DELETE FROM QA_TTC1
WHERE TC1_TC1='1046636'
AND TC1_PERIODO=202209
AND TC1_TIPCONEX = 'T';

COMMIT;


UPDATE QA_TTC1_TEMP
SET   TC1_IUA=TC1_CODCIRC
WHERE TC1_TIPCONEX='P';
COMMIT;

UPDATE QA_TTC1
SET   TC1_IUA=TC1_CODCIRC
WHERE TC1_TIPCONEX='P'
AND TC1_PERIODO=202209;
COMMIT;

SELECT * FROM QA_TTC1_TEMP;


    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
    WHERE TT2_ESTADO='OPERACION'
    AND TT2_CODIGOELEMENTO NOT IN (SELECT TT2_CODIGOELEMENTO FROM QA_TTT2_REGISTRO
                                   WHERE TT2_ESTADO='RETIRADO')
UNION
    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
    WHERE TT2_ESTADO='RETIRADO';

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1 LIKE 'CALP%';

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_NOMBRE_CIRCUITO LIKE 'CANO%';

SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_CODIGOELEMENTO = '5T02995';

SELECT * FROM QA_TTT2_OBS WHERE TT2_CODIGOELEMENTO = '5T02995';

EXEC QA_PBRA11_REGISTRO(DATE'2022-09-01');

EXEC QA_PBRA11_REPORTE(DATE'2022-09-01');

SELECT * FROM QA_TBRA11_REPORTE
WHERE BRA11_PERIODO_OP=DATE'2022-09-01';


SELECT * FROM QA_TTT2_OBS;

EXEC QA_PTT2_REGISTRO(DATE'2022-10-01');


SELECT * FROM QA_TTC1_TEMP;



-----ACTUALIZACION TC1

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCIRC='NA'
AND TC1_CODCONEX LIKE 'ALPM0001';

UPDATE QA_TTC1_TEMP
SET   TC1_CODCIRC = NULL
WHERE TC1_CODCIRC='NA'
AND TC1_CODCONEX LIKE 'ALPM0001';

UPDATE QA_TTC1
SET   TC1_CODCIRC = NULL
WHERE TC1_CODCIRC='NA'
AND TC1_CODCONEX LIKE 'ALPM0001'
AND TC1_PERIODO = 202210;

COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_CODCIRC='NA';

UPDATE QA_TTC1_TEMP T
SET   TC1_CODCIRC = (SELECT TC1_CODCIRC FROM QA_TTC1 WHERE TC1_PERIODO = 202209 AND TC1_TC1 = T.TC1_TC1)
WHERE TC1_CODCIRC='NA';

UPDATE QA_TTC1 T
SET   TC1_CODCIRC = (SELECT TC1_CODCIRC FROM QA_TTC1 WHERE TC1_PERIODO = 202209 AND TC1_TC1 = T.TC1_TC1)
WHERE TC1_CODCIRC='NA'
AND TC1_PERIODO=202210;


COMMIT;

SELECT * FROM QA_TTC1_COMERCIO;

ALTER TABLE QA_TTC1_COMERCIO
RENAME TO QA_TTC1_COMERCIALIZADORAS;

SELECT * FROM QA_TTC1_COMERCIALIZADORAS;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TC1='154297';



--INSERT INTO QA_TTC1_TEMP
SELECT 	TC1_TC1
,	TC1_CODCONEX
,	TC1_TIPCONEX
,	TC1_NT
,	TC1_NTP
,	TC1_PROPACTIV
,	TC1_CONEXRED
,	TC1_IDCOMER
,	TC1_IDMERC
,	TC1_GC
,	TC1_CODFRONCOM
,	TC1_CODCIRC
,	TC1_CODTRANSF
,	TC1_CODDANE
,	TC1_UBIC
,	TC1_DIREC
,	TC1_CONESP
,	TC1_CODARESP
,	TC1_TIPARESP
,	TC1_ESTSECT
,	TC1_ALTITUD
,	TC1_LONGITUD
,	TC1_LATITUD
,	TC1_AUTOGEN
,	TC1_EXPENER
,	TC1_CAPAUTOGENR
,	TC1_TIPGENR
,	TC1_CODFRONEXP
,	TC1_FENTGEN
,	TC1_CONTRESP
,	TC1_CAPCONTRESP
,	TC1_PERIODO
,	TC1_IUA
FROM QA_TTC1_TEMP
WHERE TC1_TC1='15304';

COMMIT;



/****************************************************************************************************************
***************************************EXPORTAR PARA COMERCIALIZADORAS***OCTUBRE**2022********************************
****************************************************************************************************************/


--EXPORTAR PARA CERTIFICACION

SELECT TC1_CODCONEX AS CODIGO_TRANSFORMADOR 
,TC1_TC1 AS "NIU"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "Codigo de Conexión"
,(CASE WHEN(TC1_TIPCONEX='T') THEN(2) ELSE(1) END) AS "Tipo de Conexión"
,TC1_NT AS "Nivel de Tensión del usuario"
,TC1_NTP AS "Nivel de Tensión"
,(TC1_PROPACTIV) AS "% propiedad del Activo"
,(TC1_CONEXRED) AS "Conexión Red"
,(TC1_IDCOMER) AS "ID Comercializador"
,(TC1_IDMERC) AS "ID Mercado"
,(TC1_GC) AS "GRUPO CALIDAD"
,TC1_CODFRONCOM AS "Código Frontera Comercial"
,(TC1_CODCIRC) AS "Código Circuito o Línea"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "CODIGO TRANFORMADOR"
,(TC1_CODDANE) AS "Código DANE NIU"
,(TC1_UBIC) AS "Ubicación"
,TC1_DIREC AS "Direccion"
,(TC1_CONESP) AS "Condiciones Especiales"
,(TC1_CODARESP) AS "TIPO DE AREA ESPECIAL"
,(TC1_TIPARESP) AS "CODIGO DE AREA ESPECIAL"
,(TC1_ESTSECT) AS "Estrato - Sector"
,TC1_ALTITUD AS "Altitud"
,TC1_LONGITUD AS "LONGITUD"
,TC1_LATITUD AS "LATITUD"
,(TC1_AUTOGEN) AS "Autogenerador"
,TC1_EXPENER AS "Exporta Energía"
,TC1_CAPAUTOGENR AS "Capacidad Autogenerador kw"
,TC1_TIPGENR AS "Tipo de Generación"
,TC1_CODFRONEXP AS "Codigo frontera Autogenarador"
,TC1_FENTGEN AS "Fecha Entrada en Operación"
,TC1_CONTRESP AS "Contrato de Respaldo"
,TC1_CAPCONTRESP AS "Capacidad Contrato de Respaldo"
FROM  QA_TTC1_TEMP
LEFT OUTER JOIN (
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='OPERACION'
                    AND TT2_CODIGOELEMENTO NOT IN (
                                                    SELECT DISTINCT TT2_CODIGOELEMENTO
                                                    FROM QA_TTT2_REGISTRO
                                                    WHERE TT2_ESTADO='RETIRADO'
                                                   )
                UNION ALL
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                ) ON TT2_CODIGOELEMENTO = TC1_CODCONEX
WHERE TC1_IDCOMER <> '604'
;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_TIPCONEX='P';


UPDATE QA_TTC1_TEMP T
SET TC1_IUA = (SELECT TC1_IUA FROM QA_TTC1 WHERE TC1_PERIODO=202209 AND TC1_TC1 = T.TC1_TC1)
WHERE TC1_TIPCONEX='P';

COMMIT;

SELECT * FROM QA_TTT2_REGISTRO WHERE TT2_CODE_IUA='100JRS009B';



SELECT TO_CHAR(FDD_FINICIAL,'YYYY'),COUNT(*) FROM QA_TFDDREGISTRO
GROUP BY TO_CHAR(FDD_FINICIAL,'YYYY')
;

SELECT DISTINCT FDD_PUBLICADO 
FROM QA_TFDDREGISTRO
WHERE FDD_PERIODO_OP = DATE'2022-11-08'
;


/*
ID DE EJECUCION
FECHA DE EJECUCION
NOMBRE DEL PROCEDIMIENTO
USUARIO QUIEN EJECUTO EL PROCEDIMIENTO
ESTADO DE LA EJECUCION
OBSERVACIONES

*/


SELECT FDD_PERIODO_OP,COUNT(DISTINCT FDD_PUBLICADO) 
FROM QA_TFDDREGISTRO
HAVING COUNT(DISTINCT FDD_PUBLICADO)>1
GROUP BY FDD_PERIODO_OP
ORDER BY FDD_PERIODO_OP
;

SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_PERIODO_OP = DATE'2020-04-01';

SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_PUBLICADO = 'N'
AND FDD_RADICADO <> 'NA';

SELECT * FROM QA_TFDDREGISTRO
WHERE FDD_PUBLICADO = 'N';


UPDATE QA_TFDDREGISTRO
SET   FDD_PUBLICADO = 'S'
WHERE FDD_PUBLICADO = 'N';


COMMIT;




CREATE TABLE QA_TLOG_EJECUCION(
    FECHA_EJECUCION DATE,
    NOMBRE_OBJ VARCHAR2(20),
    TIPO_OBJ VARCHAR2(20),
    USUARIO VARCHAR2(100),
    ESTADO VARCHAR2(20),
    OBSERVACIONES VARCHAR2(200)
);

SELECT*FROM QA_TLOG_EJECUCION;
ROLLBACK;
COMMIT;

DESC QA_TFDDREGISTRO;

CREATE TABLE QA_TCIRCULAR106(
	CODIGOEVENTO	VARCHAR2(10)
,	FINICIAL	DATE
,	FFINAL	DATE
,	CODIGOELEMENTO	VARCHAR2(16)
,	TIPOELEMENTO	VARCHAR2(16)
,	CAUSA_CREG	VARCHAR2(50)
,	CONTINUA	VARCHAR2(2) 
,	EVENTOZNI	NUMBER
,	AFECTAGEN	NUMBER
,	USUARIOAP	NUMBER
,	CARGAID	NUMBER
,	MES	NUMBER
,	ESTADO	NUMBER
,	EXCLUIDA	VARCHAR2(20)
);
SELECT*FROM QA_TCIRCULAR106;
DROP TABLE QA_TCIRCULAR106;

SELECT * FROM QA_TCIRCULAR106;

DELETE FROM QA_TCIRCULAR106
WHERE CODIGOEVENTO IS NULL;

COMMIT;

SELECT CODIGOEVENTO,COUNT(CODIGOEVENTO) 
FROM QA_TCIRCULAR106
HAVING COUNT(CODIGOEVENTO)>=4
GROUP BY CODIGOEVENTO;

SELECT*FROM QA_TCIRCULAR106;

CREATE TABLE QA_TCIR106_USRS(
	LLAVE	VARCHAR2(20)
,	TIPOELEMENTO	VARCHAR2(2)
,	ELEMENTOID	VARCHAR2(20)
,	MES	NUMBER
,	USUARIO_AP	NUMBER
,	USUARIOS	NUMBER
,	NT	NUMBER
,	GRUPO_CALIDAD	NUMBER
,	MERCADO	NUMBER
,	DANE	NUMBER
);

SELECT * FROM QA_TCIR106_USRS;

DROP TABLE QA_TCIR106_USRS;


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER='480';

SELECT * FROM ALL_TABLES
WHERE TABLE_NAME LIKE '%COMER%';


UPDATE QA_TTC1_TEMP
SET TC1_LONGITUD = '-72.487821'
  , TC1_LATITUD = '7.325026'
WHERE TC1_TC1 = '1046636'
AND TC1_IDCOMER = '480'
;

UPDATE QA_TTC1
SET TC1_LONGITUD = '-72.487821'
  , TC1_LATITUD = '7.325026'
WHERE TC1_TC1 = '1046636'
AND TC1_IDCOMER = '480'
AND TC1_PERIODO = 202210
;

COMMIT;
--IDENTIFICAR USUARIO DUPLICADOS.
SELECT TC1_TC1,TC1_IDCOMER,COUNT(TC1_TC1||TC1_IDCOMER) 
FROM QA_TTC1_TEMP
GROUP BY TC1_TC1,TC1_IDCOMER
HAVING COUNT(TC1_TC1||TC1_IDCOMER)>1;

SELECT * FROM QA_TTC1_TEMP;

SELECT * FROM QA_TTC1
WHERE TC1_PERIODO=202210;


SELECT DISTINCT TC1_TC1 
FROM QA_TTC1_TEMP
GROUP BY TC1_TC1,TC1_IDCOMER
HAVING COUNT(TC1_TC1||TC1_IDCOMER)>1;


DELETE FROM QA_TTC1_TEMP
WHERE TC1_CODCONEX IS NULL;

COMMIT;


SELECT * FROM   (SELECT circuito, iua, iul, cod_unidad_constructiva, salinidad, tipo_inversion, ano_entrada_salida_operacion, estado
                    FROM ac_tbra11_base
                UNION
                SELECT circuito, iua, iul, cod_unidad_constructiva, salinidad, tipo_inversion, ano_entrada_salida_operacion, estado
                    FROM ac_tbra11_brafo
                )
WHERE circuito = '5T01293'
ORDER BY circuito, ano_entrada_salida_operacion DESC
; 

SELECT * FROM QA_TTT2_REPORTE
WHERE TT2_CODE_TRAFO='5T01293'
ORDER BY TT2_PERIODO_OP;


SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA,TT2_IUL,TT2_UNIDAD_CONSTRUCTIVA,TT2_TIPOINVERSION,TT2_ESTADO_BRA11, TT2_FESTADO FROM QA_TTT2_REGISTRO 
WHERE TT2_CODIGOELEMENTO='5T01293'
UNION ALL
SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA,TT2_IUL,TT2_UNIDAD_CONSTRUCTIVA,TT2_TIPOINVERSION,TT2_ESTADO_BRA11, TT2_FESTADO FROM QA_TTT2_BRAFO
WHERE TT2_CODIGOELEMENTO='5T01293';

SELECT * FROM QA_TTT2_REGISTRO;

SELECT * FROM QA_TTC1_TEMP;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER
;

select tc1_tc1, tc1_codconex, tc1_idcomer from QA_TTC1_TEMP
where TC1_IDCOMER = '604';


SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER='604';

UPDATE QA_TTC1_TEMP
SET TC1_CODFRONCOM = 'OR0001'
WHERE TC1_IDCOMER='604';

COMMIT;

UPDATE QA_TTC1
SET TC1_CODFRONCOM = 'OR0001'
WHERE TC1_IDCOMER = '604'
AND TC1_PERIODO = 202210
AND TC1_CODFRONCOM <> 'OR0001';

COMMIT;

SELECT * FROM QA_TTC1_TEMP
WHERE TC1_IDCOMER <> '604';



/****************************************************************************************************************
***************************************EXPORTAR PARA CERTIFICACION***OCTUBRE**2022********************************
****************************************************************************************************************/


--EXPORTAR PARA CERTIFICACION

SELECT TC1_CODCONEX AS CODIGO_TRANSFORMADOR 
,TC1_TC1 AS "NIU"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA) 
  END) AS "Codigo de Conexión"
,(CASE WHEN(TC1_TIPCONEX='T') THEN(2) ELSE(1) END) AS "Tipo de Conexión"
,TC1_NT AS "Nivel de Tensión del usuario"
,TC1_NTP AS "Nivel de Tensión"
,(TC1_PROPACTIV) AS "% propiedad del Activo"
,(TC1_CONEXRED) AS "Conexión Red"
,(TC1_IDCOMER) AS "ID Comercializador"
,(TC1_IDMERC) AS "ID Mercado"
,(TC1_GC) AS "GRUPO CALIDAD"
,TC1_CODFRONCOM AS "Código Frontera Comercial"
,(TC1_CODCIRC) AS "Código Circuito o Línea"
,(CASE WHEN(TC1_TIPCONEX='T' AND TC1_CODCONEX NOT LIKE 'ALPM%') 
       THEN(TT2_CODE_IUA) 
       ELSE(TC1_IUA)---arreglarlo
  END) AS "CODIGO TRANFORMADOR"
,(TC1_CODDANE) AS "Código DANE NIU"
,(TC1_UBIC) AS "Ubicación"
,TC1_DIREC AS "Direccion"
,(TC1_CONESP) AS "Condiciones Especiales"
,(TC1_CODARESP) AS "TIPO DE AREA ESPECIAL"
,(TC1_TIPARESP) AS "CODIGO DE AREA ESPECIAL"
,(TC1_ESTSECT) AS "Estrato - Sector"
,TC1_ALTITUD AS "Altitud"
,TC1_LONGITUD AS "LONGITUD"
,TC1_LATITUD AS "LATITUD"
,(TC1_AUTOGEN) AS "Autogenerador"
,TC1_EXPENER AS "Exporta Energía"
,TC1_CAPAUTOGENR AS "Capacidad Autogenerador kw"
,TC1_TIPGENR AS "Tipo de Generación"
,TC1_CODFRONEXP AS "Codigo frontera Autogenarador"
,TC1_FENTGEN AS "Fecha Entrada en Operación"
,TC1_CONTRESP AS "Contrato de Respaldo"
,TC1_CAPCONTRESP AS "Capacidad Contrato de Respaldo"
FROM  QA_TTC1_TEMP
LEFT OUTER JOIN (
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='OPERACION'
                    AND TT2_CODIGOELEMENTO NOT IN (
                                                    SELECT DISTINCT TT2_CODIGOELEMENTO
                                                    FROM QA_TTT2_REGISTRO
                                                    WHERE TT2_ESTADO='RETIRADO'
                                                   )
                UNION ALL
                    SELECT TT2_CODIGOELEMENTO,TT2_CODE_IUA FROM QA_TTT2_REGISTRO
                    WHERE TT2_ESTADO='RETIRADO'
                ) ON TT2_CODIGOELEMENTO = TC1_CODCONEX
WHERE TC1_IDCOMER <> '604'
;


SELECT DISTINCT TC1_TC1, TC1_CODCONEX FROM QA_TTC1 
WHERE TC1_TC1 IN ('113911'	,'113912'	,'113913'	,'113914'	,'407624'	,'479711'	,'479712'	,'675264'	,'1064078'	,'1079599'	,'1086308'	,'1087754'	,'1091054'	,'1091552'	,'1091560'	,'1091561'	,'1091562'	,'1091563'	,'1091564'	,'1091804'	,'1091891'	,'1091895'	,'1091896'	,'1091897'	,'1091898'	,'1093860'	,'1093865'	,'1093866'	,'1093871'	,'1093872'	,'1093876'	,'1093878'	,'1095265')
AND SUBSTR(TC1_PERIODO,1,4) = 2022
;


SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO IN ('1T07689',	'1T00822',	'1T00824',	'1T10551',	'1T01285',	'1T00290',	'1T00290',	'3T00194',	'1T10894',	'1T00429',	'1T11541',	'1T11346',	'3T00054',	'1T11243',	'1T11243',	'1T11243',	'1T11243',	'1T11243',	'1T11243',	'1T11418',	'1T11418',	'1T11418',	'1T11418',	'1T11418',	'1T11418',	'1T03220',	'4T01390',	'1T11451',	'4T01390',	'4T01394',	'4T01394',	'4T01394',	'1T11418');

SELECT * FROM QA_TTT2_REGISTRO
WHERE TT2_CODIGOELEMENTO = '1T03280';






SELECT * FROM QA_TTC1 
WHERE TC1_TC1 IN ('113911'	,'113912'	,'113913'	,'113914'	,'407624'	,'479711'	,'479712'	,'675264'	,'1064078'	,'1079599'	,'1086308'	,'1087754'	,'1091054'	,'1091552'	,'1091560'	,'1091561'	,'1091562'	,'1091563'	,'1091564'	,'1091804'	,'1091891'	,'1091895'	,'1091896'	,'1091897'	,'1091898'	,'1093860'	,'1093865'	,'1093866'	,'1093871'	,'1093872'	,'1093876'	,'1093878'	,'1095265')
AND SUBSTR(TC1_PERIODO,1,4) = 2022
;


select distinct TT12_ID from QA_TTT12_REPORTE
where TT12_PERIODO_OP = date'2022-10-01'
and TT12_DURACION <> 0;


desc qa_ttc1_temp;